<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>阅读 On Lisp</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Nisen" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
<p class="date">Published: 2018-01-13</p>
</div>
<div id="content">
<h1 class="title">阅读 On Lisp</h1>
<div class="abstract">
<p>
<a href="http://www.paulgraham.com/onlisp.html">On Lisp</a> 是一本讲解lisp宏使用技巧的书，之前囫囵吞枣翻阅过，最近拿起来从头开始拜读。故在此记录一些学到的知识，本文会随着学习的进度而更新。
</p>

</div>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org21922a9">1. symbol-value 和 symbol-function</a></li>
<li><a href="#orgcaab0ce">2. apply 和 funcall</a></li>
<li><a href="#org970efdf">3. 模拟面向对象中的"方法"(method)</a></li>
<li><a href="#org01031f5">4. 尾递归优化</a></li>
<li><a href="#org4dfec48">5. 编译</a></li>
<li><a href="#orgaedf072">6. 迷思: 使用一堆新操作符(实用工具/utils)让程序难读懂？</a></li>
<li><a href="#org1487038">7. 语言正交性</a></li>
<li><a href="#org148609f">8. 缓存函数和复合函数(函数as参数和返回值)</a></li>
<li><a href="#org06982e4">9. 闭包与数据结构</a></li>
<li><a href="#orge119bb3">10. 使用宏还是函数</a>
<ul>
<li><a href="#orgcb02084">10.1. 当别无他法时</a></li>
</ul>
</li>
<li><a href="#org79f8ed9">11. 宏与于函数优缺点</a>
<ul>
<li><a href="#org86f96d1">11.1. 宏优点</a></li>
<li><a href="#org5ee183e">11.2. 函数优点</a></li>
</ul>
</li>
<li><a href="#org9bb2f51">12. 宏陷阱</a>
<ul>
<li><a href="#orgaa61ecb">12.1. 变量捕捉</a></li>
<li><a href="#orgbfad30d">12.2. 求值次数</a></li>
<li><a href="#orgc110bc2">12.3. 求值顺序</a></li>
<li><a href="#org74dd179">12.4. 非函数式的展开器</a></li>
<li><a href="#org5f2af33">12.5. 递归</a></li>
</ul>
</li>
<li><a href="#org337aad6">13. 常用宏</a>
<ul>
<li><a href="#org245ef1e">13.1. 创建上下文</a></li>
<li><a href="#orgf7d34db">13.2. with- 宏</a></li>
<li><a href="#orgec2a9c3">13.3. 条件求值</a></li>
<li><a href="#orgdd1ad33">13.4. 迭代</a></li>
<li><a href="#orgcc581ce">13.5. 多值迭代</a></li>
<li><a href="#org87d6242">13.6. 为什么需要宏</a></li>
</ul>
</li>
<li><a href="#orga8a97d2">14. 广义变量</a>
<ul>
<li><a href="#org63e0dce">14.1. 定义和作用</a></li>
<li><a href="#org70d9a08">14.2. 宏 define-modify-macro</a></li>
<li><a href="#org82100a6">14.3. 实用工具（一）</a></li>
<li><a href="#org1db2a08">14.4. 宏 get-setf-expansion</a></li>
<li><a href="#org0eb1430">14.5. 实用工具（二）</a></li>
<li><a href="#orgc429834">14.6. 宏 defsetf</a></li>
</ul>
</li>
<li><a href="#orgb7d1fee">15. 编译期计算</a>
<ul>
<li><a href="#org2f0aad9">15.1. 将参数个数计算移到编译器</a></li>
<li><a href="#org88a3687">15.2. 部分参数求值</a></li>
<li><a href="#org6142e5e">15.3. 编译时期只知道部分参数值</a></li>
<li><a href="#orgdf01476">15.4. 何时采用编译器计算宏</a></li>
</ul>
</li>
<li><a href="#orgcf9dd9b">16. 指代宏</a>
<ul>
<li><a href="#org0ae7742">16.1. <code>aif</code></a></li>
<li><a href="#org4cece42">16.2. <code>awhen</code></a></li>
<li><a href="#org0a85994">16.3. <code>awhile</code></a></li>
<li><a href="#orgad1862c">16.4. <code>aand</code></a></li>
<li><a href="#org39227d5">16.5. <code>acond</code></a></li>
<li><a href="#org6656eca">16.6. <code>alambda</code></a></li>
<li><a href="#orge604fd4">16.7. <code>ablock</code></a></li>
<li><a href="#org52b4d15">16.8. 注意</a></li>
<li><a href="#org921b10c">16.9. 多值指代版</a></li>
</ul>
</li>
<li><a href="#org0a827d9">17. 生成函数的宏</a>
<ul>
<li><a href="#orgfb6ae51">17.1. 构造函数的宏fn</a></li>
<li><a href="#org30a9540">17.2. 在cdr上递归</a></li>
</ul>
</li>
<li><a href="#org6ab9efd">18. END</a></li>
</ul>
</div>
</div>

<div id="outline-container-org21922a9" class="outline-2">
<h2 id="org21922a9"><span class="section-number-2">1</span> symbol-value 和 symbol-function</h2>
<div class="outline-text-2" id="text-1">
<p>
common lisp is a lisp-2 language, funtion and variable have different name space,
所以一个symbol可以同时是一个function和variable
用 <code>symbol-value</code> 获取变量值
用 <code>symbol-function</code> 获取函数值
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;;</span><span style="color: #7f7f7f;">&#20551;&#35774;&#26377;&#20010;double1&#30340;symbol:</span>

<span style="color: #7f7f7f;">;;</span><span style="color: #7f7f7f;">&#35774;&#32622;&#35813;symbol&#30340;value</span>
<span style="color: #8c8c8c;">(</span>setq double1 4<span style="color: #8c8c8c;">)</span>
or
<span style="color: #8c8c8c;">(</span>setf <span style="color: #93a8c6;">(</span>symbol-value 'double1<span style="color: #93a8c6;">)</span> 5<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;;</span><span style="color: #7f7f7f;">&#35774;&#32622;&#35813;symbol&#30340;function</span>
<span style="color: #8c8c8c;">(</span>setf <span style="color: #93a8c6;">(</span>symbol-function 'double1<span style="color: #93a8c6;">)</span> #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span>x<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>* x 2<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">#'foo &#26159; (function foo)&#30340;&#32553;&#20889;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21487;&#20197;&#29702;&#35299;&#20026;&#23558;&#21517;&#23383;&#26144;&#23556;&#21040;&#23454;&#38469;&#30340;&#20989;&#25968;&#23545;&#35937;</span>
#'double1 &#36820;&#22238;&#30340;&#26159;&#19978;&#38754;&#23450;&#20041;&#30340;&#20989;&#25968;&#23545;&#35937;

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">lambda &#34920;&#36798;&#24335;&#21487;&#20197;&#21516;&#26102;&#26159;&#20989;&#25968;&#21644;&#20989;&#25968;&#21517;&#23383;</span>
#'<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #93a8c6;">(</span>x<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>* x 2<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span> &#36820;&#22238;&#30340;&#20063;&#26159;&#20989;&#25968;&#23545;&#35937;



<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#25152;&#20197; defun &#31561;&#20215;&#20110;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">double1</span> <span style="color: #93a8c6;">(</span>x<span style="color: #93a8c6;">)</span>
    <span style="color: #93a8c6;">(</span>* x 2<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span>setf <span style="color: #93a8c6;">(</span>symbol-function 'double1<span style="color: #93a8c6;">)</span>
    <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span>x<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>* x 2<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
or
<span style="color: #8c8c8c;">(</span>setf <span style="color: #93a8c6;">(</span>symbol-function 'double1<span style="color: #93a8c6;">)</span>
    #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span>x<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>* x 2<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>



<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20877;&#26469;&#30475;&#19968;&#20010;&#38381;&#21253;&#30340;&#20363;&#23376;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">make-adder</span> <span style="color: #93a8c6;">(</span>n<span style="color: #93a8c6;">)</span>
   #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span>x<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>+ x n<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span>setf add2 <span style="color: #93a8c6;">(</span>make-adder 2<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#35843;&#29992;add2 &#30340;&#32467;&#26524;</span>
<span style="color: #8c8c8c;">(</span>add2 4<span style="color: #8c8c8c;">)</span>
=&gt;
The function COMMON-LISP-USER::ADDER2 is undefined.
   [Condition of type UNDEFINED-FUNCTION]

Restarts:
 0: [CONTINUE] Retry using ADDER2.
 1: [USE-VALUE] Use specified function
 2: [RETRY] Retry SLIME REPL evaluation request.
 3: [*ABORT] Return to SLIME's top level.
 4: [ABORT] abort thread <span style="color: #8c8c8c;">(</span>#&lt;THREAD <span style="color: #deb887;">"new-repl-thread"</span> RUNNING {10052AAAF3}&gt;<span style="color: #8c8c8c;">)</span>

Backtrace:
  0: <span style="color: #8c8c8c;">(</span>SYMBOL-FUNCTION ADDER2<span style="color: #8c8c8c;">)</span>   &lt;---&#27880;&#24847;&#36825;&#37324;
  1: <span style="color: #8c8c8c;">(</span>SB-INT:SIMPLE-EVAL-IN-LEXENV <span style="color: #93a8c6;">(</span>ADDER2 4<span style="color: #93a8c6;">)</span> #&lt;NULL-LEXENV&gt;<span style="color: #8c8c8c;">)</span>
  2: <span style="color: #8c8c8c;">(</span>EVAL <span style="color: #93a8c6;">(</span>ADDER2 4<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22240;&#20026;setf &#26159;&#35774;&#32622; symbol add2 &#30340; symbol-value</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#24403;(add2 4)&#36825;&#26679;&#35843;&#29992;&#30340;&#26102;&#20505;&#22238;&#21435;&#25214; 'add2 &#30340;symbol-function, &#25152;&#20197;&#25214;&#19981;&#21040;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#25152;&#20197;&#27491;&#30830;&#30340;&#35843;&#29992;&#26041;&#24335;&#22914;&#19979;</span>
<span style="color: #8c8c8c;">(</span>funcall add2 4<span style="color: #8c8c8c;">)</span>
or
<span style="color: #8c8c8c;">(</span>funcall <span style="color: #93a8c6;">(</span>symbol-value 'add2<span style="color: #93a8c6;">)</span> 4<span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-orgcaab0ce" class="outline-2">
<h2 id="orgcaab0ce"><span class="section-number-2">2</span> apply 和 funcall</h2>
<div class="outline-text-2" id="text-2">
<p>
作用都是对函数求值，区别在于
apply 接受的函数将被作用到一个列表，该列表由余下的参数cons到最后一个产生，所以最后一个参数一定要是一个列表
</p>

<p>
如果不方便以列表形式提供参数，则使用funcall
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span>apply #'+ '<span style="color: #93a8c6;">(</span>1 2<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>apply #'+ 1 '<span style="color: #93a8c6;">(</span>2<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span>funcall #'+ 1 2<span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org970efdf" class="outline-2">
<h2 id="org970efdf"><span class="section-number-2">3</span> 模拟面向对象中的"方法"(method)</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#26681;&#25454;&#21160;&#29289;&#19981;&#21516;&#31181;&#31867;&#20570;&#19981;&#21516;&#20107;&#24773;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">behave</span> <span style="color: #93a8c6;">(</span>animal<span style="color: #93a8c6;">)</span>
   <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">case</span> animal
     <span style="color: #b0b1a3;">(</span>dog <span style="color: #97b098;">(</span>wag-tail<span style="color: #97b098;">)</span>
          <span style="color: #97b098;">(</span>bark<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     <span style="color: #b0b1a3;">(</span>rat <span style="color: #97b098;">(</span>scurry<span style="color: #97b098;">)</span>
          <span style="color: #97b098;">(</span>squeak<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     <span style="color: #b0b1a3;">(</span>cat <span style="color: #97b098;">(</span>rub-legs<span style="color: #97b098;">)</span>
          <span style="color: #97b098;">(</span>scratch-carpet<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#24403;&#38656;&#35201;&#28155;&#21152;&#19968;&#30452;&#21160;&#29289;&#26102;&#65292;&#23601;&#24471;&#20462;&#25913;&#19978;&#36848;&#20195;&#30721;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20026;&#20102;&#26356;&#22909;&#30340;&#25193;&#23637;&#24615;&#65292;&#21487;&#20197;&#22914;&#19979;&#20570;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">dehave</span> <span style="color: #93a8c6;">(</span>animal<span style="color: #93a8c6;">)</span>
   <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>get animal 'behavior<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span>setf <span style="color: #93a8c6;">(</span>get 'dog 'behavior<span style="color: #93a8c6;">)</span>
    #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">()</span> <span style="color: #b0b1a3;">(</span>wag-tail<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>bark<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>

...

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#26679;&#31867;&#20284;&#20110;&#38754;&#21521;&#23545;&#35937;&#37324;&#38754;&#30340;&#26041;&#27861;</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org01031f5" class="outline-2">
<h2 id="org01031f5"><span class="section-number-2">4</span> 尾递归优化</h2>
<div class="outline-text-2" id="text-4">
<p>
许多common lisp编译器可以把尾递归转化成循环，如果使用这种编译器，可以在源代码里写优雅的递归而不必担心函数调用在运行期产生的系统开销
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#19979;&#21015;&#20989;&#25968;&#19981;&#26159;&#19968;&#20010;&#23614;&#36882;&#24402;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-length</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
    <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null lst<span style="color: #b0b1a3;">)</span>
        0
        <span style="color: #b0b1a3;">(</span>1+ <span style="color: #97b098;">(</span>our-length <span style="color: #aebed8;">(</span>cdr lst<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36890;&#24120;&#19981;&#26159;&#23614;&#36882;&#24402;&#30340;&#20989;&#25968;&#21487;&#20197;&#20351;&#29992;&#19968;&#20010;&#32047;&#31215;&#22120;(accumulator)&#30340;&#23616;&#37096;&#20989;&#25968;&#23884;&#20837;&#21040;&#20854;&#20013;&#65292;&#20174;&#32780;&#36716;&#21270;&#25104;&#19968;&#20010;&#23614;&#36882;&#24402;&#24418;&#24335;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-length</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
   <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>rec <span style="color: #aebed8;">(</span>lst acc<span style="color: #aebed8;">)</span>
              <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b0b3;">(</span>null lst<span style="color: #b0b0b3;">)</span>
                  acc
                  <span style="color: #b0b0b3;">(</span>rec <span style="color: #90a890;">(</span>cdr lst<span style="color: #90a890;">)</span> <span style="color: #90a890;">(</span>1+ acc<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     <span style="color: #b0b1a3;">(</span>rec lst 0<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36890;&#36807;&#22312;&#35843;&#29992;&#26641;&#20174;&#19978;&#24448;&#19979;&#36208;&#30340;&#36807;&#31243;&#20013;&#32047;&#35745;&#36825;&#20010;&#20540;&#65292;&#32780;&#19981;&#26159;&#20174;&#19979;&#24448;&#19978;&#36820;&#22238;&#30340;&#26102;&#20505;&#20877;&#35745;&#31639;</span>

</pre>
</div>

<p>
另外许多编译器虽然能做尾递归优化，但这不是所有编译器的默认行为，所以在编写尾递归函数时，应该把 <code>(proclaim '(optimize speed))</code> 写在文件前面， 以确保编译器进行优化
</p>



<p>
下面是一个递归-&gt;尾递归-&gt;迭代的示例:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;;; </span><span style="color: #7f7f7f;">filter&#20989;&#25968;&#30340;&#20316;&#29992;&#26159;&#32473;&#30340;&#19968;&#20010;&#20989;&#25968;fn,&#19968;&#20010;&#21015;&#34920;lst, &#23558;fn&#20316;&#29992;&#22312;lst&#20013;&#30340;&#27599;&#20010;&#20803;&#32032;&#65292;&#22914;&#26524;&#32467;&#26524;&#19981;&#20026;nil,&#21017;&#23558;&#20540;&#25910;&#38598;&#21040;&#19968;&#20010;&#21015;&#34920;&#20013;&#36820;&#22238;</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#31532;&#19968;&#29256;&#23450;&#20041;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">filter</span> <span style="color: #93a8c6;">(</span>fn lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>rec <span style="color: #aebed8;">(</span>lst<span style="color: #aebed8;">)</span>
             <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b0b3;">(</span>null lst<span style="color: #b0b0b3;">)</span>
                 nil
                 <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #90a890;">(</span><span style="color: #a2b6da;">(</span>val <span style="color: #9cb6ad;">(</span>funcall fn <span style="color: #8c8c8c;">(</span>car lst<span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                   <span style="color: #90a890;">(</span><span style="color: #00bfff;">if</span> val
                       <span style="color: #a2b6da;">(</span>cons val <span style="color: #9cb6ad;">(</span>rec <span style="color: #8c8c8c;">(</span>cdr lst<span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span>
                       <span style="color: #a2b6da;">(</span>rec <span style="color: #9cb6ad;">(</span>cdr lst<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span>rec lst<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21487;&#20197;&#30475;&#20986;&#35813;&#20989;&#25968;&#37319;&#29992;&#36882;&#24402;&#26041;&#24335;&#65292;&#23558;fn&#20998;&#21035;&#20316;&#29992;&#22312;(car lst)&#21644;&#65288;cdr lst&#65289;&#19978;&#65292;&#20877;&#26681;&#25454;&#32467;&#26524;&#36873;&#25321;&#26159;&#21542;cons&#36215;&#26469;</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#31532;&#20108;&#29256;&#23450;&#20041;: &#23614;&#36882;&#24402;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">filter</span> <span style="color: #93a8c6;">(</span>fn lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>rec <span style="color: #aebed8;">(</span>lst acc<span style="color: #aebed8;">)</span>
             <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b0b3;">(</span>null lst<span style="color: #b0b0b3;">)</span>
                 acc
                 <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #90a890;">(</span><span style="color: #a2b6da;">(</span>val <span style="color: #9cb6ad;">(</span>funcall fn <span style="color: #8c8c8c;">(</span>car lst<span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                   <span style="color: #90a890;">(</span><span style="color: #00bfff;">if</span> val
                       <span style="color: #a2b6da;">(</span>rec <span style="color: #9cb6ad;">(</span>cdr lst<span style="color: #9cb6ad;">)</span> <span style="color: #9cb6ad;">(</span>cons val acc<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span>
                       <span style="color: #a2b6da;">(</span>rec <span style="color: #9cb6ad;">(</span>cdr lst<span style="color: #9cb6ad;">)</span> acc<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span>nreverse  <span style="color: #97b098;">(</span>rec lst nil<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#37319;&#29992;&#20869;&#37096;&#32047;&#31215;&#22120;acc, &#23558;&#27599;&#27425;&#32467;&#26524;&#32047;&#31215;&#21040;acc&#37324;&#19968;&#30452;&#20256;&#19979;&#21435;&#65292;&#21040;&#36798;&#26368;&#21518;&#30452;&#25509;&#36820;&#22238;acc</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#31532;&#19977;&#29256;&#23450;&#20041;: &#24490;&#29615;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">filter</span> <span style="color: #93a8c6;">(</span>fn lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>acc nil<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">dolist</span> <span style="color: #97b098;">(</span>x lst<span style="color: #97b098;">)</span>
      <span style="color: #97b098;">(</span><span style="color: #00bfff;">let</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>val <span style="color: #90a890;">(</span>funcall fn x<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
        <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> val <span style="color: #b0b0b3;">(</span>push val acc<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span>nreverse acc<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#27492;&#24418;&#24335;&#31867;&#20284;&#20110;&#19978;&#38754;&#31532;&#20108;&#29256;&#26412;&#23614;&#36882;&#24402;&#24418;&#24335;&#30340;&#32534;&#35793;&#22120;&#20248;&#21270;&#29256;&#26412;&#12290;&#23558;&#23614;&#36882;&#24402;&#36882;&#24402;&#36716;&#21270;&#25104;&#36845;&#20195;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#23558;&#31532;&#20108;&#29256;&#27599;&#27425;&#20256;&#36882;&#30340;&#32047;&#31215;&#22120;acc&#21093;&#31163;&#21040;&#22806;&#23618;&#65292;&#19981;&#20877;&#20256;&#36882;&#23427;&#65292;&#32780;&#26159;&#27599;&#27425;&#23545;&#23427;&#36827;&#34892;&#20462;&#25913;&#65307;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23545;&#20110;&#21015;&#34920;&#30340;&#32858;&#31215;&#25805;&#20316;&#26469;&#35828;&#65292; &#19978;&#36848;&#23450;&#20041;&#20013;&#30340;push&#21644;nrevese&#32452;&#21512;&#26159;&#26631;&#20934;&#30340;lisp&#29992;&#27861;</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org4dfec48" class="outline-2">
<h2 id="org4dfec48"><span class="section-number-2">5</span> 编译</h2>
<div class="outline-text-2" id="text-5">
<p>
lisp 函数可以单独编译或者按文件编译。
如果在toplevel下输入一个defun表达式 <code>(defun foo (x) (1+ x))</code> ，多数实现会创先相应的解释函数(interpreted funtion), 可以使用 <code>(compiled-funtion-p #'foo)</code> 来检查函数是否编译过。
</p>

<p>
使用 <code>compile</code> 来编译函数，如 <code>(compile 'foo)</code>
</p>

<p>
使用 <code>compile-file</code> 来编译整个文件
</p>

<p>
<code>(compile nil '(lambda (x) (+ x 2)))</code> 会编译里面的lambda表达式
</p>

<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">progn</span> <span style="color: #93a8c6;">(</span>compile 'bar '<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #97b098;">(</span>x<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>* x 3<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
       <span style="color: #93a8c6;">(</span>compiled-function-p #'bar<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#19978;&#38754;(compile 'bar '(lambda (x) (* x 3))) &#30456;&#24403;&#20110;&#20415;&#20197;&#19968;&#20010;defun bar</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#24403;&#26576;&#20123;&#23567;&#20989;&#25968;&#35843;&#29992;&#24320;&#38144;&#20250;&#36229;&#20986;&#25191;&#34892;&#24320;&#38144;&#26102;&#65292;&#21487;&#20197;&#20869;&#32852;&#32534;&#35793;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">50th</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>nth 49 lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">proclaim</span> '<span style="color: #93a8c6;">(</span>inline 50th<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#26679;&#24403;&#32534;&#35793;foo&#26102;&#65292; 50th&#20195;&#30721;&#20250;&#34987;&#32534;&#35793;&#21040;&#20869;&#37096;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">foo</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
    <span style="color: #93a8c6;">(</span>+ <span style="color: #b0b1a3;">(</span>50th lst<span style="color: #b0b1a3;">)</span> 1<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23601;&#22909;&#20687;&#26159;&#21407;&#26469;&#20889;&#30340;&#23601;&#26159;&#19979;&#38754;&#36825;&#26679;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">foo</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
    <span style="color: #93a8c6;">(</span>+ <span style="color: #b0b1a3;">(</span>nth 49 lst<span style="color: #b0b1a3;">)</span> 1<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#32570;&#28857;&#26159;&#25913;&#21160;50th&#30340;&#35805;&#65292;&#35201;&#37325;&#26032;&#32534;&#35793;foo, &#21542;&#21017;foo&#36824;&#26159;&#29992;&#30340;&#21407;&#26469;&#30340;</span>


</pre>
</div>
</div>
</div>
<div id="outline-container-orgaedf072" class="outline-2">
<h2 id="orgaedf072"><span class="section-number-2">6</span> 迷思: 使用一堆新操作符(实用工具/utils)让程序难读懂？</h2>
<div class="outline-text-2" id="text-6">
<p>
以下摘自原书4.8节
</p>
<blockquote>
<p>
如果你在代码里用了大量实用工具,有的读者可能会抱怨这种程序晦涩难懂。那些还没能自如使用Lisp的人只能习惯阅读原始的Lisp。
事实上,他们可能一直就无法认同可扩展语言的理念。当读到一个严重依赖实用工具的程序时,在他们看来,作者可能是完全出于怪癖而决定用某种私人语言来写 程序。
</p>

<p>
会有人提出,所有这些新操作符让程序更难读了。他认为必须首先理解所有的这些新操作符,才能读懂程序。
要想知道为什么这类说法是错误的,不妨想想第27页的那个例子,在那里我们想要找到最近的书店。如果用 <code>find2</code> 来写程序,有人可能会抱怨说,在他能够读懂这个程序之前,必须先理解这个实用工具的定义。好吧,假设你没有用 <code>find2</code> 。那么现在可以不用先理解 <code>find2</code> 了,但是读者将不得不去理解 <code>find-books</code> 的定义,该函数相当于把 <code>find2</code> 和查找书店的特定任务混在了一起。理解 <code>find2</code> 并不比理解 <code>find-books</code> 更难。另一方面,在这里我们只用了一次这个新的实用工具。实用工具意味着重复使用。在实际的程序里,它意味着在下列两种情况中做出选择,理解 <code>find2</code>,或者不得不去理解三到四种特定的搜索例程。显然前者更容易些。
</p>

<p>
所以,阅读自底向上的程序确实需要理解作者定义的所有新操作符。但它的工作量几乎总是比理解在没有这些操作符的情况下的所有代码要少很多。
</p>

<p>
如果人们抱怨说使用实用工具使得你的代码难于阅读了,他们很可能根本没有意识到,如果你不使用这些实用工具的话代码看起来将是什么样子。自底向上程序设计让本来规模很大的程序看起来短小简单。给人的感觉就是,这程序并没有做很多事,所以应该很好懂。当缺乏经验的读者们更仔细地阅读程序,结果发现事情并没有想象的那么简单,他们就会灰心丧气。
</p>

<p>
我们在其他领域观察到了相同的现象:设计合理的机器可能部件数量更少,但是看起来会感觉更复杂,因为这些部件被安置在了更小的空间里。自底向上的程序有种感官上的紧密性。阅读这种程序 可能需要花一些力气,但如果不是这样写的话,你会需要花更多的精力来读懂它们。
</p>

<p>
有一种情况下,你应该有意地避免使用实用工具,即:如果你需要写一个小程序,它将独立于其余部分的代码发布。一个实用工具通常至少要被使用两到三次才值得引入,但在小程序里如果一个实用工具用得太少的话,可能就没有必要包含它了。
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org1487038" class="outline-2">
<h2 id="org1487038"><span class="section-number-2">7</span> 语言正交性</h2>
<div class="outline-text-2" id="text-7">
<blockquote>
<p>
正交的语言让我们只需运用多种方式对数量有限的操作符加以组合，就能获得强大的表达能力。玩具积木是非常正交的，而套装塑料模型就很难说他是正交的。
</p>
</blockquote>

<p>
common lisp 有一个函数 <code>complement</code>, 作用是接受一个谓词 <code>p</code> 作为参数，返回一个函数 <code>p1</code> ， 同样的参数情况下，这个 <code>p1</code> 的返回值总和 <code>p</code> 得到相反:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">complement</span> <span style="color: #93a8c6;">(</span>fn<span style="color: #93a8c6;">)</span>
  #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>not <span style="color: #97b098;">(</span>apply fn args<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
这样common lisp提供的几组互补的函数就可以用 <code>complement</code> 配合一个得到另一个，比如:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span>remove-if-not #'pred lst<span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span>remove-if <span style="color: #93a8c6;">(</span>complement #'pred<span style="color: #93a8c6;">)</span> lst<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#26679;&#23601;&#27809;&#26377;&#24517;&#35201;&#26377;remove-if-not(&#34429;&#28982;remove-if-not &#20250;&#27604; remove-if &#26356;&#24120;&#29992;))</span>
</pre>
</div>


<p>
同样 <code>setf</code> 宏也增强Lisp的正交性，Lisp早期的方言会用成对的函数分别实现读数据和写数据，在common lisp里，只有读数据，写数据使用 <code>setf</code> 配合读数据实现的:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#33719;&#21462;ball&#30340;color</span>
<span style="color: #8c8c8c;">(</span>get 'ball 'color<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;;</span><span style="color: #7f7f7f;">&#35774;&#32622;ball&#30340;color</span>
<span style="color: #8c8c8c;">(</span>setf <span style="color: #93a8c6;">(</span>get 'ball 'color<span style="color: #93a8c6;">)</span> 'red<span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#33719;&#21462;hash&#20013;key&#23545;&#24212;&#30340;&#20540;</span>
<span style="color: #8c8c8c;">(</span>gethash key hash-table<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#35774;&#32622;key&#23545;&#24212;&#30340;&#20540;</span>
<span style="color: #8c8c8c;">(</span>setf <span style="color: #93a8c6;">(</span>gethash key hash-table<span style="color: #93a8c6;">)</span> 'some-value<span style="color: #8c8c8c;">)</span>

</pre>
</div>


<p>
还有种成对方式出现的函数：函数和它的破坏性版本，比如: <code>remove-if</code> 和 <code>delete-if</code>, <code>reverse</code> 和 <code>nreverse</code>, <code>append</code> 和 <code>nconc</code> 。我们或许不能让common lisp变得更精简，但可以定义一些新操作符，像 <code>complement</code> 和 <code>setf</code> 那样达到差不多效果:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23384;&#20648;fn&#21644;&#23427;&#30340;&#30772;&#22351;&#24615;&#29256;&#26412;fn!</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defvar</span> <span style="color: #4eee94;">*!equivs*</span> <span style="color: #93a8c6;">(</span>make-hash-table<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#33719;&#21462;fn&#23545;&#24212;&#30340;&#30772;&#22351;&#24615;&#29256;&#26412;fn!</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">!</span> <span style="color: #93a8c6;">(</span>fn<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>or <span style="color: #b0b1a3;">(</span>gethash fn *!equivs*<span style="color: #b0b1a3;">)</span> fn<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#35774;&#32622;fn&#23545;&#24212;&#30340;&#30772;&#22351;&#24615;&#29256;&#26412;fn!</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">def!</span> <span style="color: #93a8c6;">(</span>fn fn!<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>setf <span style="color: #b0b1a3;">(</span>gethash fn *!equivs*<span style="color: #b0b1a3;">)</span> fn!<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
</pre>
</div>

<p>
这样，一旦定义了:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span>def! #'remove-if #'delete-if<span style="color: #8c8c8c;">)</span>
</pre>
</div>

<p>
就可以把:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span>delete-if #'oddp lst<span style="color: #8c8c8c;">)</span>
</pre>
</div>

<p>
改写成:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span>funcall <span style="color: #93a8c6;">(</span>! #'remove-if<span style="color: #93a8c6;">)</span> #'oddp lst<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#34429;&#28982;&#19978;&#38754;&#30340;&#20195;&#30721;&#22312;common lisp&#26377;&#20123;&#23604;&#23596;&#65292;&#23427;&#27169;&#31946;&#20102;&#36825;&#20010;&#24605;&#36335;&#30340;&#33391;&#22909;&#21021;&#34935;&#65292;&#35201;&#26159;&#29992;Scheme&#23601;&#20250;&#26126;&#20102;&#24456;&#22810;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #93a8c6;">(</span>! remove-if<span style="color: #93a8c6;">)</span> oddo lst<span style="color: #8c8c8c;">)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21487;&#20197;&#36890;&#36807; ! &#19968;&#30524;&#30475;&#20986;&#26469;&#29616;&#22312;&#35843;&#29992;&#30340;&#26159;remove-if&#30340;&#30772;&#22351;&#24615;&#29256;&#26412;</span>
</pre>
</div>

<p>
另外由于函数及其对应破坏性版本的取舍经常在运行期之前就能确定，所以把 <code>!</code> 定义成宏或许是更高效的选择。
</p>
</div>
</div>
<div id="outline-container-org148609f" class="outline-2">
<h2 id="org148609f"><span class="section-number-2">8</span> 缓存函数和复合函数(函数as参数和返回值)</h2>
<div class="outline-text-2" id="text-8">
<p>
缓存函数 <code>memoize</code>:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">memoize</span> <span style="color: #93a8c6;">(</span>fn<span style="color: #93a8c6;">)</span>
   <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>cache <span style="color: #aebed8;">(</span>make-hash-table <span style="color: #f08080;">:test</span> #'equal<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     #'<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #97b098;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #97b098;">)</span>
         <span style="color: #97b098;">(</span><span style="color: #00bfff;">multiple-value-bind</span> <span style="color: #aebed8;">(</span>val win<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>gethash fn cache<span style="color: #aebed8;">)</span>
           <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> win
               val
               <span style="color: #b0b0b3;">(</span>setf <span style="color: #90a890;">(</span>gethash fn cache<span style="color: #90a890;">)</span>
                     <span style="color: #90a890;">(</span>apply fn args<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23616;&#38480;:</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">1.&#21442;&#25968;&#21015;&#34920;&#26159;equal&#30340;&#35843;&#29992;&#25165;&#26159;&#31561;&#21516;&#65292;&#23545;&#20110;&#26377;&#20123;&#20851;&#38190;&#23383;&#21442;&#25968;&#20989;&#25968;&#36807;&#20110;&#20005;&#26684;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">2.&#23545;&#20110;&#36820;&#22238;&#21333;&#20540;&#30340;&#20989;&#25968;&#25165;&#26377;&#25928;(&#26080;&#27861;&#20445;&#23384;&#21644;&#36820;&#22238;&#22810;&#20540;)</span>
</pre>
</div>

<p>
单纯复合函数 <code>compose</code> :
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23450;&#20041;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">compose</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> fns<span style="color: #93a8c6;">)</span>
   <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> fns
       <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>fn1 <span style="color: #b0b0b3;">(</span>car <span style="color: #90a890;">(</span>last fns<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
             <span style="color: #aebed8;">(</span>fns <span style="color: #b0b0b3;">(</span>butlast fns<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
         #'<span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #aebed8;">)</span>
             <span style="color: #aebed8;">(</span>reduce #'funcall fns
                     <span style="color: #f08080;">:from-end</span> t
                     <span style="color: #f08080;">:initial-value</span> <span style="color: #b0b0b3;">(</span>apply fn1 args<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
       #'identity<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;</span>
CL-USER&gt; <span style="color: #8c8c8c;">(</span>funcall <span style="color: #93a8c6;">(</span>compose #'1+ #'find-if<span style="color: #93a8c6;">)</span> #'oddp '<span style="color: #93a8c6;">(</span>2 3 4 5<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
4

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(compose #'list #'1+)</span>
<span style="color: #7f7f7f;">;;  </span><span style="color: #7f7f7f;">&#31561;&#20215;&#20110; #'(lambda (x) (list (1+ x)))</span>


</pre>
</div>


<p>
复合函数 <code>fif</code> <code>fint</code> <code>fun</code> :
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">fif</span> <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> then <span style="color: #98f5ff;">&amp;optional</span> else<span style="color: #93a8c6;">)</span>
   #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span>x<span style="color: #b0b1a3;">)</span>
       <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">if</span> <span style="color: #97b098;">(</span>funcall if x<span style="color: #97b098;">)</span>
           <span style="color: #97b098;">(</span>funcall then x<span style="color: #97b098;">)</span>
           <span style="color: #97b098;">(</span><span style="color: #00bfff;">if</span> else <span style="color: #aebed8;">(</span>funcall else x<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">fint means "function intersection"(&#20989;&#25968;&#20132;&#38598;)</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">fint</span> <span style="color: #93a8c6;">(</span>fn <span style="color: #98f5ff;">&amp;rest</span> fns<span style="color: #93a8c6;">)</span>
    <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null fns<span style="color: #b0b1a3;">)</span>
       fn
       <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>chain <span style="color: #b0b0b3;">(</span>apply #'fint fns<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
         #'<span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x<span style="color: #aebed8;">)</span>
             <span style="color: #aebed8;">(</span>and <span style="color: #b0b0b3;">(</span>funcall fn x<span style="color: #b0b0b3;">)</span> <span style="color: #b0b0b3;">(</span>funcall chain x<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">fun means "function union"(&#20989;&#25968;&#24182;&#38598;)</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">fun</span> <span style="color: #93a8c6;">(</span>fn <span style="color: #98f5ff;">&amp;rest</span> fns<span style="color: #93a8c6;">)</span>
   <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null fns<span style="color: #b0b1a3;">)</span>
       fn
       <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>chain <span style="color: #b0b0b3;">(</span>apply #'fun fns<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
         #'<span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x<span style="color: #aebed8;">)</span>
             <span style="color: #aebed8;">(</span>or <span style="color: #b0b0b3;">(</span>funcall fn x<span style="color: #b0b0b3;">)</span> <span style="color: #b0b0b3;">(</span>funcall chain x<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


</pre>
</div>

<p>
这样的话：
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">1.&#36825;&#31181;&#24120;&#35265;&#30340;&#27169;&#24335;:</span>
<span style="color: #8c8c8c;">(</span>mapcar #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span>x<span style="color: #b0b1a3;">)</span>
            <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">if</span> <span style="color: #97b098;">(</span>slave x<span style="color: #97b098;">)</span>
                <span style="color: #97b098;">(</span>owner x<span style="color: #97b098;">)</span>
                <span style="color: #97b098;">(</span>employer x<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
        people<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21487;&#20197;&#20889;&#25104;:</span>
<span style="color: #8c8c8c;">(</span>mapcar <span style="color: #93a8c6;">(</span>fif #'slave #'owner #'employer<span style="color: #93a8c6;">)</span> people<span style="color: #8c8c8c;">)</span>



<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">2.&#36825;&#31181;&#24120;&#35265;&#30340;&#27169;&#24335;:</span>
<span style="color: #8c8c8c;">(</span>find-if #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span>x<span style="color: #b0b1a3;">)</span>
             <span style="color: #b0b1a3;">(</span>and <span style="color: #97b098;">(</span>signed x<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>sealed x<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>delivered x<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
         docs<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21487;&#20197;&#20889;&#25104;:</span>
<span style="color: #8c8c8c;">(</span>find-if <span style="color: #93a8c6;">(</span>fint #'signed #'sealed #'delivered<span style="color: #93a8c6;">)</span> docs<span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">3.&#36825;&#31181;&#24120;&#35265;&#30340;&#27169;&#24335;:</span>
<span style="color: #8c8c8c;">(</span>find-if #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span>x<span style="color: #b0b1a3;">)</span>
             <span style="color: #b0b1a3;">(</span>or <span style="color: #97b098;">(</span>signed x<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>sealed x<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>delivered x<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
         docs<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21487;&#20197;&#20889;&#25104;:</span>
<span style="color: #8c8c8c;">(</span>find-if <span style="color: #93a8c6;">(</span>fun #'signed #'sealed #'delivered<span style="color: #93a8c6;">)</span> docs<span style="color: #8c8c8c;">)</span>


</pre>
</div>
</div>
</div>
<div id="outline-container-org06982e4" class="outline-2">
<h2 id="org06982e4"><span class="section-number-2">9</span> 闭包与数据结构</h2>
<div class="outline-text-2" id="text-9">
<p>
下面这段引用自 <a id="org56bf5f6"></a> 第6章:
</p>
<blockquote>
<p>
通常说来,数据结构被用来描述事物。可以用数组描述坐标变换,用树结构表示命令的层次结构, 而用图来表示铁路网。在lisp里,我们常会使用闭包作为表现形式。在闭包里,变量绑定可以保存信 息,也能扮演在复杂数据结构中指针的角色。如果让一组闭包之间共享绑定,或者让它们之间能相互 引用,那么我们就可以创建混合型的对象类型,它同时继承了数据结构和程序逻辑两者的优点。
其实在表象之下,共享绑定就是指针。闭包只是让我们能在更高的抽象层面上操作指针。通过用 闭包来表示我们以往用静态数据结构表示的对象,就往往可能得到更为优雅,效率更好的程序。
</p>
</blockquote>

<p>
比如说要实现下面这个 twenty questions 游戏：
</p>
<pre class="example">
&gt; (run-node ’people)
Is the person a man?
&gt;&gt; yes
Is he living?
&gt;&gt; no
Was he American?
&gt;&gt; yes
Is he on a coin?
&gt;&gt; yes
Is the coin a penny?
&gt;&gt; yes
LINCOLN
</pre>


<p>
版本1（数据结构版）：
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23384;&#25918;name-&gt;node&#30340;&#20851;&#31995;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defvar</span> <span style="color: #4eee94;">*nodes*</span> <span style="color: #93a8c6;">(</span>make-hash-table<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23384;&#25918;&#27599;&#20010;node&#30340;&#25968;&#25454;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defstruct</span> <span style="color: #98f5ff;">node</span> contents yes no<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23450;&#20041;&#20989;&#25968;&#65292;&#29992;&#26469;&#21521;&#30456;&#24212;&#30340;&#25968;&#25454;&#32467;&#26500;&#23384;&#25918;&#20869;&#23481;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">defnode</span> <span style="color: #93a8c6;">(</span>name conts <span style="color: #98f5ff;">&amp;optional</span> yes no<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>setf <span style="color: #b0b1a3;">(</span>gethash name *nodes*<span style="color: #b0b1a3;">)</span>
        <span style="color: #b0b1a3;">(</span>make-node <span style="color: #f08080;">:contents</span> conts
                   <span style="color: #f08080;">:yes</span> yes
                   <span style="color: #f08080;">:no</span> no<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36941;&#21382;&#20989;&#25968;&#65292;&#29992;&#26469;&#36941;&#21382;&#25968;&#25454;&#32467;&#26500;&#65292;&#26681;&#25454;&#25968;&#25454;&#32467;&#26500;&#37324;&#30340;&#20869;&#23481;&#65292;&#20135;&#29983;&#19981;&#21516;&#30340;&#34892;&#20026;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">run-node</span> <span style="color: #93a8c6;">(</span>name<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>n <span style="color: #aebed8;">(</span>gethash name *nodes*<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">cond</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>node-yes n<span style="color: #aebed8;">)</span>
           <span style="color: #aebed8;">(</span>format t <span style="color: #deb887;">"~a~%&gt;&gt; "</span> <span style="color: #b0b0b3;">(</span>node-contents n<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
           <span style="color: #aebed8;">(</span><span style="color: #00bfff;">case</span> <span style="color: #b0b0b3;">(</span>read<span style="color: #b0b0b3;">)</span>
             <span style="color: #b0b0b3;">(</span>yes <span style="color: #90a890;">(</span>run-node <span style="color: #a2b6da;">(</span>node-yes n<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
             <span style="color: #b0b0b3;">(</span>t <span style="color: #90a890;">(</span>run-node <span style="color: #a2b6da;">(</span>node-no n<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
          <span style="color: #97b098;">(</span>t <span style="color: #aebed8;">(</span>node-contents n<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23450;&#20041;&#20989;&#25968;&#30340;&#20351;&#29992;</span>
<span style="color: #8c8c8c;">(</span>defnode 'people <span style="color: #deb887;">"Is the person a man?"</span> 'male 'female<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'male <span style="color: #deb887;">"Is he living?"</span> 'liveman 'deadman<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'deadman <span style="color: #deb887;">"Was he American?"</span> 'us 'them<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'us <span style="color: #deb887;">"Is he on a coin?"</span> 'coin 'cidence<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'coin <span style="color: #deb887;">"Is the coin a penny?"</span> 'penny 'coins<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'penny 'lincoln<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36941;&#21382;&#20989;&#25968;&#30340;&#20351;&#29992;&#65307;&#31243;&#24207;&#30340;&#20837;&#21475;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(run-node 'people)</span>

</pre>
</div>

<p>
其中数据结构如下图所示:
</p>


<div class="figure">
<p><img src="static/images/onlisp-01.png" alt="onlisp-01.png" />
</p>
</div>


<p>
版本2(closure版)：
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23384;&#25918;name-&gt;closure&#30340;&#20851;&#31995;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defvar</span> <span style="color: #4eee94;">*nodes*</span> <span style="color: #93a8c6;">(</span>make-hash-table<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23450;&#20041;&#20989;&#25968;&#65292;&#29983;&#25104;&#23545;&#24212;closure&#65292;&#24182;&#19988;&#23384;&#25918;&#21040;*nodes*&#37324;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">defnode</span> <span style="color: #93a8c6;">(</span>name conts <span style="color: #98f5ff;">&amp;optional</span> yes no<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>setf <span style="color: #b0b1a3;">(</span>gethash name *nodes*<span style="color: #b0b1a3;">)</span>
        <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">if</span> yes
            #'<span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">()</span>
                <span style="color: #aebed8;">(</span>format t <span style="color: #deb887;">"~a~%&gt;&gt; "</span> conts<span style="color: #aebed8;">)</span>
                <span style="color: #aebed8;">(</span><span style="color: #00bfff;">case</span> <span style="color: #b0b0b3;">(</span>read<span style="color: #b0b0b3;">)</span>
                  <span style="color: #b0b0b3;">(</span>yes <span style="color: #90a890;">(</span>funcall <span style="color: #a2b6da;">(</span>gethash yes *nodes*<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                  <span style="color: #b0b0b3;">(</span>t <span style="color: #90a890;">(</span>funcall <span style="color: #a2b6da;">(</span>gethash no *nodes*<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
            #'<span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">()</span> conts<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23450;&#20041;&#20989;&#25968;&#30340;&#20351;&#29992;</span>
<span style="color: #8c8c8c;">(</span>defnode 'people <span style="color: #deb887;">"Is the person a man?"</span> 'male 'female<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'male <span style="color: #deb887;">"Is he living?"</span> 'liveman 'deadman<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'deadman <span style="color: #deb887;">"Was he American?"</span> 'us 'them<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'us <span style="color: #deb887;">"Is he on a coin?"</span> 'coin 'cidence<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'coin <span style="color: #deb887;">"Is the coin a penny?"</span> 'penny 'coins<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'penny 'lincoln<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#31243;&#24207;&#30340;&#20837;&#21475;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(funcall (gethash 'people *nodes*))</span>


</pre>
</div>

<p>
可以看到，该版本没有“遍历函数”了，使用的时候直接调用存放在 <code>*nodes*</code> 中已经生成的closure。
</p>

<p>
其中 <code>*node*</code> 的结构图如下：
</p>


<div class="figure">
<p><img src="static/images/onlisp-02.png" alt="onlisp-02.png" />
</p>
</div>



<p>
版本3（编译的closure）:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23384;&#25918;&#23450;&#20041;&#26102;&#25968;&#25454;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defvar</span> <span style="color: #4eee94;">*nodes*</span> nil<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23450;&#20041;&#30340;&#20989;&#25968;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">defnode</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>push args *nodes*<span style="color: #93a8c6;">)</span>
  args<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#26681;&#25454; &#23450;&#20041;&#26102;&#23384;&#25918;&#30340;&#25968;&#25454; &#26469;&#29983;&#25104; &#25972;&#20010;&#36816;&#34892;&#30340;&#31243;&#24207;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">compile-net</span> <span style="color: #93a8c6;">(</span>root<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>node <span style="color: #aebed8;">(</span>assoc root *nodes*<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">if</span> <span style="color: #97b098;">(</span>null node<span style="color: #97b098;">)</span>
        nil
        <span style="color: #97b098;">(</span><span style="color: #00bfff;">let</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>conts <span style="color: #90a890;">(</span>second node<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span>yes <span style="color: #90a890;">(</span>third node<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span>no <span style="color: #90a890;">(</span>fourth node<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> yes
              <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #90a890;">(</span><span style="color: #a2b6da;">(</span>yes-fn <span style="color: #9cb6ad;">(</span>compile-net yes<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span>
                    <span style="color: #a2b6da;">(</span>no-fn <span style="color: #9cb6ad;">(</span>compile-net no<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                #'<span style="color: #90a890;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #a2b6da;">()</span>
                    <span style="color: #a2b6da;">(</span>format t <span style="color: #deb887;">"~a~%&gt;&gt;"</span> conts<span style="color: #a2b6da;">)</span>
                    <span style="color: #a2b6da;">(</span>funcall <span style="color: #9cb6ad;">(</span><span style="color: #00bfff;">if</span> <span style="color: #8c8c8c;">(</span>eq <span style="color: #93a8c6;">(</span>read<span style="color: #93a8c6;">)</span> 'yes<span style="color: #8c8c8c;">)</span>
                                 yes-fn
                                 no-fn<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
              #'<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">()</span> conts<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23450;&#20041;&#20989;&#25968;&#30340;&#20351;&#29992;</span>
<span style="color: #8c8c8c;">(</span>defnode 'people <span style="color: #deb887;">"Is the person a man?"</span> 'male 'female<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'male <span style="color: #deb887;">"Is he living?"</span> 'liveman 'deadman<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'deadman <span style="color: #deb887;">"Was he American?"</span> 'us 'them<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'us <span style="color: #deb887;">"Is he on a coin?"</span> 'coin 'cidence<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'coin <span style="color: #deb887;">"Is the coin a penny?"</span> 'penny 'coins<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>defnode 'penny 'lincoln<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#31243;&#24207;&#30340;&#20837;&#21475;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(setf n (compile-net 'people))</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(funcall n)</span>


</pre>
</div>

<p>
相应的数据结构和编译后的结构如下:
</p>


<div class="figure">
<p><img src="static/images/onlisp-03.png" alt="onlisp-03.png" />
</p>
</div>

<p>
其中在编译好的函数 <code>n</code> 后， <code>*nodes*</code> 已经可以垃圾回收了，里面相应的数据关系已经绑定到了闭包 <code>n</code> 中。
</p>
</div>
</div>


<div id="outline-container-orge119bb3" class="outline-2">
<h2 id="orge119bb3"><span class="section-number-2">10</span> 使用宏还是函数</h2>
<div class="outline-text-2" id="text-10">
</div>
<div id="outline-container-orgcb02084" class="outline-3">
<h3 id="orgcb02084"><span class="section-number-3">10.1</span> 当别无他法时</h3>
<div class="outline-text-3" id="text-10-1">
</div>
<div id="outline-container-org89559d7" class="outline-4">
<h4 id="org89559d7"><span class="section-number-4">10.1.1</span> 宏可以控制对参数的求值，可以求值一次，多次或者不求值</h4>
<div class="outline-text-4" id="text-10-1-1">
<p>
宏的这种控制主要体现在四个方面:
</p>
<blockquote>
<p>
1.变换。例如 setf, (setf (car x) ’a)  需要 展开为 (progn (rplaca x ’a) ’a)
2.绑定。例如 let, 它的实参需要作为展开的lambda表达式的形参出现
3.条件求值。例如 when, 参数在条件为真时再求值
4.多重求职。例如do, 这样可以对特定的参数求值多次，比如每次的step form
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org890e452" class="outline-4">
<h4 id="org890e452"><span class="section-number-4">10.1.2</span> 宏展开式内联到宏调用的词法环境</h4>
<div class="outline-text-4" id="text-10-1-2">
<p>
这种优势体现在:
</p>
<blockquote>
<ol class="org-ol">
<li>利用调用环境</li>
</ol>
<p>
(defmacro foo (x)
      `(+ ,x y))
</p>

<ol class="org-ol">
<li>包装新环境，比如let</li>

<li>减少函数调用，将运行时的开销转到了编译时期</li>
</ol>

<p>
值得注意的是，上面1，2两点也会产生变量捕捉等问题。
</p>
</blockquote>
</div>
</div>
</div>
</div>

<div id="outline-container-org79f8ed9" class="outline-2">
<h2 id="org79f8ed9"><span class="section-number-2">11</span> 宏与于函数优缺点</h2>
<div class="outline-text-2" id="text-11">
</div>
<div id="outline-container-org86f96d1" class="outline-3">
<h3 id="org86f96d1"><span class="section-number-3">11.1</span> 宏优点</h3>
<div class="outline-text-3" id="text-11-1">
<ul class="org-ul">
<li>编译期计算</li>
<li>和lisp集成</li>
<li>免除函数调用</li>
</ul>
</div>
</div>
<div id="outline-container-org5ee183e" class="outline-3">
<h3 id="org5ee183e"><span class="section-number-3">11.2</span> 函数优点</h3>
<div class="outline-text-3" id="text-11-2">
<ul class="org-ul">
<li>函数即数据</li>
<li>源代码清晰</li>
<li>运行期清晰</li>
<li>递归</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org9bb2f51" class="outline-2">
<h2 id="org9bb2f51"><span class="section-number-2">12</span> 宏陷阱</h2>
<div class="outline-text-2" id="text-12">
</div>
<div id="outline-container-orgaa61ecb" class="outline-3">
<h3 id="orgaa61ecb"><span class="section-number-3">12.1</span> 变量捕捉</h3>
<div class="outline-text-3" id="text-12-1">
</div>
<div id="outline-container-org1ae55be" class="outline-4">
<h4 id="org1ae55be"><span class="section-number-4">12.1.1</span> 宏参数捕捉</h4>
<div class="outline-text-4" id="text-12-1-1">
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#23450;&#20041;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">for</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>var start stop<span style="color: #b0b1a3;">)</span> <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">do</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>,var ,start <span style="color: #aebed8;">(</span>1+ ,var<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span>limit ,stop<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
       <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>&gt; ,var limit<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     ,@body<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;case1</span>
<span style="color: #8c8c8c;">(</span>for <span style="color: #93a8c6;">(</span>x 1 5<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>princ x<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#23637;&#24320;</span>
<span style="color: #8c8c8c;">(</span>macroexpand-1 '<span style="color: #93a8c6;">(</span>for <span style="color: #b0b1a3;">(</span>x 1 5<span style="color: #b0b1a3;">)</span>
                 <span style="color: #b0b1a3;">(</span>princ x<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">DO</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>X 1 <span style="color: #97b098;">(</span>1+ X<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>LIMIT 5<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
    <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>&gt; X LIMIT<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>PRINC X<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;case2</span>
<span style="color: #8c8c8c;">(</span>for <span style="color: #93a8c6;">(</span>limit 1 5<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>princ limit<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#23637;&#24320;</span>
<span style="color: #8c8c8c;">(</span>macroexpand-1 '<span style="color: #93a8c6;">(</span>for <span style="color: #b0b1a3;">(</span>limit 1 5<span style="color: #b0b1a3;">)</span>
                 <span style="color: #b0b1a3;">(</span>princ limit<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">DO</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>LIMIT 1 <span style="color: #97b098;">(</span>1+ LIMIT<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>LIMIT 5<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
    <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>&gt; LIMIT LIMIT<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>PRINC LIMIT<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;case3</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>limit 5<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>for <span style="color: #b0b1a3;">(</span>i 1 5<span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">when</span> <span style="color: #97b098;">(</span>&gt; i limit<span style="color: #97b098;">)</span>
      <span style="color: #97b098;">(</span>princ i<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#23637;&#24320;</span>
<span style="color: #8c8c8c;">(</span>macroexpand-1 '<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>limit 5<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
                 <span style="color: #b0b1a3;">(</span>for <span style="color: #97b098;">(</span>i 1 10<span style="color: #97b098;">)</span>
                   <span style="color: #97b098;">(</span><span style="color: #00bfff;">when</span> <span style="color: #aebed8;">(</span>&gt; i limit<span style="color: #aebed8;">)</span>
                     <span style="color: #aebed8;">(</span>princ i<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>LIMIT 5<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">DO</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>I 1 <span style="color: #aebed8;">(</span>1+ I<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span>LIMIT 10<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>&gt; I LIMIT<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">WHEN</span> <span style="color: #97b098;">(</span>&gt; I LIMIT<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>PRINC I<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


</pre>
</div>
</div>
</div>
<div id="outline-container-orgfd483d4" class="outline-4">
<h4 id="orgfd483d4"><span class="section-number-4">12.1.2</span> 自由符号捕捉</h4>
<div class="outline-text-4" id="text-12-1-2">
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defvar</span> <span style="color: #4eee94;">w</span> nil<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">; </span><span style="color: #7f7f7f;">wrong &#36825;&#37324;&#30340;w&#20250;&#21644;&#22312;&#35843;&#29992;&#29615;&#22659;&#20013;&#30340;w&#20135;&#29983;&#20316;&#29992;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">gripe</span> <span style="color: #93a8c6;">(</span>warning<span style="color: #93a8c6;">)</span>
 `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">progn</span> <span style="color: #b0b1a3;">(</span>setq w <span style="color: #97b098;">(</span>nconc w <span style="color: #aebed8;">(</span>list ,warning<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
  nil<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgbfad30d" class="outline-3">
<h3 id="orgbfad30d"><span class="section-number-3">12.2</span> 求值次数</h3>
<div class="outline-text-3" id="text-12-2">
<div class="org-src-container">
<pre class="src src-lisp">&#27491;&#30830;&#30340;&#29256;&#26412;:
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">for</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>var start stop<span style="color: #b0b1a3;">)</span> <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>gstop <span style="color: #aebed8;">(</span>gensym<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">do</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>,var ,start <span style="color: #b0b0b3;">(</span>1+ ,var<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span>,gstop ,stop<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
         <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>&gt; ,var ,gstop<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       ,@body<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

&#23548;&#33268;&#22810;&#37325;&#27714;&#20540;:
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">for</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>var start stop<span style="color: #b0b1a3;">)</span> <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">do</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>,var ,start <span style="color: #aebed8;">(</span>1+ ,var<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
       <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>&gt; ,var ,stop<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     ,@body<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orgc110bc2" class="outline-3">
<h3 id="orgc110bc2"><span class="section-number-3">12.3</span> 求值顺序</h3>
<div class="outline-text-3" id="text-12-3">
<div class="org-src-container">
<pre class="src src-lisp">
&#38169;&#35823;&#30340;&#27714;&#20540;&#39034;&#24207;:
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">for</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>var start stop<span style="color: #b0b1a3;">)</span> <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>gstop <span style="color: #aebed8;">(</span>gensym<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">do</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>,gstop ,stop<span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span>,var ,start <span style="color: #b0b0b3;">(</span>1+ ,var<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
         <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>&gt; ,var ,gstop<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        ,@body<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

&#20351;&#29992;:
&gt; <span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>x 1<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
    <span style="color: #93a8c6;">(</span>for <span style="color: #b0b1a3;">(</span>i x <span style="color: #97b098;">(</span>setq x 13<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>princ i<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
12345678910111213
NIL

&#24341;&#29992;&#33258;&#21407;&#20070;10.2:
&#23613;&#31649;&#19978;&#38754;&#30340;&#20363;&#23376;&#26159;&#26460;&#25776;&#30340;,&#20294;&#26159;&#36825;&#31867;&#38382;&#39064;&#30830;&#23454;&#36824;&#20250;&#26102;&#26377;&#21457;&#29983;,&#32780;&#19988;&#36825;&#31181;bug&#24456;&#38590;&#25214;&#20986;&#26469;&#12290;&#25110;&#35768;&#24456;&#23569;&#26377;&#20154;&#20250;&#20889;&#20986;&#36825;&#26679;&#30340;&#20195;&#30721;,&#35753;&#23439;&#19968;&#20010;&#21442;&#25968;&#30340;&#27714;&#20540;&#24433;&#21709;&#21040;&#21478;&#19968;&#20010;&#21442;&#25968;&#30340;&#36820;&#22238;&#20540;,&#20294;&#26159;&#20154;&#20204;&#22312;&#26080;&#24847;&#20013;&#20570;&#30340;&#20107;&#24773;,&#26377;&#21487;&#33021;&#24182;&#38750;&#20986;&#33258;&#26412;&#24515;&#12290;&#23613;&#31649;&#22312;&#26377;&#24847;&#36825;&#26679;&#29992;&#26102;,&#24212;&#24403;&#27491;&#24120;&#24037;&#20316;,&#20294;&#26159;&#36825;&#19981;&#26159;&#35753;bug&#34255;&#36523;&#20110;&#23454;&#29992;&#24037;&#20855;&#30340;&#29702;&#30001;&#12290;&#22914;&#26524;&#26377;&#20154;&#20889;&#20986;&#30340;&#20195;&#30721;&#21644;&#21069;&#20363;&#30456;&#20284;,&#23427;&#24456;&#21487;&#33021;&#26159;&#35823;&#20889;&#25104;&#30340;,&#20294; for &#30340;&#27491;&#30830;&#29256;&#26412;&#23558;&#20351;&#38169;&#35823;&#26356;&#23481;&#26131; &#26816;&#27979;&#20986;&#26469;&#12290;
</pre>
</div>
</div>
</div>
<div id="outline-container-org74dd179" class="outline-3">
<h3 id="org74dd179"><span class="section-number-3">12.4</span> 非函数式的展开器</h3>
<div class="outline-text-3" id="text-12-4">
<p>
一个宏调用可以,并且经常会被展开不只一次。例如,一个对你代码进行变换的预处理器在它决定是否变换代码之前,可能不得不展 表达式中的宏调用。
这是一条普适的规则,即:展开器代码除其参数外不应依赖其他任何东西。所以任何宏,比如说通过字符串来构造展开式的那种,应当小心不要对宏展开时所在的包作任何假设。
</p>

<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">case1 &#20381;&#36182;&#20840;&#23616;&#21464;&#37327;&#26469;&#35745;&#25968;&#65292;&#20551;&#35774;&#27599;&#27425;&#35843;&#29992;&#23637;&#24320;&#19968;&#27425;&#65288;&#38169;&#35823;&#65289;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">nil!</span> <span style="color: #93a8c6;">(</span>x<span style="color: #93a8c6;">)</span> <span style="color: #7f7f7f;">; wrong</span>
 <span style="color: #93a8c6;">(</span>incf *nil!s*<span style="color: #93a8c6;">)</span>
`<span style="color: #93a8c6;">(</span>setf ,x nil<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>



<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">case2 &#20381;&#36182;&#21253;&#65292;&#20551;&#35774;&#23637;&#24320;&#30340;&#21253;&#37324;&#21547;&#26377;opstring&#30340;&#23450;&#20041;&#65288;&#38169;&#35823;&#65289;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">string-call</span> <span style="color: #93a8c6;">(</span>opstring <span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span> <span style="color: #7f7f7f;">; wrong</span>
  `<span style="color: #93a8c6;">(</span>,<span style="color: #b0b1a3;">(</span>intern opstring<span style="color: #b0b1a3;">)</span> ,@args<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
展开式代码中的副作用有时会带来一些问题,CLTL(78页)提到,Common Lisp并不保证绑定在 <code>&amp;rest</code> 形参上的列表是新生成的。它们可能会和程序其他地方的列表共享数据结构。
后果就是,你不能破坏性地修改 <code>&amp;rest</code> 形参,因为你不知道你将会改掉其他什么东西。
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">case3 &#20462;&#25913;&amp;rest args&#21015;&#34920;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">echo</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  `&#8217;,<span style="color: #93a8c6;">(</span>nconc args <span style="color: #b0b1a3;">(</span>list &#8217;amen<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

&#28982;&#21518;&#23450;&#20041;&#19968;&#20010;&#20989;&#25968;&#26469;&#35843;&#29992;&#23427;:
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">foo</span> <span style="color: #93a8c6;">()</span> <span style="color: #93a8c6;">(</span>echo x<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

&#22312;&#19968;&#20010;&#24191;&#27867;&#20351;&#29992;&#30340;Common Lisp&#20013;,&#21017;&#20250;&#35266;&#23519;&#21040;&#19979;&#38754;&#30340;&#29616;&#35937;:
&gt; <span style="color: #8c8c8c;">(</span>foo<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>X AMEN AMEN<span style="color: #8c8c8c;">)</span>
&gt; <span style="color: #8c8c8c;">(</span>foo<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>X AMEN AMEN AMEN<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#28982;&#32780;&#65292;&#25105;&#23454;&#39564;&#30340;&#20004;&#20010;&#23454;&#29616;ccl&#21644;sbcl&#37117;&#19981;&#20986;&#20986;&#29616;&#19978;&#36848;&#36825;&#20010;&#38382;&#39064;&#65292;&#30475;&#26469;&#26159;&#23558;&#36825;&#31181;&#26131;&#20110;&#20986;&#38382;&#39064;&#30340;&#24773;&#20917;&#35268;&#36991;&#20102;</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org5f2af33" class="outline-3">
<h3 id="org5f2af33"><span class="section-number-3">12.5</span> 递归</h3>
<div class="outline-text-3" id="text-12-5">
<p>
<code>nth</code> 的例子：
</p>
<div class="org-src-container">
<pre class="src src-lisp">&#36825;&#20010;&#21487;&#20197;&#24037;&#20316;:
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">ntha</span> <span style="color: #93a8c6;">(</span>n lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>= n 0<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>car lst<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>ntha <span style="color: #97b098;">(</span>- n 1<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>cdr lst<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


&#36825;&#20010;&#19981;&#33021;&#32534;&#35793;<span style="color: #8c8c8c;">&#65288;</span>&#20381;&#36182;n&#30340;&#20540;&#65292;&#32780;&#32534;&#35793;&#22120;&#27809;&#26377;&#20540;&#65292;&#25152;&#20197;&#20250;&#19968;&#30452;&#23637;&#24320;&#19979;&#21435;<span style="color: #8c8c8c;">&#65289;</span>:
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">nthb</span> <span style="color: #93a8c6;">(</span>n lst<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>= ,n 0<span style="color: #b0b1a3;">)</span>
       <span style="color: #b0b1a3;">(</span>car ,lst<span style="color: #b0b1a3;">)</span>
       <span style="color: #b0b1a3;">(</span>nthb <span style="color: #97b098;">(</span>- ,n 1<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>cdr ,lst<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


&#35299;&#20915;&#26041;&#27861;&#65306;&#23558;&#23439;&#25913;&#25104;&#23439;&#21644;&#20989;&#25968;&#30340;&#32452;&#21512;

&#35299;&#20915;&#38382;&#39064;&#30340;&#26041;&#27861;&#19968;:
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">nthd</span> <span style="color: #93a8c6;">(</span>n lst<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span>nth-fn ,n ,lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">nth-fn</span> <span style="color: #93a8c6;">(</span>n lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>= n 0<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>car lst<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>nth-fn <span style="color: #97b098;">(</span>- n 1<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>cdr lst<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

&#35299;&#20915;&#38382;&#39064;&#30340;&#26041;&#27861;&#32780;:
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">nthe</span> <span style="color: #93a8c6;">(</span>n lst<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>nth-fn <span style="color: #aebed8;">(</span>n lst<span style="color: #aebed8;">)</span>
              <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b0b3;">(</span>= n 0<span style="color: #b0b0b3;">)</span>
                  <span style="color: #b0b0b3;">(</span>car lst<span style="color: #b0b0b3;">)</span>
                  <span style="color: #b0b0b3;">(</span>nth-fn <span style="color: #90a890;">(</span>- n 1<span style="color: #90a890;">)</span> <span style="color: #90a890;">(</span>cdr lst<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     <span style="color: #b0b1a3;">(</span>nth-fn ,n ,lst<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
<code>or</code> 的例子
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">case1 &#36716;&#21270;&#25104;&#23439;&#21644;&#20989;&#25968;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">ora</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>or-expand args<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">or-expand</span> <span style="color: #93a8c6;">(</span>args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null args<span style="color: #b0b1a3;">)</span>
      nil
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>sym <span style="color: #b0b0b3;">(</span>gensym<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        `<span style="color: #97b098;">(</span><span style="color: #00bfff;">let</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>,sym ,<span style="color: #90a890;">(</span>car args<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
           <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> ,sym
               ,sym
               ,<span style="color: #b0b0b3;">(</span>or-expand <span style="color: #90a890;">(</span>cdr args<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">case2 &#36825;&#37324;&#36882;&#24402;&#35843;&#29992;&#33258;&#36523;&#27809;&#38382;&#39064;&#65292;&#22240;&#20026;&#23427;&#32456;&#27490;&#30340;&#26465;&#20214;&#26159;&#20381;&#36182;&#21442;&#25968;&#20010;&#25968;&#65292;&#32780;&#19981;&#26159;&#20540;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">orb</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null args<span style="color: #b0b1a3;">)</span>
      nil
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>sym <span style="color: #b0b0b3;">(</span>gensym<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        `<span style="color: #97b098;">(</span><span style="color: #00bfff;">let</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>,sym ,<span style="color: #90a890;">(</span>car args<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
           <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> ,sym
               ,sym
               <span style="color: #b0b0b3;">(</span>orb ,@<span style="color: #90a890;">(</span>cdr args<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org337aad6" class="outline-2">
<h2 id="org337aad6"><span class="section-number-2">13</span> 常用宏</h2>
<div class="outline-text-2" id="text-13">
</div>
<div id="outline-container-org245ef1e" class="outline-3">
<h3 id="org245ef1e"><span class="section-number-3">13.1</span> 创建上下文</h3>
<div class="outline-text-3" id="text-13-1">
</div>
<div id="outline-container-orge809d9d" class="outline-4">
<h4 id="orge809d9d"><span class="section-number-4">13.1.1</span> 自定义let</h4>
<div class="outline-text-4" id="text-13-1-1">
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23450;&#20041;</span>
CL-USER&gt; <span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">our-let</span> <span style="color: #93a8c6;">(</span>binds <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
           `<span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">lambda</span> ,<span style="color: #97b098;">(</span>mapcar #'<span style="color: #aebed8;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b0b3;">(</span>x<span style="color: #b0b0b3;">)</span>
                             <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">if</span> <span style="color: #90a890;">(</span>consp x<span style="color: #90a890;">)</span>
                                 <span style="color: #90a890;">(</span>car x<span style="color: #90a890;">)</span>
                                 x<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
                         binds<span style="color: #97b098;">)</span>
               ,@body<span style="color: #b0b1a3;">)</span>
             ,@<span style="color: #b0b1a3;">(</span>mapcar #'<span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x<span style="color: #aebed8;">)</span>
                           <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b0b3;">(</span>consp x<span style="color: #b0b0b3;">)</span>
                               <span style="color: #b0b0b3;">(</span>cadr x<span style="color: #b0b0b3;">)</span>
                               nil<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
                       binds<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
       OUR-LET

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#25928;&#26524;</span>
CL-USER&gt; <span style="color: #8c8c8c;">(</span>our-let <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>x 1<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>y 2<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
           <span style="color: #93a8c6;">(</span>+ x y<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
3

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23637;&#24320;&#25104;(macroexpand):</span>
<span style="color: #8c8c8c;">(</span><span style="color: #93a8c6;">(</span><span style="color: #00bfff;">LAMBDA</span> <span style="color: #b0b1a3;">(</span>X Y<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>+ X Y<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span> 1 2<span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>


<div id="outline-container-orgdc82a47" class="outline-4">
<h4 id="orgdc82a47"><span class="section-number-4">13.1.2</span> 模仿let*的when-bind*</h4>
<div class="outline-text-4" id="text-13-1-2">
<p>
when-bind* 接受一个由成对的 (symbol expression) form 所组成的列表就和 let 的第一个参数的形式相同。如果任何 expression返回nil, 那整个when-bind*返回nil
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23450;&#20041;</span>
CL-USER&gt; <span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">when-bind*</span> <span style="color: #93a8c6;">(</span>binds <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
           <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null binds<span style="color: #b0b1a3;">)</span>
               `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">progn</span> ,@body<span style="color: #b0b1a3;">)</span>
               `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span>,<span style="color: #aebed8;">(</span>car binds<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
                  <span style="color: #97b098;">(</span><span style="color: #00bfff;">if</span> ,<span style="color: #aebed8;">(</span>caar binds<span style="color: #aebed8;">)</span>
                      <span style="color: #aebed8;">(</span>when-bind* ,<span style="color: #b0b0b3;">(</span>cdr binds<span style="color: #b0b0b3;">)</span> ,@body<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
WHEN-BIND*

CL-USER&gt; <span style="color: #8c8c8c;">(</span>when-bind* <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>x <span style="color: #97b098;">(</span>find-if #'consp '<span style="color: #aebed8;">(</span>a <span style="color: #b0b0b3;">(</span>1 2<span style="color: #b0b0b3;">)</span> b<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
                      <span style="color: #b0b1a3;">(</span>y <span style="color: #97b098;">(</span>find-if #'oddp x<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
           <span style="color: #93a8c6;">(</span>+ y 10<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
11
CL-USER&gt;

<span style="color: #7f7f7f;">;;  </span><span style="color: #7f7f7f;">macroexpand</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">step1</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>X <span style="color: #97b098;">(</span>FIND-IF #'CONSP '<span style="color: #aebed8;">(</span>A <span style="color: #b0b0b3;">(</span>1 2<span style="color: #b0b0b3;">)</span> B<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">IF</span> X
      <span style="color: #b0b1a3;">(</span>WHEN-BIND* <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>Y <span style="color: #b0b0b3;">(</span>FIND-IF #'ODDP X<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span>+ Y 10<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;;</span><span style="color: #7f7f7f;">step2</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>X <span style="color: #97b098;">(</span>FIND-IF #'CONSP '<span style="color: #aebed8;">(</span>A <span style="color: #b0b0b3;">(</span>1 2<span style="color: #b0b0b3;">)</span> B<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">IF</span> X
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>Y <span style="color: #b0b0b3;">(</span>FIND-IF #'ODDP X<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span><span style="color: #00bfff;">IF</span> Y
            <span style="color: #aebed8;">(</span>WHEN-BIND* NIL
              <span style="color: #b0b0b3;">(</span>+ Y 10<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">step3</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>X <span style="color: #97b098;">(</span>FIND-IF #'CONSP '<span style="color: #aebed8;">(</span>A <span style="color: #b0b0b3;">(</span>1 2<span style="color: #b0b0b3;">)</span> B<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">IF</span> X
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>Y <span style="color: #b0b0b3;">(</span>FIND-IF #'ODDP X<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span><span style="color: #00bfff;">IF</span> Y
            <span style="color: #aebed8;">(</span><span style="color: #00bfff;">PROGN</span> <span style="color: #b0b0b3;">(</span>+ Y 10<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>


<div id="outline-container-orgf9ca274" class="outline-4">
<h4 id="orgf9ca274"><span class="section-number-4">13.1.3</span> with-gensyms</h4>
<div class="outline-text-4" id="text-13-1-3">
<div class="org-src-container">
<pre class="src src-lisp">CL-USER&gt;  <span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">with-gensyms</span> <span style="color: #93a8c6;">(</span>syms <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
            `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> ,<span style="color: #b0b1a3;">(</span>mapcar <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>s<span style="color: #aebed8;">)</span> `<span style="color: #aebed8;">(</span>,s <span style="color: #b0b0b3;">(</span>gensym<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> syms<span style="color: #b0b1a3;">)</span>
               ,@body<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org0d26042" class="outline-4">
<h4 id="org0d26042"><span class="section-number-4">13.1.4</span> condlet</h4>
<div class="outline-text-4" id="text-13-1-4">
<p>
宏效果：
对于表达式求值主体里的每个变量，如果那个cond条件满足，则用里面绑定的值，没有绑定的变量取nil
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span>condlet <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>= 1 2<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>x <span style="color: #aebed8;">(</span>princ &#8217;a<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>y <span style="color: #aebed8;">(</span>princ &#8217;b<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
          <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>= 1 1<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>y <span style="color: #aebed8;">(</span>princ &#8217;c<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>x <span style="color: #aebed8;">(</span>princ &#8217;d<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
          <span style="color: #b0b1a3;">(</span>t       <span style="color: #97b098;">(</span>x <span style="color: #aebed8;">(</span>princ &#8217;e<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>z <span style="color: #aebed8;">(</span>princ &#8217;f<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>list x y z<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span>condlet <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>= 1 2<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>x <span style="color: #aebed8;">(</span>princ 'a<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>y <span style="color: #aebed8;">(</span>princ 'b<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
                   <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>= 1 1<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>y <span style="color: #aebed8;">(</span>princ 'c<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>x <span style="color: #aebed8;">(</span>princ 'd<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
                   <span style="color: #b0b1a3;">(</span>t       <span style="color: #97b098;">(</span>x <span style="color: #aebed8;">(</span>princ 'e<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>z <span style="color: #aebed8;">(</span>princ 'f<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
           <span style="color: #93a8c6;">(</span>list x y z<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
=&gt;

CD
<span style="color: #8c8c8c;">(</span>D C NIL<span style="color: #8c8c8c;">)</span>


&#23439;&#23637;&#24320; =&gt;

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LABELS</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>#<span style="color: #f08080;">:G606</span> <span style="color: #97b098;">(</span>Y X Z<span style="color: #97b098;">)</span>
           <span style="color: #97b098;">(</span>LIST X Y Z<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">COND</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>= 1 2<span style="color: #97b098;">)</span>
     <span style="color: #97b098;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #aebed8;">(</span>#<span style="color: #f08080;">:G607</span> #<span style="color: #f08080;">:G608</span> #<span style="color: #f08080;">:G609</span><span style="color: #aebed8;">)</span>
       <span style="color: #aebed8;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #b0b0b3;">(</span><span style="color: #90a890;">(</span>#<span style="color: #f08080;">:G608</span> <span style="color: #a2b6da;">(</span>PRINC &#8217;A<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span> <span style="color: #90a890;">(</span>#<span style="color: #f08080;">:G607</span> <span style="color: #a2b6da;">(</span>PRINC &#8217;B<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
         <span style="color: #b0b0b3;">(</span>#<span style="color: #f08080;">:G606</span> #<span style="color: #f08080;">:G607</span> #<span style="color: #f08080;">:G608</span> #<span style="color: #f08080;">:G609</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>= 1 1<span style="color: #97b098;">)</span>
     <span style="color: #97b098;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #aebed8;">(</span>#<span style="color: #f08080;">:G607</span> #<span style="color: #f08080;">:G608</span> #<span style="color: #f08080;">:G609</span><span style="color: #aebed8;">)</span>
       <span style="color: #aebed8;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #b0b0b3;">(</span><span style="color: #90a890;">(</span>#<span style="color: #f08080;">:G607</span> <span style="color: #a2b6da;">(</span>PRINC &#8217;C<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span> <span style="color: #90a890;">(</span>#<span style="color: #f08080;">:G608</span> <span style="color: #a2b6da;">(</span>PRINC &#8217;D<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
         <span style="color: #b0b0b3;">(</span>#<span style="color: #f08080;">:G606</span> #<span style="color: #f08080;">:G607</span> #<span style="color: #f08080;">:G608</span> #<span style="color: #f08080;">:G609</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span>T
     <span style="color: #97b098;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #aebed8;">(</span>#<span style="color: #f08080;">:G607</span> #<span style="color: #f08080;">:G608</span> #<span style="color: #f08080;">:G609</span><span style="color: #aebed8;">)</span>
       <span style="color: #aebed8;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #b0b0b3;">(</span><span style="color: #90a890;">(</span>#<span style="color: #f08080;">:G608</span> <span style="color: #a2b6da;">(</span>PRINC &#8217;E<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span> <span style="color: #90a890;">(</span>#<span style="color: #f08080;">:G609</span> <span style="color: #a2b6da;">(</span>PRINC &#8217;F<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
         <span style="color: #b0b0b3;">(</span>#<span style="color: #f08080;">:G606</span> #<span style="color: #f08080;">:G607</span> #<span style="color: #f08080;">:G608</span> #<span style="color: #f08080;">:G609</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>



<p>
实现思路:
将cond绑定里的变量去重解析出来，每个变量分配一个gensym，求值主体放到一个labels函数里求值，
根据不同的情况给这个函数传入不同参数。
考虑到未绑定变量需要取nil值，那么采用两次let绑定，第一层全绑定nil, 第二层根据条件覆盖相应绑定，然后再给函数传参求值。
</p>

<p>
心得：像这种含有临时变量绑定的宏编写，需要将临时变量定义成gensym
</p>
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23450;&#20041;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">condlet</span> <span style="color: #93a8c6;">(</span>clauses <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>bodfn <span style="color: #aebed8;">(</span>gensym<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">here vars is like ((Y . #:G613) (X . #:G614) (Z . #:G615))</span>
        <span style="color: #97b098;">(</span>vars <span style="color: #aebed8;">(</span>mapcar #'<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">(</span>v<span style="color: #90a890;">)</span> <span style="color: #90a890;">(</span>cons v <span style="color: #a2b6da;">(</span>gensym<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span> <span style="color: #b0b0b3;">(</span>remove-duplicates
                                                   <span style="color: #90a890;">(</span>mapcar #'car
                                                           <span style="color: #a2b6da;">(</span>mappend #'cdr clauses<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
<span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>,bodfn ,<span style="color: #b0b0b3;">(</span>mapcar #'car vars<span style="color: #b0b0b3;">)</span>
                ,@body<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span><span style="color: #00bfff;">cond</span> ,@<span style="color: #aebed8;">(</span>mapcar #'<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">(</span>cl<span style="color: #90a890;">)</span>
                           <span style="color: #90a890;">(</span>condlet-clause vars cl bodfn<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>  <span style="color: #7f7f7f;">; &#30001;&#20110;&#29983;&#25104;&#27599;&#20010;&#23376;&#34920;&#36798;&#24335;&#38500;&#20102;clauses&#19981;&#22815;&#65292;&#36824;&#35201;vars bodfn, &#25152;&#20197;&#29992;&#20010;&#38381;&#21253;&#23558;&#23427;&#20204;&#24341;&#20837;</span>
                       clauses<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20316;&#29992;&#65306;&#29983;&#20135;&#23545;&#24212;cond &#35821;&#21477;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">condlet-clause</span> <span style="color: #93a8c6;">(</span>vars cl bodfn<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span>,<span style="color: #b0b1a3;">(</span>car cl<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> ,<span style="color: #97b098;">(</span>mapcar #'cdr vars<span style="color: #97b098;">)</span>
                <span style="color: #97b098;">(</span><span style="color: #00bfff;">let</span> ,<span style="color: #aebed8;">(</span>condlet-binds vars cl<span style="color: #aebed8;">)</span>
                  <span style="color: #aebed8;">(</span>,bodfn ,@<span style="color: #b0b0b3;">(</span>mapcar #'cdr vars<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20316;&#29992;&#65306;&#23558;&#34920;&#36798;&#24335;&#20013;&#30340;&#21464;&#37327;&#32465;&#23450;&#65292;&#26367;&#25442;&#20026;&#23545;&#23545;&#24212;gensym&#30340;&#32465;&#23450;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(condlet-binds '((Y . #:G613) (X . #:G614) (Z . #:G615)) '((= 1 2) (x (princ &#8217;a)) (y (princ &#8217;b))))</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">=&gt;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">((#:G614 (PRINC &#8217;A)) (#:G613 (PRINC &#8217;B)))</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">condlet-binds</span> <span style="color: #93a8c6;">(</span>vars cl<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>mapcar #'<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #97b098;">(</span>bindform<span style="color: #97b098;">)</span>
              <span style="color: #97b098;">(</span><span style="color: #00bfff;">if</span> <span style="color: #aebed8;">(</span>consp bindform<span style="color: #aebed8;">)</span>
                  <span style="color: #aebed8;">(</span>cons <span style="color: #b0b0b3;">(</span>cdr <span style="color: #90a890;">(</span>assoc <span style="color: #a2b6da;">(</span>car bindform<span style="color: #a2b6da;">)</span> vars<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                        <span style="color: #b0b0b3;">(</span>cdr bindform<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
          <span style="color: #b0b1a3;">(</span>cdr cl<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20316;&#29992;:&#23558;fn&#24212;&#29992;&#21040;lsts&#23376;&#39033;&#65292;&#20877;&#38750;&#30772;&#22351;&#36830;&#25509;&#36215;&#26469;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(((= 1 2) (X (PRINC &#8217;A)) (Y (PRINC &#8217;B)))</span>
<span style="color: #7f7f7f;">;;  </span><span style="color: #7f7f7f;">((= 1 1) (Y (PRINC &#8217;C)) (X (PRINC &#8217;D))) (T (X (PRINC &#8217;E)) (Z (PRINC &#8217;F))))</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">=&gt;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">((X (PRINC &#8217;A)) (Y (PRINC &#8217;B)) (Y (PRINC &#8217;C)) (X (PRINC &#8217;D)) (X (PRINC &#8217;E))</span>
<span style="color: #7f7f7f;">;;                 </span><span style="color: #7f7f7f;">(Z (PRINC &#8217;F)))</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">mappend</span> <span style="color: #93a8c6;">(</span>fn <span style="color: #98f5ff;">&amp;rest</span> lsts<span style="color: #93a8c6;">)</span>
  <span style="color: #ffe4b5;">"maps elements in list and finally appends all resulted lists."</span>
  <span style="color: #93a8c6;">(</span>apply #'append <span style="color: #b0b1a3;">(</span>apply #'mapcar fn lsts<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf7d34db" class="outline-3">
<h3 id="orgf7d34db"><span class="section-number-3">13.2</span> with- 宏</h3>
<div class="outline-text-3" id="text-13-2">
<p>
只要一个操作符需要让求值的form在新的上下文求值，那久应该将它定义成宏。比如 <code>ignore-errors</code> 宏，使参数像在一个 <code>progn</code> 里求值，但不管什么地方出了错，整体返回nil。
</p>

<p>
像 <code>with-open-file</code> 宏展开式包含一个 <code>unwind-protect</code> ，确保打开的文件的关闭。
</p>
</div>
</div>
<div id="outline-container-orgec2a9c3" class="outline-3">
<h3 id="orgec2a9c3"><span class="section-number-3">13.3</span> 条件求值</h3>
<div class="outline-text-3" id="text-13-3">
<p>
有时候需要让宏调用的参数在一定条件下求值，其它不求值，这时候就超出了函数的能力。虽然像 <code>if</code> , <code>and</code> 和 <code>cond</code> 这些内置操作符在“短路”的情况下可以避免对参数求值。但使用宏使更加强大。
</p>

<p>
下面这个宏 <code>in</code> 是用来检测元素是否在集合中，但可以避免一次性将集合中元素都求值。
比如想检测表达式 <code>(foo)</code> 的值是不是在表达式 <code>(bar)</code> 和 <code>(baz)</code> 之间，我们可以这样：
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span>member <span style="color: #93a8c6;">(</span>foo<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>list <span style="color: #b0b1a3;">(</span>bar<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>baz<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
但这种效率差些，因为首先它将 (bar) 和 (baz) 结果连接成列表，
其次如果 <code>(bar)</code> 的结果和 <code>(foo)</code> 相等，那就没必要求值 <code>(baz)</code> ，
所以可以写一个 <code>in</code> 宏，利用 <code>or</code> 的短路特性和宏对于参数的可控制求值：
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">in</span> <span style="color: #93a8c6;">(</span>obj <span style="color: #98f5ff;">&amp;rest</span> choices<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>g <span style="color: #aebed8;">(</span>gensym<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>,g ,obj<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span>or ,@<span style="color: #aebed8;">(</span>mapcar <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">(</span>x<span style="color: #90a890;">)</span> `<span style="color: #90a890;">(</span>eql ,g ,x<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                     choices<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
变形1：
<code>inq</code> 是 <code>in</code> 的引用变形，类似于 <code>setq</code> 之于 <code>set</code> 。将 <code>&amp;rest</code> 参数都当成symbol来看待。
</p>


<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">inq</span> <span style="color: #93a8c6;">(</span>obj <span style="color: #98f5ff;">&amp;rest</span> choices<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span>in ,obj ,@<span style="color: #b0b1a3;">(</span>mapcar <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>c<span style="color: #aebed8;">)</span> `',c<span style="color: #97b098;">)</span> choices<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
这样
</p>
<pre class="example">
(inq operator + - *)

;;展开成
(in operator '+ '- '*)


(inq some-symbol a b c)

;; 展开成
(in some-symbol 'a 'b 'c)

</pre>

<p>
变形2：
<code>in</code> 默认采用 <code>eql</code> 求值， 如果需要其它求值条件或某个一元函数，那么可用下面这个更通用的 <code>in-if</code> :
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">in-if</span> <span style="color: #93a8c6;">(</span>fn <span style="color: #98f5ff;">&amp;rest</span> choices<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span>or ,@<span style="color: #b0b1a3;">(</span>mapcar <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x<span style="color: #aebed8;">)</span> `<span style="color: #aebed8;">(</span>funcall ,fn ,x<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
                 choices<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
</pre>
</div>

<p>
这样像
</p>
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #8c8c8c;">(</span>member x <span style="color: #93a8c6;">(</span>list a b<span style="color: #93a8c6;">)</span> <span style="color: #f08080;">:test</span> #'equal<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21487;&#20197;&#20889;&#25104;</span>

<span style="color: #8c8c8c;">(</span>in-if #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span>y<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>equal x y<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span> a b<span style="color: #8c8c8c;">)</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span>some #'oddp <span style="color: #93a8c6;">(</span>list a b<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span>in-if #'oddp a b<span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
<code>in-if</code> 之于 <code>some</code> 好比 <code>in</code> 之于 <code>member</code> 。
<code>in-if</code> 相比于 <code>some</code> 不需要将要比较的元素cons，而且不用事先求值。
</p>
</div>
</div>
<div id="outline-container-orgdd1ad33" class="outline-3">
<h3 id="orgdd1ad33"><span class="section-number-3">13.4</span> 迭代</h3>
<div class="outline-text-3" id="text-13-4">
<p>
用do宏演变出其它语言中常见循环模式: <code>while</code> , <code>till</code> , <code>for</code>
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">while</span> <span style="color: #93a8c6;">(</span>test <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">do</span> <span style="color: #b0b1a3;">()</span>
       <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>not ,test<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     ,@body<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">till</span> <span style="color: #93a8c6;">(</span>test <span style="color: #98f5ff;">&amp;body</span>  body<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">do</span> <span style="color: #b0b1a3;">()</span>
       <span style="color: #b0b1a3;">(</span>,test<span style="color: #b0b1a3;">)</span>
     ,@body<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">for</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>var start stop<span style="color: #b0b1a3;">)</span> <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">with-gensyms</span> <span style="color: #b0b1a3;">(</span>gstop<span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">do</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>,var ,start <span style="color: #b0b0b3;">(</span>1+ ,var<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span>,gstop ,stop<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
         <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>&gt; ,var ,gstop<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       ,@body<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>


<p>
两个比 <code>dolist</code> 更一般的宏：两者在求值主体时绑定一组变量到一个列表中的相继的子序列上,
</p>


<div class="org-src-container">
<pre class="src src-lisp">CL-USER&gt; <span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">do-tuples/o</span> <span style="color: #93a8c6;">(</span>x y z<span style="color: #93a8c6;">)</span> '<span style="color: #93a8c6;">(</span>a b c d e f g<span style="color: #93a8c6;">)</span>
           <span style="color: #93a8c6;">(</span>princ <span style="color: #b0b1a3;">(</span>list x y z<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>A B C<span style="color: #8c8c8c;">)(</span>B C D<span style="color: #8c8c8c;">)(</span>C D E<span style="color: #8c8c8c;">)(</span>D E F<span style="color: #8c8c8c;">)(</span>E F G<span style="color: #8c8c8c;">)</span>
NIL


CL-USER&gt; <span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">do-tuples/c</span> <span style="color: #93a8c6;">(</span>x y z<span style="color: #93a8c6;">)</span> '<span style="color: #93a8c6;">(</span>a b c d e f g<span style="color: #93a8c6;">)</span>
           <span style="color: #93a8c6;">(</span>princ <span style="color: #b0b1a3;">(</span>list x y z<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>A B C<span style="color: #8c8c8c;">)(</span>B C D<span style="color: #8c8c8c;">)(</span>C D E<span style="color: #8c8c8c;">)(</span>D E F<span style="color: #8c8c8c;">)(</span>E F G<span style="color: #8c8c8c;">)(</span>F G A<span style="color: #8c8c8c;">)(</span>G A B<span style="color: #8c8c8c;">)</span>
NIL
</pre>
</div>

<p>
其中 <code>do-tuples/o</code> 是开放的，当最后一个变量到达绑定的列表结尾便停止，
而 <code>do-tuples/c</code> 会继续直到第一个变量达到结尾。宏的定义如下：
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">do-tuples/o</span> <span style="color: #93a8c6;">(</span>parms source <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> parms
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>src <span style="color: #b0b0b3;">(</span>gensym<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        `<span style="color: #97b098;">(</span><span style="color: #00bfff;">prog</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>,src ,source<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
            <span style="color: #aebed8;">(</span>mapc <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> ,parms ,@body<span style="color: #b0b0b3;">)</span>
                  ,@<span style="color: #b0b0b3;">(</span>map0-n <span style="color: #90a890;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #a2b6da;">(</span>n<span style="color: #a2b6da;">)</span>
                              `<span style="color: #a2b6da;">(</span>nthcdr ,n ,src<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                            <span style="color: #90a890;">(</span>1- <span style="color: #a2b6da;">(</span>length parms<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Here is a limit in the macro,</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">length of parms should &lt;= length of source * 2</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">do-tuples/c</span> <span style="color: #93a8c6;">(</span>parms source <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> parms
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>src <span style="color: #b0b0b3;">(</span>gensym<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        `<span style="color: #97b098;">(</span><span style="color: #00bfff;">prog</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>,src ,source<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
            <span style="color: #aebed8;">(</span>mapc <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> ,parms ,@body<span style="color: #b0b0b3;">)</span>
                  ,@<span style="color: #b0b0b3;">(</span>map0-n <span style="color: #90a890;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #a2b6da;">(</span>n<span style="color: #a2b6da;">)</span>
                              `<span style="color: #a2b6da;">(</span>append <span style="color: #9cb6ad;">(</span>nthcdr ,n ,src<span style="color: #9cb6ad;">)</span> <span style="color: #9cb6ad;">(</span>subseq ,src 0 ,n<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                            <span style="color: #90a890;">(</span>1- <span style="color: #a2b6da;">(</span>length parms<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


</pre>
</div>

<p>
这里采用的技巧是 <code>mapc</code> 接受的 <code>fn</code> 的参数得和 <code>mapc</code> 接受的lists参数个数一样，而且fn的参数从各个列表中依次取值，
所以通过控制mapc的参数lists，来控制迭代进行的次数。
</p>
</div>
</div>
<div id="outline-container-orgcc581ce" class="outline-3">
<h3 id="orgcc581ce"><span class="section-number-3">13.5</span> 多值迭代</h3>
<div class="outline-text-3" id="text-13-5">
<p>
通常的do和do*宏在绑定变量时是单值绑定的，比如：
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">do*</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>x 1 <span style="color: #97b098;">(</span>1+ x<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>y 0 z<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>z 0 x<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
     <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>&gt; x 5<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>list x y z<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>princ <span style="color: #b0b1a3;">(</span>list x y z<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
但有时候多值绑定的do会更清晰实用，比如上面的y,z其实是成对更新的，这时候需要一个支持多值绑定的mvdo*
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span>mvdo* <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>x 1 <span style="color: #97b098;">(</span>1+ x<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
        <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>y z<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>values 0 0<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>values z x<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
    <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>&gt; x 5<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>list x y z<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>princ <span style="color: #b0b1a3;">(</span>list x y z<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
</pre>
</div>
</div>

<div id="outline-container-orgac183e8" class="outline-4">
<h4 id="orgac183e8"><span class="section-number-4">13.5.1</span> mvdo*</h4>
<div class="outline-text-4" id="text-13-5-1">
<p>
mvdo*的实现如下，其模仿do*宏的实现，采用 <code>prog</code>, <code>go label</code> 的展开形式。
其采用两个函数帮忙展开宏，其中一个函数(<code>mvdo-gen</code>)主要处理外层的初始绑定，测试和执行主体,
然后调用另一个函数(<code>mvdo-rebind-gen</code>)来处理每次循环值的更新。
</p>

<p>
这两个函数都采用递归的模式来处理多组参数需要绑定的情况，调用自身来嵌套或者连接。
</p>

<p>
宏的展开效果如下：
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span>mvdo* <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>x 1 <span style="color: #97b098;">(</span>1+ x<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
        <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>y z<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>values 0 0<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>values z x<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
    <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>&gt; x 5<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>list x y z<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>princ <span style="color: #b0b1a3;">(</span>list x y z<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23637;&#24320;&#25104;&#65306;</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>X 1<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">MULTIPLE-VALUE-BIND</span> <span style="color: #b0b1a3;">(</span>Y Z<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>VALUES 0 0<span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">PROG</span> <span style="color: #97b098;">()</span>
       #<span style="color: #f08080;">:G593</span>
       <span style="color: #97b098;">(</span><span style="color: #00bfff;">IF</span> <span style="color: #aebed8;">(</span>&gt; X 5<span style="color: #aebed8;">)</span>
           <span style="color: #aebed8;">(</span><span style="color: #00bfff;">RETURN</span> <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">PROGN</span> <span style="color: #90a890;">(</span>LIST X Y Z<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span>PRINC <span style="color: #aebed8;">(</span>LIST X Y Z<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span>SETQ X <span style="color: #aebed8;">(</span>1+ X<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span>MULTIPLE-VALUE-SETQ <span style="color: #aebed8;">(</span>Y Z<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>VALUES Z X<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span><span style="color: #00bfff;">GO</span> #<span style="color: #f08080;">:G593</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
</pre>
</div>

<p>
实现的具体分析可以参看注释：
</p>
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">mvdo*</span> <span style="color: #93a8c6;">(</span>parm-cl test-cl <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>mvdo-gen parm-cl parm-cl test-cl body<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span> <span style="color: #7f7f7f;">; Use function to help generate code</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">This function is mainly used as generate bind nested form, with recursive call self.</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">And pass rebind generate task to `mvdo-rebind-gen` function</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">mvdo-gen</span> <span style="color: #93a8c6;">(</span>binds rebinds test body<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null binds<span style="color: #b0b1a3;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">recursive function, incase this is the last call, so binds is null while rebinds is not.</span>
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>label <span style="color: #b0b0b3;">(</span>gensym<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        `<span style="color: #97b098;">(</span><span style="color: #00bfff;">prog</span> <span style="color: #aebed8;">()</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Just like `do` macro, it expand mvdo* to `prog` form, use `go` to loop</span>
            ,label
            <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> ,<span style="color: #b0b0b3;">(</span>car test<span style="color: #b0b0b3;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">test test-case here</span>
                <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">return</span> <span style="color: #90a890;">(</span><span style="color: #00bfff;">progn</span> ,@<span style="color: #a2b6da;">(</span>cdr test<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">use `progn` here in case of list of clauses</span>
            ,@body <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">loop body</span>
            ,@<span style="color: #aebed8;">(</span>mvdo-rebind-gen rebinds<span style="color: #aebed8;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">As init binding has done, let's generate rebind form, use function to help</span>
            <span style="color: #aebed8;">(</span><span style="color: #00bfff;">go</span> ,label<span style="color: #aebed8;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">use `go label` to loop</span>
            <span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>rec <span style="color: #b0b0b3;">(</span>mvdo-gen <span style="color: #90a890;">(</span>cdr binds<span style="color: #90a890;">)</span> rebinds test body<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">recursive call self, put result in rec</span>
        <span style="color: #97b098;">(</span><span style="color: #00bfff;">let</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>var/s <span style="color: #90a890;">(</span>caar binds<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span>expr <span style="color: #90a890;">(</span>cadar binds<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b0b3;">(</span>atom var/s<span style="color: #b0b0b3;">)</span>            <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">check the init-form is single value or multi value</span>
              `<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #90a890;">(</span><span style="color: #a2b6da;">(</span>,var/s ,expr<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">single value case</span>
                 ,rec<span style="color: #b0b0b3;">)</span>
              `<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">multiple-value-bind</span> ,var/s ,expr  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">multi value case</span>
                 ,rec<span style="color: #b0b0b3;">)</span>
              <span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">This is also a recursive function. once handle a bind.</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">mvdo-rebind-gen</span> <span style="color: #93a8c6;">(</span>rebinds<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">cond</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>null rebinds<span style="color: #97b098;">)</span> nil<span style="color: #b0b1a3;">)</span>
        <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>&lt; <span style="color: #aebed8;">(</span>length <span style="color: #b0b0b3;">(</span>car rebinds<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span> 3<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>mvdo-rebind-gen <span style="color: #aebed8;">(</span>cdr rebinds<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">the rebind don't have step-form, so just call next cyle</span>
        <span style="color: #b0b1a3;">(</span>t <span style="color: #97b098;">(</span>cons  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">use `cons` to connect all generated-rebind-forms as a list</span>
            <span style="color: #aebed8;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b0b3;">(</span><span style="color: #90a890;">(</span>var/s <span style="color: #a2b6da;">(</span>caar rebinds<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                  <span style="color: #90a890;">(</span>expr <span style="color: #a2b6da;">(</span>caddar rebinds<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">if</span> <span style="color: #90a890;">(</span>atom var/s<span style="color: #90a890;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">check the init-form is single value or multi value</span>
                  `<span style="color: #90a890;">(</span>setq ,var/s ,expr<span style="color: #90a890;">)</span>
                  `<span style="color: #90a890;">(</span>multiple-value-setq ,var/s ,expr<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
            <span style="color: #aebed8;">(</span>mvdo-rebind-gen <span style="color: #b0b0b3;">(</span>cdr rebinds<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">call self recursively</span>
            <span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


</pre>
</div>
</div>
</div>

<div id="outline-container-orgcf5561a" class="outline-4">
<h4 id="orgcf5561a"><span class="section-number-4">13.5.2</span> mvdo</h4>
<div class="outline-text-4" id="text-13-5-2">
<p>
mvdo宏之于mvdo*就相当于let之于let*
</p>

<p>
mvdo宏的宏展开如下:
</p>

<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">mvdo example</span>
<span style="color: #8c8c8c;">(</span>mvdo <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>x 1 <span style="color: #97b098;">(</span>1+ x<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
       <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>y z<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>values 0 0<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>values z x<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
    <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>&gt; x 5<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>list x y z<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>princ <span style="color: #b0b1a3;">(</span>list x y z<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">; </span><span style="color: #7f7f7f;">macro expand to:</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span>#<span style="color: #f08080;">:G642</span> #<span style="color: #f08080;">:G643</span> #<span style="color: #f08080;">:G644</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>MVPSETQ #<span style="color: #f08080;">:G642</span> 1 <span style="color: #b0b1a3;">(</span>#<span style="color: #f08080;">:G643</span> #<span style="color: #f08080;">:G644</span><span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>VALUES 0 0<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">PROG</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>X #<span style="color: #f08080;">:G642</span><span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>Y #<span style="color: #f08080;">:G643</span><span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>Z #<span style="color: #f08080;">:G644</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     #<span style="color: #f08080;">:G641</span>
     <span style="color: #b0b1a3;">(</span>PRINC <span style="color: #97b098;">(</span>LIST X Y Z<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">IF</span> <span style="color: #97b098;">(</span>&gt; X 5<span style="color: #97b098;">)</span>
         <span style="color: #97b098;">(</span><span style="color: #00bfff;">RETURN</span> <span style="color: #aebed8;">(</span><span style="color: #00bfff;">PROGN</span> <span style="color: #b0b0b3;">(</span>LIST X Y Z<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     <span style="color: #b0b1a3;">(</span>MVPSETQ X <span style="color: #97b098;">(</span>1+ X<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>Y Z<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>VALUES Z X<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">GO</span> #<span style="color: #f08080;">:G641</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


</pre>
</div>

<p>
不同于mvdo*, mvdo需要一次性将参数初始form提取出来，采用mvpsetq初始赋值， 这样防止参数赋值前后顺序影响，
</p>

<p>
另外, 由于含有多值赋值，所以需要用到psetq的多值版本mvpsetq(其实现下面有）。
</p>

<p>
同样的，原来的rebind form采用多个 setq/multiple-value-bind 前后依次更新值，现在也需要mvpsetq 来并行更新值了
所以整体就没有递归调用生成了，因为不需要嵌套了
</p>

<p>
我的实现:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">mvdo</span> <span style="color: #93a8c6;">(</span>parm-cl test-cl <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let*</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>label <span style="color: #aebed8;">(</span>gensym<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
         <span style="color: #97b098;">(</span>let-cl '<span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">form like:  #:G593 #:G594 #:G595</span>
         <span style="color: #97b098;">(</span>mvsetq-cl '<span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">form like:  #:G593 1 (#:G594 #:G595) (values 0 0)</span>
         <span style="color: #97b098;">(</span>prog-cl '<span style="color: #aebed8;">()</span><span style="color: #97b098;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">form like:  (X #:G593) (Y #:G594) (Z #:G595)</span>
         <span style="color: #b0b1a3;">)</span>
    <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Use a loop to generate three main clauses for macro</span>
    <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">when generate gensym, the push it to different clauses according to different require</span>
    <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">use loop with it's side effect</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">loop</span> <span style="color: #f08080;">:for</span> each <span style="color: #f08080;">:in</span> parm-cl
          <span style="color: #f08080;">:do</span> <span style="color: #97b098;">(</span><span style="color: #00bfff;">if</span> <span style="color: #aebed8;">(</span>listp <span style="color: #b0b0b3;">(</span>first each<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
                  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">((y z) (values 0 0) -&gt; (values z x)) (y z) -&gt; ((y #:g1) (z #:g2))</span>
                  <span style="color: #aebed8;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b0b3;">(</span><span style="color: #90a890;">(</span>var-g-pair-list <span style="color: #a2b6da;">(</span>mapcar #'<span style="color: #9cb6ad;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #8c8c8c;">(</span>x<span style="color: #8c8c8c;">)</span> <span style="color: #8c8c8c;">(</span>list x <span style="color: #93a8c6;">(</span>gensym<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span> <span style="color: #9cb6ad;">(</span>first each<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                    <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">construct let-cl</span>
                    <span style="color: #b0b0b3;">(</span>mapcar #'<span style="color: #90a890;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #a2b6da;">(</span>p<span style="color: #a2b6da;">)</span> <span style="color: #a2b6da;">(</span>push <span style="color: #9cb6ad;">(</span>second p<span style="color: #9cb6ad;">)</span> let-cl<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span> var-g-pair-list<span style="color: #b0b0b3;">)</span>
                    <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">construct mvsetq-cl</span>
                    <span style="color: #b0b0b3;">(</span>push <span style="color: #90a890;">(</span>mapcar #'second  var-g-pair-list<span style="color: #90a890;">)</span> mvsetq-cl<span style="color: #b0b0b3;">)</span>
                    <span style="color: #b0b0b3;">(</span>push <span style="color: #90a890;">(</span>second each<span style="color: #90a890;">)</span> mvsetq-cl<span style="color: #b0b0b3;">)</span>
                    <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">construct prog-cl</span>
                    <span style="color: #b0b0b3;">(</span>mapcar #'<span style="color: #90a890;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #a2b6da;">(</span>p<span style="color: #a2b6da;">)</span> <span style="color: #a2b6da;">(</span>push p prog-cl<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span> var-g-pair-list<span style="color: #b0b0b3;">)</span>
                    <span style="color: #aebed8;">)</span>
                  <span style="color: #aebed8;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b0b3;">(</span><span style="color: #90a890;">(</span>g <span style="color: #a2b6da;">(</span>gensym<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                    <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">construct let-cl</span>
                    <span style="color: #b0b0b3;">(</span>push g let-cl<span style="color: #b0b0b3;">)</span>
                    <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">construct mvsetq-cl</span>
                    <span style="color: #b0b0b3;">(</span>push g mvsetq-cl<span style="color: #b0b0b3;">)</span>
                    <span style="color: #b0b0b3;">(</span>push <span style="color: #90a890;">(</span>second each<span style="color: #90a890;">)</span> mvsetq-cl<span style="color: #b0b0b3;">)</span>
                    <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">construct prog-cl</span>
                    <span style="color: #b0b0b3;">(</span>push <span style="color: #90a890;">(</span>list <span style="color: #a2b6da;">(</span>first each<span style="color: #a2b6da;">)</span> g<span style="color: #90a890;">)</span> prog-cl<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
          <span style="color: #f08080;">:finally</span> <span style="color: #97b098;">(</span><span style="color: #00bfff;">progn</span>
                     <span style="color: #aebed8;">(</span>setf let-cl <span style="color: #b0b0b3;">(</span>nreverse let-cl<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
                     <span style="color: #aebed8;">(</span>setf mvsetq-cl <span style="color: #b0b0b3;">(</span>nreverse mvsetq-cl<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
                     <span style="color: #aebed8;">(</span>setf prog-cl <span style="color: #b0b0b3;">(</span>nreverse prog-cl<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>

    <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">just use the *-cl generated above</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span>,@let-cl<span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span>mvpsetq ,@mvsetq-cl<span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span><span style="color: #00bfff;">prog</span> <span style="color: #aebed8;">(</span>,@prog-cl<span style="color: #aebed8;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">TODO init bind</span>
          ,label
          <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> ,<span style="color: #b0b0b3;">(</span>car test-cl<span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">return</span> <span style="color: #90a890;">(</span><span style="color: #00bfff;">progn</span> ,@<span style="color: #a2b6da;">(</span>cdr test-cl<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
          ,@body
          <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">construct rebind form here, because it has no relation to gensyms.</span>
          <span style="color: #aebed8;">(</span>mvpsetq ,@<span style="color: #b0b0b3;">(</span>flatten-1
                      <span style="color: #90a890;">(</span>mapcar #'<span style="color: #a2b6da;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #9cb6ad;">(</span>p<span style="color: #9cb6ad;">)</span>
                                  <span style="color: #9cb6ad;">(</span><span style="color: #00bfff;">when</span> <span style="color: #8c8c8c;">(</span>third p<span style="color: #8c8c8c;">)</span>
                                    <span style="color: #8c8c8c;">(</span>list <span style="color: #93a8c6;">(</span>first p<span style="color: #93a8c6;">)</span>
                                          <span style="color: #93a8c6;">(</span>third p<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span>
                              parm-cl<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span><span style="color: #00bfff;">go</span> ,label<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>



</pre>
</div>


<p>
onlisp书上的实现:
</p>
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">mvdo</span> <span style="color: #93a8c6;">(</span>binds <span style="color: #b0b1a3;">(</span>test <span style="color: #98f5ff;">&amp;rest</span> result<span style="color: #b0b1a3;">)</span> <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>label <span style="color: #aebed8;">(</span>gensym<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span>temps <span style="color: #aebed8;">(</span>mapcar #'<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">(</span>b<span style="color: #90a890;">)</span>
                           <span style="color: #90a890;">(</span><span style="color: #00bfff;">if</span> <span style="color: #a2b6da;">(</span>listp <span style="color: #9cb6ad;">(</span>car b<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span>
                               <span style="color: #a2b6da;">(</span>mapcar #'<span style="color: #9cb6ad;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #8c8c8c;">(</span>x<span style="color: #8c8c8c;">)</span>
                                           <span style="color: #8c8c8c;">(</span>gensym<span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span>
                                       <span style="color: #9cb6ad;">(</span>car b<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span>
                               <span style="color: #a2b6da;">(</span>gensym<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                       binds<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">temps like (#:G617 (#:G618 #:G619)), transfer binds to gensym symbols</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> ,<span style="color: #97b098;">(</span>mappend #'ensure-list temps<span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span>mvpsetq ,@<span style="color: #aebed8;">(</span>mapcan #'<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">(</span>b var<span style="color: #90a890;">)</span>
                              <span style="color: #90a890;">(</span>list var <span style="color: #a2b6da;">(</span>cadr b<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                          binds
                          temps<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span><span style="color: #00bfff;">prog</span> ,<span style="color: #aebed8;">(</span>mapcar #'<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">(</span>b var<span style="color: #90a890;">)</span> <span style="color: #90a890;">(</span>list b var<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">mapcar &#23558;&#19979;&#38754;&#20004;&#20010;&#21015;&#34920;&#19968;&#19968;&#37197;&#23545;</span>
               <span style="color: #b0b0b3;">(</span>mappend #'ensure-list <span style="color: #90a890;">(</span>mapcar 'car binds<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23558;&#25152;&#26377;&#30340;&#21021;&#22987;&#21464;&#37327;&#23637;&#24179;</span>
               <span style="color: #b0b0b3;">(</span>mappend #'ensure-list temps<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23558;&#25152;&#26377;&#30340;temps&#23637;&#24179;</span>
          ,label
          <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> ,test
              <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">return</span> <span style="color: #90a890;">(</span><span style="color: #00bfff;">progn</span> ,@result<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
          ,@body
          <span style="color: #aebed8;">(</span>mvpsetq ,@<span style="color: #b0b0b3;">(</span>mapcan #'<span style="color: #90a890;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #a2b6da;">(</span>b<span style="color: #a2b6da;">)</span>
                                 <span style="color: #a2b6da;">(</span><span style="color: #00bfff;">if</span> <span style="color: #9cb6ad;">(</span>third b<span style="color: #9cb6ad;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21028;&#26029;&#26159;&#21542;&#26377;&#26356;&#26032;&#30340;&#34920;&#36798;&#24335;,&#26469;&#20915;&#23450;&#26159;&#21542;&#29983;&#25104;</span>
                                     <span style="color: #9cb6ad;">(</span>list <span style="color: #8c8c8c;">(</span>car b<span style="color: #8c8c8c;">)</span>
                                           <span style="color: #8c8c8c;">(</span>third b<span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                             binds<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span><span style="color: #00bfff;">go</span> ,label<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>




</pre>
</div>

<p>
宏心得1：
</p>

<p>
上面两处的mapcan的使用相当于 <code>(flatten-1 (mapcar ... ))</code>. 更加简洁。
mapcar 是将结果用list连接，而mapcan是用nonc连接结果
</p>

<p>
宏心得2：
</p>

<p>
<code>(mappend #'ensure-list temps)</code> 目的是想把temps“压扁”一层,
相当于我这里定义的flatten-1, 将temps里的元素“上提”一层
</p>

<div class="org-src-container">
<pre class="src src-lisp">
CL-USER&gt; <span style="color: #8c8c8c;">(</span>flatten-1 '<span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>a b c<span style="color: #b0b1a3;">)</span> d <span style="color: #b0b1a3;">(</span>e <span style="color: #97b098;">(</span>f g<span style="color: #97b098;">)</span> h<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>i<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> i<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>A B C D E <span style="color: #93a8c6;">(</span>F G<span style="color: #93a8c6;">)</span> H <span style="color: #93a8c6;">(</span>I<span style="color: #93a8c6;">)</span> I<span style="color: #8c8c8c;">)</span>
CL-USER&gt; <span style="color: #8c8c8c;">(</span>mappend #'ensure-list '<span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>a b c<span style="color: #b0b1a3;">)</span> d <span style="color: #b0b1a3;">(</span>e <span style="color: #97b098;">(</span>f g<span style="color: #97b098;">)</span> h<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>i<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> i<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>A B C D E <span style="color: #93a8c6;">(</span>F G<span style="color: #93a8c6;">)</span> H <span style="color: #93a8c6;">(</span>I<span style="color: #93a8c6;">)</span> I<span style="color: #8c8c8c;">)</span>
</pre>
</div>

<p>
宏心得3：
</p>

<p>
onlisp书上面的解决方案与我的方案相比，更加简洁。充分利用了mapcar的函数可以接受多个参数的特性，
事先将gensyms生成好，但保持和binds同构，然后用mapcar/mapcan 接受同构的gensyms和binds
而我的解决方案是产生gensyms的同时构造不同用到的地方的语句结构(上面的例子有let-cl, mvpsetq-cl, prog-cl)
</p>
</div>
</div>



<div id="outline-container-org9288d58" class="outline-4">
<h4 id="org9288d58"><span class="section-number-4">13.5.3</span> mvpsetq</h4>
<div class="outline-text-4" id="text-13-5-3">
<p>
让我们看看mvdo依赖的 mvpsetq. mvpsetq是psetq的多值版本。
</p>

<p>
宏展开的效果:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;;</span><span style="color: #7f7f7f;">Macro expand example:</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>w 0<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>x 1<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>y 2<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>z 3<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>mvpsetq <span style="color: #b0b1a3;">(</span>w x x<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>values 'a 'b<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>y z<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>values w x<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>list w x y z<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>W 0<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>X 1<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>Y 2<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>Z 3<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">MULTIPLE-VALUE-BIND</span> <span style="color: #b0b1a3;">(</span>#<span style="color: #f08080;">:G592</span> #<span style="color: #f08080;">:G593</span> #<span style="color: #f08080;">:G594</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>VALUES 'A 'B<span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">MULTIPLE-VALUE-BIND</span> <span style="color: #97b098;">(</span>#<span style="color: #f08080;">:G595</span> #<span style="color: #f08080;">:G596</span><span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span>VALUES W X<span style="color: #97b098;">)</span>
      <span style="color: #97b098;">(</span>PSETQ W #<span style="color: #f08080;">:G592</span>
             X #<span style="color: #f08080;">:G593</span>
             X #<span style="color: #f08080;">:G594</span>
             Y #<span style="color: #f08080;">:G595</span>
             Z #<span style="color: #f08080;">:G596</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>LIST W X Y Z<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>



</pre>
</div>

<p>
我的实现
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">use gen-cl to generate expression, because I need use recursion for multiple-value-bind</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">gen-lst is used for collect generate gensyms for psetq use</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">mvpsetq</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span>gen-lst<span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span>gen-cl args args gen-lst<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">helper func for mvpsetq</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">gen-cl</span> <span style="color: #93a8c6;">(</span>bind-cls set-cls gen-lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null bind-cls<span style="color: #b0b1a3;">)</span>
      `<span style="color: #b0b1a3;">(</span>psetq ,@<span style="color: #97b098;">(</span>shuffle-1 <span style="color: #aebed8;">(</span>flatten-1 <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">loop</span> <span style="color: #f08080;">:for</span> x <span style="color: #f08080;">:in</span> set-cls <span style="color: #f08080;">:by</span> #'cddr <span style="color: #f08080;">:collect</span> x<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">the loop here is to collect ((w x) (values 'a 'b) (y z) (values w x)) -&gt; ((w x) (y z))</span>
                           gen-lst<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">generate`( psetq x1 v1 x2 v2)` expression</span>
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>g-lst <span style="color: #b0b0b3;">(</span>mapcar #'<span style="color: #90a890;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #a2b6da;">(</span>x<span style="color: #a2b6da;">)</span> <span style="color: #a2b6da;">(</span>gensym<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                           <span style="color: #90a890;">(</span>first bind-cls<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">generate list of gensyms for multiple-value-bind in this recursive</span>
        <span style="color: #97b098;">(</span><span style="color: #00bfff;">if</span> <span style="color: #aebed8;">(</span>listp <span style="color: #b0b0b3;">(</span>first bind-cls<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">let's decide use `multiple-value-bind` or `let` to bind</span>
            `<span style="color: #aebed8;">(</span><span style="color: #00bfff;">multiple-value-bind</span> ,g-lst
                 ,<span style="color: #b0b0b3;">(</span>second bind-cls<span style="color: #b0b0b3;">)</span>
               ,<span style="color: #b0b0b3;">(</span>gen-cl <span style="color: #90a890;">(</span>cddr bind-cls<span style="color: #90a890;">)</span> set-cls <span style="color: #90a890;">(</span>append gen-lst g-lst<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">recusively call self, accumlate genyms to gen-list, for latter psetq</span>
            `<span style="color: #aebed8;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b0b3;">(</span><span style="color: #90a890;">(</span><span style="color: #a2b6da;">(</span>first bind-cls<span style="color: #a2b6da;">)</span> ,<span style="color: #a2b6da;">(</span>second bind-cls<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
               ,<span style="color: #b0b0b3;">(</span>gen-cl <span style="color: #90a890;">(</span>cddr bind-cls<span style="color: #90a890;">)</span> set-cls <span style="color: #90a890;">(</span>append gen-lst g-lst<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">recusively call self, accumlate genyms to gen-list, for latter psetq</span>
            <span style="color: #97b098;">)</span>
        <span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">helper func, used to extract symbols need binding</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">ONLISP&gt; (flatten-1 '(1 (2) 3 (4 (5) 6)))</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(1 2 3 4 (5) 6)</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">flatten-1</span> <span style="color: #93a8c6;">(</span>l<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">loop</span> <span style="color: #f08080;">:with</span> result <span style="color: #f08080;">:=</span> '<span style="color: #b0b1a3;">()</span>
        <span style="color: #f08080;">:for</span> x <span style="color: #f08080;">:in</span> l
        <span style="color: #f08080;">:if</span> <span style="color: #b0b1a3;">(</span>listp x<span style="color: #b0b1a3;">)</span>
        <span style="color: #f08080;">:do</span> <span style="color: #b0b1a3;">(</span>setf result <span style="color: #97b098;">(</span>append result x<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
        <span style="color: #f08080;">:else</span>
        <span style="color: #f08080;">:do</span> <span style="color: #b0b1a3;">(</span>setf result <span style="color: #97b098;">(</span>append result <span style="color: #aebed8;">(</span>list x<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
        <span style="color: #f08080;">:finally</span> <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">return</span> result<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">helper func, used to create expression for psetq with a list of gensyms and a list of set symbols</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">ONLISP&gt; (shuffle-1 '(1 2 3) '(a b c))</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(1 A 2 B 3 C)</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">shuffle-1</span> <span style="color: #93a8c6;">(</span>l1 l2<span style="color: #93a8c6;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">name it shuffle-1 to escape shuffle fun in below, although they do same.</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span>result<span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span>mapcar #'<span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x y<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>push x result<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>push y result<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
            l1
            l2<span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span>nreverse result<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>



</pre>
</div>


<p>
onlisp书上的实现
</p>
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">mvpsetq</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let*</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>pairs <span style="color: #aebed8;">(</span>group args 2<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Group args to ( ((w x) (values 'a 'b))   ( (y z) (values w x))  )</span>
         <span style="color: #97b098;">(</span>syms <span style="color: #aebed8;">(</span>mapcar #'<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">(</span>p<span style="color: #90a890;">)</span>
                           <span style="color: #90a890;">(</span>mapcar #'<span style="color: #a2b6da;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #9cb6ad;">(</span>x<span style="color: #9cb6ad;">)</span> <span style="color: #9cb6ad;">(</span>gensym<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span> <span style="color: #a2b6da;">(</span>ensure-list <span style="color: #9cb6ad;">(</span>car p<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                       pairs<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Pregenerate '(gensym1 ...) for latter bind use</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>rec <span style="color: #b0b0b3;">(</span>ps ss<span style="color: #b0b0b3;">)</span>
               <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">if</span> <span style="color: #90a890;">(</span>null ps<span style="color: #90a890;">)</span>
                   `<span style="color: #90a890;">(</span>setq ,@<span style="color: #a2b6da;">(</span>mapcan #'<span style="color: #9cb6ad;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #8c8c8c;">(</span>p s<span style="color: #8c8c8c;">)</span> <span style="color: #8c8c8c;">(</span>shuffle-it <span style="color: #93a8c6;">(</span>ensure-list <span style="color: #b0b1a3;">(</span>car p<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span> s<span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span>
                                    pairs syms<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                   <span style="color: #90a890;">(</span><span style="color: #00bfff;">let</span> <span style="color: #a2b6da;">(</span><span style="color: #9cb6ad;">(</span>body <span style="color: #8c8c8c;">(</span>rec <span style="color: #93a8c6;">(</span>cdr ps<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>cdr ss<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">recursive call self, because we have Got the syms list , not like my-own solution, generate in each recursion.</span>
                     <span style="color: #a2b6da;">(</span><span style="color: #00bfff;">let</span> <span style="color: #9cb6ad;">(</span><span style="color: #8c8c8c;">(</span>var/s <span style="color: #93a8c6;">(</span>caar ps<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
                           <span style="color: #8c8c8c;">(</span>expr <span style="color: #93a8c6;">(</span>cadar ps<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span>
                       <span style="color: #9cb6ad;">(</span><span style="color: #00bfff;">if</span> <span style="color: #8c8c8c;">(</span>consp var/s<span style="color: #8c8c8c;">)</span>
                           `<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">multiple-value-bind</span> ,<span style="color: #93a8c6;">(</span>car ss<span style="color: #93a8c6;">)</span> ,expr
                              ,body<span style="color: #8c8c8c;">)</span>
                           `<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>,@<span style="color: #97b098;">(</span>car ss<span style="color: #97b098;">)</span> ,expr<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
                              ,body<span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
      <span style="color: #97b098;">(</span>rec pairs syms<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Rename to shuffle-it, avoid conflict with alexandria:shuffle</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">shuffle-it</span> <span style="color: #93a8c6;">(</span>x y<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">cond</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>null x<span style="color: #97b098;">)</span> y<span style="color: #b0b1a3;">)</span>
        <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>null y<span style="color: #97b098;">)</span> x<span style="color: #b0b1a3;">)</span>
        <span style="color: #b0b1a3;">(</span>t <span style="color: #97b098;">(</span>list* <span style="color: #aebed8;">(</span>car x<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>car y<span style="color: #aebed8;">)</span>
                  <span style="color: #aebed8;">(</span>shuffle-it <span style="color: #b0b0b3;">(</span>cdr x<span style="color: #b0b0b3;">)</span> <span style="color: #b0b0b3;">(</span>cdr y<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">group</span> <span style="color: #93a8c6;">(</span>source n<span style="color: #93a8c6;">)</span>
  <span style="color: #ffe4b5;">"Group source into each with n numbers of elements unless the last is not enough"</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">when</span> <span style="color: #b0b1a3;">(</span>&lt;= n 0<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span><span style="color: #ff0000;">error</span> <span style="color: #deb887;">"length not greater than zero"</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>rec <span style="color: #aebed8;">(</span>source acc<span style="color: #aebed8;">)</span>
             <span style="color: #aebed8;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b0b3;">(</span><span style="color: #90a890;">(</span>rest <span style="color: #a2b6da;">(</span>nthcdr n source<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
               <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">if</span> <span style="color: #90a890;">(</span>consp rest<span style="color: #90a890;">)</span>
                   <span style="color: #90a890;">(</span>rec rest <span style="color: #a2b6da;">(</span>cons <span style="color: #9cb6ad;">(</span>subseq source 0 n<span style="color: #9cb6ad;">)</span> acc<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                   <span style="color: #90a890;">(</span>nreverse <span style="color: #a2b6da;">(</span>cons source acc<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">if</span> source <span style="color: #97b098;">(</span>rec source nil<span style="color: #97b098;">)</span> nil<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org87d6242" class="outline-3">
<h3 id="org87d6242"><span class="section-number-3">13.6</span> 为什么需要宏</h3>
<div class="outline-text-3" id="text-13-6">
<p>
宏并不是保护参数免于求值的唯一方式，另一种方式是将它封装在闭包里。例如下面的例子
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">fnif</span> <span style="color: #93a8c6;">(</span>test then <span style="color: #98f5ff;">&amp;optional</span> else<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> test
      <span style="color: #b0b1a3;">(</span>funcall then<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">if</span> else <span style="color: #97b098;">(</span>funcall else<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
这样调用：
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">if</span> <span style="color: #93a8c6;">(</span>rich<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>go-sailing<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>rob-bank<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21487;&#20197;&#25913;&#20889;&#25104;&#65306;</span>
<span style="color: #8c8c8c;">(</span>fnif <span style="color: #93a8c6;">(</span>rich<span style="color: #93a8c6;">)</span> #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">()</span> go-sailing<span style="color: #93a8c6;">)</span> #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">()</span> rob-bank<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
</pre>
</div>

<p>
而内置函数 <code>mapc</code> 就是 <code>dolist</code> 的函数版本（尽管返回的参数不完全一样）:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">dolist</span> <span style="color: #93a8c6;">(</span>b bananas<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>peel b<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>eat b<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #8c8c8c;">(</span>mapc #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span>b<span style="color: #b0b1a3;">)</span>
          <span style="color: #b0b1a3;">(</span>peel b<span style="color: #b0b1a3;">)</span>
          <span style="color: #b0b1a3;">(</span>eat b<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
      bananas<span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
接下来这段引用自原书第11.6节：
</p>
<blockquote>
<p>
然而，迭代控制结构通常要做的工作会比简单的迭代更多，它们通常会把绑定和迭代合二为一。
使用函数的话，绑定操作会很有局限。
如果想把变量绑定到列表的后继元素上，那么用某种映射函数就可以。
但如果需求比这个更复杂，你就不得不写一个宏了。
</p>
</blockquote>
</div>
</div>
</div>
<div id="outline-container-orga8a97d2" class="outline-2">
<h2 id="orga8a97d2"><span class="section-number-2">14</span> 广义变量</h2>
<div class="outline-text-2" id="text-14">
</div>
<div id="outline-container-org63e0dce" class="outline-3">
<h3 id="org63e0dce"><span class="section-number-3">14.1</span> 定义和作用</h3>
<div class="outline-text-3" id="text-14-1">
<p>
内置 <code>setf</code> 宏是 <code>setq</code> 的推广形式，如果 <code>setf</code> 的第一个（在宏展开后）参数是个符号，那么setf会展开成setq，
但如果是个查询语句，那么会展开到对应的“断言”。比如下面的例子：
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">setf &#23637;&#24320;&#25104;&#20102;setq</span>
<span style="color: #8c8c8c;">(</span>setf lst '<span style="color: #93a8c6;">(</span>a b c<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span> =&gt; <span style="color: #8c8c8c;">(</span>SETQ LST '<span style="color: #93a8c6;">(</span>A B C<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">setf&#23637;&#24320;&#25104;&#20102;"&#26597;&#35810;&#35821;&#21477;"car&#23545;&#20110;&#30340;&#8220;&#26029;&#35328;&#35821;&#21477;&#8221;replca</span>
<span style="color: #8c8c8c;">(</span>setf <span style="color: #93a8c6;">(</span>car lst<span style="color: #93a8c6;">)</span> 'd<span style="color: #8c8c8c;">)</span> =&gt; <span style="color: #8c8c8c;">(</span>SB-KERNEL:%RPLACA LST 'D<span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
像上面从查询到断言的变换称为逆。
像常用的 <code>car</code>, <code>cdr</code>, <code>nth</code>, <code>aref</code>, <code>get</code>, <code>gethash</code> 以及由 <code>defstruct</code> 创建的访问函数都有预定义的“逆”。
</p>

<p>
而能充当setf第一个参数的表达式被称为“广义变量”。
</p>

<p>
<code>(setf x y)</code> 可以理解成“务必让x的求值结果为y”,
可以基于setf编写一些宏，来产生更简洁的程序。
</p>

<p>
比如说，我们想定义一个操作符 <code>toggle</code> ，它总是将它的第一个参数的值求反，
toggle类似setf，第一个参数可以是个广义变量。比如下面的例子:
</p>

<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>lst '<span style="color: #97b098;">(</span>a b c<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>toggle <span style="color: #b0b1a3;">(</span>car lst<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  lst<span style="color: #8c8c8c;">)</span>
=&gt;

<span style="color: #8c8c8c;">(</span>NIL B C<span style="color: #8c8c8c;">)</span>
</pre>
</div>

<p>
当我们尝试实现toggle的时候，如果只是简单的将其展开为对setf的调用，那么会遇到多重求值问题，
比如下面的定义:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">toggle</span> <span style="color: #93a8c6;">(</span>obj<span style="color: #93a8c6;">)</span>
   `<span style="color: #93a8c6;">(</span>setf ,obj <span style="color: #b0b1a3;">(</span>not ,obj<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
上面的宏对obj参数求值两次，如果obj参数有副作用，那么可能会产生意料之外的结果。
比如下面的例子, 原意是将第0个元素变成nil,
但因为incf的副作用，求值了两次，最后是将第0个元素设置成了第一个元素的反值，最后导致结果不正确。
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>lst '<span style="color: #97b098;">(</span>t nil t<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>i -1<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>toggle <span style="color: #b0b1a3;">(</span>nth <span style="color: #97b098;">(</span>incf i<span style="color: #97b098;">)</span> lst<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  lst<span style="color: #8c8c8c;">)</span>

=&gt; <span style="color: #8c8c8c;">(</span>t nil t<span style="color: #8c8c8c;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org70d9a08" class="outline-3">
<h3 id="org70d9a08"><span class="section-number-3">14.2</span> 宏 define-modify-macro</h3>
<div class="outline-text-3" id="text-14-2">
<p>
为了让这类问题容易些，common lisp提供了 <code>define-modify-macro</code> 宏来处理这类问题，
</p>

<p>
上面的toggle可以如下定义:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">define-modify-macro</span> <span style="color: #daa520;">toggle</span> <span style="color: #93a8c6;">()</span> not<span style="color: #8c8c8c;">)</span>
</pre>
</div>

<p>
第一个参数是被定义的宏名称， 第二个参数是被定义的宏在广义变量之后的附加参数，最后一个参数是个函数名称。
</p>

<p>
如果“不考虑副作用”， <code>define-modify-macro</code> 的展开可以理解成下面这样:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">define-modify-macro</span> <span style="color: #daa520;">name</span> lambda-list function [documentation]<span style="color: #8c8c8c;">)</span>
=&gt; name

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">name</span> <span style="color: #93a8c6;">(</span>reference . lambda-list<span style="color: #93a8c6;">)</span>
  documentation
  `<span style="color: #93a8c6;">(</span>setf ,reference
         <span style="color: #b0b1a3;">(</span>function ,reference ,arg1 ,arg2 ...<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>


<p>
为了使toggle更加通用，可以接受多个参数，类似setf 可以接受多个赋值的参数
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#23558;toggle&#23450;&#20041;&#25104;&#39034;&#24207;&#30340;&#25191;&#34892;toggle-2</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">toggle</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">progn</span>
     ,@<span style="color: #b0b1a3;">(</span>mapcar #'<span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x<span style="color: #aebed8;">)</span>
                   `<span style="color: #aebed8;">(</span>toggle-2 ,x<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
               args<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">define-modify-macro</span> <span style="color: #daa520;">toggle-2</span> <span style="color: #93a8c6;">()</span> not<span style="color: #8c8c8c;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org82100a6" class="outline-3">
<h3 id="org82100a6"><span class="section-number-3">14.3</span> 实用工具（一）</h3>
<div class="outline-text-3" id="text-14-3">
</div>
<div id="outline-container-org285157b" class="outline-4">
<h4 id="org285157b"><span class="section-number-4">14.3.1</span> allf, nilf, tf</h4>
<div class="outline-text-4" id="text-14-3-1">
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">allf &#23558;args&#30340;&#20540;&#30340;&#20540;&#37117;&#35774;&#32622;&#25104;val</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">allf</span> <span style="color: #93a8c6;">(</span>val <span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">with-gensyms</span> <span style="color: #b0b1a3;">(</span>v<span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>,v ,val<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span>setf ,@<span style="color: #aebed8;">(</span>mapcan #'<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">(</span>a<span style="color: #90a890;">)</span>
                           `<span style="color: #90a890;">(</span>,a ,v<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                       args<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">allf&#30340;&#29305;&#20363;&#65292;&#23558;&#21442;&#25968;&#30340;&#20540;&#37117;&#35774;&#32622;&#20026;nil</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">nilf</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span>allf nil ,@args<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">allf&#30340;&#29305;&#20363;&#65292;&#23558;&#21442;&#25968;&#30340;&#20540;&#37117;&#35774;&#32622;&#20026;t</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">tf</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span>allf t ,@args<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org352f5cf" class="outline-4">
<h4 id="org352f5cf"><span class="section-number-4">14.3.2</span> concf, conc1f, concnew</h4>
<div class="outline-text-4" id="text-14-3-2">
<p>
concf, conc1f, concnew 这三个宏是nconc的演化版，
</p>

<p>
nconc用于连接多个list并返回连接的结果,
该函数有副作用，会修改传给他的参数，并且副作用不是很可靠，看下面的例子：
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36890;&#24120;&#24773;&#20917;&#19979;&#20250;&#20462;&#25913;&#31532;&#19968;&#20010;&#21442;&#25968;&#20026;&#36830;&#25509;&#30340;&#20540;&#65292;&#23558;&#20854;&#36820;&#22238;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>l1 '<span style="color: #97b098;">(</span>a b c<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>l2 '<span style="color: #97b098;">(</span>d e<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>l3 '<span style="color: #97b098;">(</span>f g h<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>nconc l1 l2 l3<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l1<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l2<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l3<span style="color: #93a8c6;">)</span>
  nil<span style="color: #8c8c8c;">)</span>

=&gt;

<span style="color: #8c8c8c;">(</span>A B C D E F G H<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>D E F G H<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>F G H<span style="color: #8c8c8c;">)</span>
NIL


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20294;&#35201;&#26159;&#31532;&#19968;&#20010;&#31354;&#21015;&#34920;&#65292;&#37027;&#20040;&#20250;&#20462;&#25913;&#31532;&#20108;&#20010;&#21442;&#25968;&#20026;&#36830;&#25509;&#30340;&#20540;&#65292;&#23558;&#20854;&#36820;&#22238;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>l1 '<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>l2 '<span style="color: #97b098;">(</span>d e<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>l3 '<span style="color: #97b098;">(</span>f g h<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>nconc l1 l2 l3<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l1<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l2<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l3<span style="color: #93a8c6;">)</span>
  nil<span style="color: #8c8c8c;">)</span>

=&gt;

NIL
<span style="color: #8c8c8c;">(</span>D E F G H<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>F G H<span style="color: #8c8c8c;">)</span>
NIL

</pre>
</div>


<p>
所以有时候需要下面这样, 多加一步手动设置值。
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span>setq x <span style="color: #93a8c6;">(</span>nconc x y<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
</pre>
</div>

<p>
这一习惯用法可以采用concf宏来实现：
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">concf &#23450;&#20041;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">define-modify-macro</span> <span style="color: #daa520;">concf</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> lists<span style="color: #93a8c6;">)</span> nconc<span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">concf &#20351;&#29992;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>l1 '<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>l2 '<span style="color: #97b098;">(</span>d e<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>l3 '<span style="color: #97b098;">(</span>f g h<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>concf l1 l2 l3<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l1<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l2<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l3<span style="color: #93a8c6;">)</span>
  nil<span style="color: #8c8c8c;">)</span>

=&gt;

<span style="color: #8c8c8c;">(</span>D E F G H<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>D E F G H<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>F G H<span style="color: #8c8c8c;">)</span>
NIL

&#36825;&#26102;&#20505;&#65292;&#31532;&#19968;&#20010;&#21442;&#25968;&#19968;&#23450;&#26159;&#36830;&#25509;&#30340;&#32467;&#26524;&#12290;

</pre>
</div>


<p>
更特殊的 <code>conc1f</code> 和 <code>concnew</code> 就像是用于列表尾端的 <code>push</code> 和 <code>pushnew</code>:
</p>

<p>
conc1f 在列表结尾追加一个元素，而 concnew 的功能相同，
但只有当这个元素不在列 表中时才会动作。
</p>

<p>
实现如下:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;;; </span><span style="color: #7f7f7f;">conc1f</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">conc1f/function</span> <span style="color: #93a8c6;">(</span>place obj<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>nconc place <span style="color: #b0b1a3;">(</span>list obj<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">define-modify-macro</span> <span style="color: #daa520;">conc1f</span> <span style="color: #93a8c6;">(</span>obj<span style="color: #93a8c6;">)</span> conc1f/function<span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;;; </span><span style="color: #7f7f7f;">concnew</span>
<span style="color: #7f7f7f;">;;; </span><span style="color: #7f7f7f;">&#27880;&#24847;&#36825;&#37324;&#19981;&#21516;&#20110;onlisp&#20070;&#20013;&#30340;&#23450;&#20041;, &#23427;&#30340;&#23450;&#20041;&#25105;&#35748;&#20026;&#26377;&#38382;&#39064;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">concnew/function</span> <span style="color: #93a8c6;">(</span>place obj <span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>apply #'member obj place args<span style="color: #b0b1a3;">)</span>
      place
      <span style="color: #b0b1a3;">(</span>nconc place <span style="color: #97b098;">(</span>list obj<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">define-modify-macro</span> <span style="color: #daa520;">concnew</span> <span style="color: #93a8c6;">(</span>obj <span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span> concnew/function<span style="color: #8c8c8c;">)</span>

</pre>
</div>


<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">conc1f &#20351;&#29992;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>l1 '<span style="color: #97b098;">(</span>a b c<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>x 'd<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>y 'b<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print <span style="color: #b0b1a3;">(</span>conc1f l1 x<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l1<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print <span style="color: #b0b1a3;">(</span>conc1f l1 y<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l1<span style="color: #93a8c6;">)</span>
  nil<span style="color: #8c8c8c;">)</span>

=&gt;

<span style="color: #8c8c8c;">(</span>A B C D<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>A B C D<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>A B C D B<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>A B C D B<span style="color: #8c8c8c;">)</span>
NIL


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">conc1f &#31532;&#20108;&#20010;&#20363;&#23376;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>l1 '<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>x 'd<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>y 'b<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print <span style="color: #b0b1a3;">(</span>conc1f l1 x<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l1<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print <span style="color: #b0b1a3;">(</span>conc1f l1 y<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l1<span style="color: #93a8c6;">)</span>
  nil<span style="color: #8c8c8c;">)</span>

=&gt;

<span style="color: #8c8c8c;">(</span>D<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>D<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>D B<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>D B<span style="color: #8c8c8c;">)</span>
NIL


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">concnew &#20351;&#29992;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>l1 '<span style="color: #97b098;">(</span>a b c<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>x 'd<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>y 'b<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print <span style="color: #b0b1a3;">(</span>concnew l1 x<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l1<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print <span style="color: #b0b1a3;">(</span>concnew l1 y<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l1<span style="color: #93a8c6;">)</span>
  nil<span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span>A B C D<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>A B C D<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>A B C D<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>A B C D<span style="color: #8c8c8c;">)</span>
NIL


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">concnew &#31532;&#20108;&#20010;&#20363;&#23376;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>l1 '<span style="color: #97b098;">()</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>x 'd<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>y 'b<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>z 'd<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print <span style="color: #b0b1a3;">(</span>concnew l1 x<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l1<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print <span style="color: #b0b1a3;">(</span>concnew l1 y<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l1<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print <span style="color: #b0b1a3;">(</span>concnew l1 z<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l1<span style="color: #93a8c6;">)</span>
  nil<span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span>D<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>D<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>D B<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>D B<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>D B<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>D B<span style="color: #8c8c8c;">)</span>
NIL
</pre>
</div>

<p>
但考虑到效率原因，如果是通过网列表结果追加元素的方式来构造列表，那么最好push后再reverse。
</p>
</div>
</div>
</div>

<div id="outline-container-org1db2a08" class="outline-3">
<h3 id="org1db2a08"><span class="section-number-3">14.4</span> 宏 get-setf-expansion</h3>
<div class="outline-text-3" id="text-14-4">
<p>
宏 <code>get-setf-expansion</code> 返回广义变量的五个元素:
</p>

<div class="org-src-container">
<pre class="src src-lisp">CL-USER&gt; <span style="color: #8c8c8c;">(</span>get-setf-expansion '<span style="color: #93a8c6;">(</span>aref a <span style="color: #b0b1a3;">(</span>incf i<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>#<span style="color: #f08080;">:A591</span> #<span style="color: #f08080;">:G592</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>A <span style="color: #93a8c6;">(</span>INCF I<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>#<span style="color: #f08080;">:NEW1</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>FUNCALL #'<span style="color: #93a8c6;">(</span>SETF AREF<span style="color: #93a8c6;">)</span> #<span style="color: #f08080;">:NEW1</span> #<span style="color: #f08080;">:A591</span> #<span style="color: #f08080;">:G592</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>AREF #<span style="color: #f08080;">:A591</span> #<span style="color: #f08080;">:G592</span><span style="color: #8c8c8c;">)</span>

CL-USER&gt; <span style="color: #8c8c8c;">(</span>get-setf-expansion '<span style="color: #93a8c6;">(</span>car '<span style="color: #b0b1a3;">(</span>a b c d<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
NIL
NIL
<span style="color: #8c8c8c;">(</span>#<span style="color: #f08080;">:NEW1</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>SB-KERNEL:%RPLACA '<span style="color: #93a8c6;">(</span>A B C D<span style="color: #93a8c6;">)</span> #<span style="color: #f08080;">:NEW1</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>CAR '<span style="color: #93a8c6;">(</span>A B C D<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>

<ol class="org-ol">
<li>第一个值是定义修改宏时临时变量列表</li>
<li>第二个值是上面变量列表对应的复制</li>
<li>第三个值是用于存储修改后的值临时变量列表</li>
<li>第四个值是修改广义变量值的表达式</li>
<li>第五个值是访问广义变量初始值的表达式</li>
</ol>

<p>
说起来比较复制和绕人，也可以查看文档。
</p>

<p>
总之 <code>get-setf-expansion</code> 返回了定义修改宏的原料，可以用这些原料来定义修改宏。
</p>
</div>
</div>

<div id="outline-container-org0eb1430" class="outline-3">
<h3 id="org0eb1430"><span class="section-number-3">14.5</span> 实用工具（二）</h3>
<div class="outline-text-3" id="text-14-5">
</div>
<div id="outline-container-org49906bc" class="outline-4">
<h4 id="org49906bc"><span class="section-number-4">14.5.1</span> _f</h4>
<div class="outline-text-4" id="text-14-5-1">
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;;; </span><span style="color: #7f7f7f;">--- Macro `_f` ---</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">_f</span> <span style="color: #93a8c6;">(</span>op place <span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">multiple-value-bind</span> <span style="color: #b0b1a3;">(</span>vars forms var set access<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>get-setf-expansion place<span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let*</span> <span style="color: #97b098;">(</span>,@<span style="color: #aebed8;">(</span>mapcar #'list vars forms<span style="color: #aebed8;">)</span>
            <span style="color: #aebed8;">(</span>,<span style="color: #b0b0b3;">(</span>car var<span style="color: #b0b0b3;">)</span> <span style="color: #b0b0b3;">(</span>,op ,access ,@args<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       ,set<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Macro `conc1f` created with `_f`</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">name with `'` to avoid name conflict</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">conc1f</span>' <span style="color: #93a8c6;">(</span>lst obj<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span>_f nconc ,lst <span style="color: #b0b1a3;">(</span>list ,obj<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


</pre>
</div>
</div>
</div>

<div id="outline-container-org44e7f9e" class="outline-4">
<h4 id="org44e7f9e"><span class="section-number-4">14.5.2</span> pull, pull-if</h4>
<div class="outline-text-4" id="text-14-5-2">
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;;; </span><span style="color: #7f7f7f;">--- Macro `pull` ---</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Use case</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(let ((x '(1 2 (a b) 3)))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(print (pull '(a b) (cdr x) :test #'equal))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(print x)</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">nil)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">=&gt;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(2 3)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(1 2 3)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">NIL</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">pull</span> <span style="color: #93a8c6;">(</span>obj place <span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">multiple-value-bind</span> <span style="color: #b0b1a3;">(</span>vars forms var set access<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>get-setf-expansion place<span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>g <span style="color: #b0b0b3;">(</span>gensym<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
      `<span style="color: #97b098;">(</span><span style="color: #00bfff;">let*</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>,g ,obj<span style="color: #b0b0b3;">)</span>
              ,@<span style="color: #b0b0b3;">(</span>mapcar #'list vars forms<span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span>,<span style="color: #90a890;">(</span>car var<span style="color: #90a890;">)</span> <span style="color: #90a890;">(</span>delete ,g ,access ,@args<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
         ,set<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Macro expansion example1</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(let ((x '(1 2 (a b) 3)))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(pull '(a b) (cdr x) :test #'equal))</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">expand to</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(LET ((X '(1 2 (A B) 3)))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(LET* ((#:G611 '(A B))</span>
<span style="color: #7f7f7f;">;;          </span><span style="color: #7f7f7f;">(#:X610 X)</span>
<span style="color: #7f7f7f;">;;          </span><span style="color: #7f7f7f;">(#:NEW1 (DELETE #:G611 (CDR #:X610) :TEST #'EQUAL)))</span>
<span style="color: #7f7f7f;">;;     </span><span style="color: #7f7f7f;">(SB-KERNEL:%RPLACD #:X610 #:NEW1)))</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">;; Macro expansion example2</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(let ((x '(1 2 (a b) 3)))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(onlisp::pull 3 (cddr x) :test #'equal))</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">expand to</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(LET ((X '(1 2 (A B) 3)))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(LET* ((#:G617 3)</span>
<span style="color: #7f7f7f;">;;          </span><span style="color: #7f7f7f;">(#:LIST (CDR X))</span>
<span style="color: #7f7f7f;">;;          </span><span style="color: #7f7f7f;">(#:NEW (DELETE #:G617 (CDR #:LIST) :TEST #'EQUAL)))</span>
<span style="color: #7f7f7f;">;;     </span><span style="color: #7f7f7f;">(SB-KERNEL:%RPLACD #:LIST #:NEW)))</span>






<span style="color: #7f7f7f;">;;; </span><span style="color: #7f7f7f;">--- Macro `pull-if`---</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">use case</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">CL-USER&gt; (let ((l '(1 2  3 4 5)))</span>
<span style="color: #7f7f7f;">;;            </span><span style="color: #7f7f7f;">(pull-if #'oddp l)</span>
<span style="color: #7f7f7f;">;;            </span><span style="color: #7f7f7f;">l)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">=&gt;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(2 4)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">expand to</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(LET ((L '(1 2 3 4 5)))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(LET* ((#:G619 #'ODDP) (#:NEW1 (DELETE-IF #:G619 L)))</span>
<span style="color: #7f7f7f;">;;     </span><span style="color: #7f7f7f;">(SETQ L #:NEW1))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">L)</span>


<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">pull-if</span> <span style="color: #93a8c6;">(</span>test place <span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">multiple-value-bind</span> <span style="color: #b0b1a3;">(</span>vars forms var set access<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>get-setf-expansion place<span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>g <span style="color: #b0b0b3;">(</span>gensym<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
      `<span style="color: #97b098;">(</span><span style="color: #00bfff;">let*</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>,g ,test<span style="color: #b0b0b3;">)</span>
              ,@<span style="color: #b0b0b3;">(</span>mapcar #'list vars forms<span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span>,<span style="color: #90a890;">(</span>car var<span style="color: #90a890;">)</span> <span style="color: #90a890;">(</span>delete-if ,g ,access ,@args<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">the different with pull is here</span>
         ,set<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>




</pre>
</div>
</div>
</div>


<div id="outline-container-orgc1b3581" class="outline-4">
<h4 id="orgc1b3581"><span class="section-number-4">14.5.3</span> popn</h4>
<div class="outline-text-4" id="text-14-5-3">
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;;; </span><span style="color: #7f7f7f;">--- Macro popn ---</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Use case</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(let ((l '(a b c d e f g)))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(print (onlisp::popn 2 (cddr l)))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(print l)</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">nil)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">=&gt;</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(C D)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(A B E F G)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">NIL</span>


<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">popn</span> <span style="color: #93a8c6;">(</span>n place<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">multiple-value-bind</span> <span style="color: #b0b1a3;">(</span>vars forms var set access<span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>get-setf-expansion place<span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">with-gensyms</span> <span style="color: #97b098;">(</span>gn glst<span style="color: #97b098;">)</span>
      `<span style="color: #97b098;">(</span><span style="color: #00bfff;">let*</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>,gn ,n<span style="color: #b0b0b3;">)</span>
              ,@<span style="color: #b0b0b3;">(</span>mapcar #'list vars forms<span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span>,glst ,access<span style="color: #b0b0b3;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#30001;&#20110;&#20004;&#20010;&#22320;&#26041;&#35201;&#29992;&#21040;access, &#25152;&#20197;&#36825;&#37324;&#37319;&#29992;&#20020;&#26102;&#21464;&#37327;&#26469;&#23384;&#20648;&#20540;</span>
              <span style="color: #b0b0b3;">(</span>,<span style="color: #90a890;">(</span>car var<span style="color: #90a890;">)</span> <span style="color: #90a890;">(</span>nthcdr ,gn ,glst<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
         <span style="color: #aebed8;">(</span><span style="color: #00bfff;">prog1</span> <span style="color: #b0b0b3;">(</span>subseq ,glst 0 ,gn<span style="color: #b0b0b3;">)</span>
           ,set<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Macro expansion</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(LET ((L '(A B C D E F G)))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(PRINT (LET* ((#:GN595 2)</span>
<span style="color: #7f7f7f;">;;                 </span><span style="color: #7f7f7f;">(#:LIST (CDR L))</span>
<span style="color: #7f7f7f;">;;                 </span><span style="color: #7f7f7f;">(#:GLST596 (CDR #:LIST))</span>
<span style="color: #7f7f7f;">;;                 </span><span style="color: #7f7f7f;">(#:NEW (NTHCDR #:GN595 #:GLST596)))</span>
<span style="color: #7f7f7f;">;;            </span><span style="color: #7f7f7f;">(PROG1 (SUBSEQ #:GLST596 0 #:GN595) (SB-KERNEL:%RPLACD #:LIST #:NEW))))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(PRINT L)</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">NIL)</span>



</pre>
</div>
</div>
</div>


<div id="outline-container-org920cd69" class="outline-4">
<h4 id="org920cd69"><span class="section-number-4">14.5.4</span> sortf</h4>
<div class="outline-text-4" id="text-14-5-4">
<p>
sortf 用于修改参数的值，使其按照传入的op
</p>

<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;;; </span><span style="color: #7f7f7f;">--- Macro sortf ---</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">sortf</span> <span style="color: #93a8c6;">(</span>op <span style="color: #98f5ff;">&amp;rest</span> places<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let*</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>meths <span style="color: #aebed8;">(</span>mapcar #'<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">(</span>p<span style="color: #90a890;">)</span>
                            <span style="color: #90a890;">(</span>multiple-value-list
                             <span style="color: #a2b6da;">(</span>get-setf-expansion p<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                        places<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
         <span style="color: #97b098;">(</span>temps <span style="color: #aebed8;">(</span>apply #'append <span style="color: #b0b0b3;">(</span>mapcar #'third meths<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let*</span> ,<span style="color: #97b098;">(</span>mapcar #'list
                    <span style="color: #aebed8;">(</span>mapcan #'<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">(</span>m<span style="color: #90a890;">)</span>
                                <span style="color: #90a890;">(</span>append <span style="color: #a2b6da;">(</span>first m<span style="color: #a2b6da;">)</span>
                                        <span style="color: #a2b6da;">(</span>third m<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                            meths<span style="color: #aebed8;">)</span>
                    <span style="color: #aebed8;">(</span>mapcan #'<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">(</span>m<span style="color: #90a890;">)</span>
                                <span style="color: #90a890;">(</span>append <span style="color: #a2b6da;">(</span>second m<span style="color: #a2b6da;">)</span>
                                        <span style="color: #a2b6da;">(</span>list <span style="color: #9cb6ad;">(</span>fifth m<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                            meths<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       ,@<span style="color: #97b098;">(</span>mapcon #'<span style="color: #aebed8;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b0b3;">(</span>rest<span style="color: #b0b0b3;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">1. use mapcon so `rest` arg will be (#:g1 #:g2 #:g3) (#:g2 #:g3) (#:g3) each time</span>
                     <span style="color: #b0b0b3;">(</span>mapcar
                      <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">3. so when the inner lambda get (#:g2 #:g3) passed, it will compare to `(car rest)` which is #:g1;</span>
                      <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">when the inner lambda get (#:g3) passed, it will compare to `(car rest)` which is #:g2.</span>
                      <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">So it creates three unless expression</span>
                      #'<span style="color: #90a890;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #a2b6da;">(</span>arg<span style="color: #a2b6da;">)</span>
                          `<span style="color: #a2b6da;">(</span><span style="color: #00bfff;">unless</span> <span style="color: #9cb6ad;">(</span>,op ,<span style="color: #8c8c8c;">(</span>car rest<span style="color: #8c8c8c;">)</span> ,arg<span style="color: #9cb6ad;">)</span>
                             <span style="color: #9cb6ad;">(</span>rotatef ,<span style="color: #8c8c8c;">(</span>car rest<span style="color: #8c8c8c;">)</span> ,arg<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                      <span style="color: #90a890;">(</span>cdr rest<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">2. so (cdr list) passed to the `mapcar lambda` will be (#:g2 #:g3) (#:g3) ()</span>
                 temps<span style="color: #97b098;">)</span>
       ,@<span style="color: #97b098;">(</span>mapcar #'fourth meths<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(let ((x 1)</span>
<span style="color: #7f7f7f;">;;       </span><span style="color: #7f7f7f;">(y 2)</span>
<span style="color: #7f7f7f;">;;       </span><span style="color: #7f7f7f;">(z 3))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(sortf &gt; x y z)</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(list x y z))</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">=&gt; (3 2 1)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Macro expand result</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(LET ((X 1) (Y 2) (Z 3))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(LET* ((#:NEW1 X) (#:NEW2 Y) (#:NEW3 Z))</span>
<span style="color: #7f7f7f;">;;     </span><span style="color: #7f7f7f;">(UNLESS (&gt; #:NEW1 #:NEW2) (ROTATEF #:NEW1 #:NEW2))</span>
<span style="color: #7f7f7f;">;;     </span><span style="color: #7f7f7f;">(UNLESS (&gt; #:NEW1 #:NEW3) (ROTATEF #:NEW1 #:NEW3))</span>
<span style="color: #7f7f7f;">;;     </span><span style="color: #7f7f7f;">(UNLESS (&gt; #:NEW2 #:NEW3) (ROTATEF #:NEW2 #:NEW3))</span>
<span style="color: #7f7f7f;">;;     </span><span style="color: #7f7f7f;">(SETQ X #:NEW1)</span>
<span style="color: #7f7f7f;">;;     </span><span style="color: #7f7f7f;">(SETQ Y #:NEW2)</span>
<span style="color: #7f7f7f;">;;     </span><span style="color: #7f7f7f;">(SETQ Z #:NEW3))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(LIST X Y Z))</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#23439;&#37319;&#29992;mapcon&#20197;&#21450;&#23884;&#22871;&#30340;mapcar&#31561;&#26469;&#25353;&#29031;&#38656;&#27714;&#29983;&#25104;&#22810;&#20010;unless&#34920;&#36798;&#24335;&#65292;&#24456;&#31934;&#33268;&#65292;&#20540;&#24471;&#30740;&#31350;&#12290;</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc429834" class="outline-3">
<h3 id="orgc429834"><span class="section-number-3">14.6</span> 宏 defsetf</h3>
<div class="outline-text-3" id="text-14-6">
<p>
宏 <code>defsetf</code> 用来定义函数或者宏的 逆（从查询到断言的变换称作逆）。
</p>

<p>
使用 defsetf 的方式有两种，一种是简单的
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defsetf</span> <span style="color: #daa520;">my-car</span> rplace<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20363;&#23376;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>l '<span style="color: #97b098;">(</span>a b c d<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print <span style="color: #b0b1a3;">(</span>setf <span style="color: #97b098;">(</span>my-car2 l<span style="color: #97b098;">)</span> 'e<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l<span style="color: #93a8c6;">)</span>
  nil<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">=&gt;</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#27714;&#20540;&#32467;&#26524;</span>
<span style="color: #8c8c8c;">(</span>E B C D<span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>E B C D<span style="color: #8c8c8c;">)</span>
NIL

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#23637;&#24320;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>L '<span style="color: #97b098;">(</span>A B C D<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>PRINT <span style="color: #b0b1a3;">(</span>RPLACA L 'E<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>PRINT L<span style="color: #93a8c6;">)</span>
  NIL<span style="color: #8c8c8c;">)</span>


</pre>
</div>


<p>
这里呢， 定义my-car 的逆稍微有些不对，因为 <code>(setf ...)</code> 的返回值并不是设置的新值。
</p>

<p>
所以更准确的方式是下面这种是复杂的方式：
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23450;&#20041;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defsetf</span> <span style="color: #daa520;">my-car</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>new-car<span style="color: #93a8c6;">)</span>
    `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">progn</span> <span style="color: #b0b1a3;">(</span>rplaca ,lst ,new-car<span style="color: #b0b1a3;">)</span>
           ,new-car<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#27714;&#20540;&#20363;&#23376;</span>
CL-USER&gt; <span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>l '<span style="color: #97b098;">(</span>a b c d<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
           <span style="color: #93a8c6;">(</span>print <span style="color: #b0b1a3;">(</span>setf <span style="color: #97b098;">(</span>my-car l<span style="color: #97b098;">)</span> 'e<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
           <span style="color: #93a8c6;">(</span>print l<span style="color: #93a8c6;">)</span>
           nil<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">=&gt;</span>
E
<span style="color: #8c8c8c;">(</span>E B C D<span style="color: #8c8c8c;">)</span>
NIL


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21407;&#24335;&#30340;&#23439;&#23637;&#24320;&#20026;&#65306;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>L '<span style="color: #97b098;">(</span>A B C D<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>PRINT <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">LET*</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>#<span style="color: #f08080;">:LST</span> L<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>#<span style="color: #f08080;">:NEW1</span> 'E<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
           <span style="color: #97b098;">(</span>RPLACA #<span style="color: #f08080;">:LST</span> #<span style="color: #f08080;">:NEW1</span><span style="color: #97b098;">)</span>
           #<span style="color: #f08080;">:NEW1</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>PRINT L<span style="color: #93a8c6;">)</span>
  NIL<span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#36825;&#31181;defsetf &#30340;&#22797;&#26434;&#30340;&#23450;&#20041;&#24418;&#24335;&#21644;&#23439;&#30340;&#23450;&#20041;&#24418;&#24335;&#26377;&#20960;&#20998;&#30456;&#20284;&#65292;&#20294;&#26377;&#20010;&#37325;&#35201;&#21306;&#21035;&#65306;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">defsetf&#20250;&#33258;&#21160;&#20026;&#21442;&#25968;&#29983;&#25104;gensym&#65292; &#19981;&#29992;&#25285;&#24515;&#23637;&#24320;&#21518;&#30340;&#21464;&#37327;&#25429;&#25417;&#65292;&#27714;&#20540;&#27425;&#25968;&#21644;&#39034;&#24207;&#31561;</span>
</pre>
</div>




<p>
对于my-car逆的定义还可以采用 defun 来定义：
</p>
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23450;&#20041;</span>
CL-USER&gt; <span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #93a8c6;">(</span><span style="color: #daa520;">setf my-car</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>new-car lst<span style="color: #93a8c6;">)</span>
           <span style="color: #93a8c6;">(</span>rplaca lst new-car<span style="color: #93a8c6;">)</span>
           new-car<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#27714;&#20540;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>l '<span style="color: #97b098;">(</span>a b c d<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print <span style="color: #b0b1a3;">(</span>setf <span style="color: #97b098;">(</span>my-car l<span style="color: #97b098;">)</span> 'e<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>print l<span style="color: #93a8c6;">)</span>
  nil<span style="color: #8c8c8c;">)</span>

E
<span style="color: #8c8c8c;">(</span>E B C D<span style="color: #8c8c8c;">)</span>
NIL

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#23637;&#24320;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>L '<span style="color: #97b098;">(</span>A B C D<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>PRINT <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">LET*</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>#<span style="color: #f08080;">:L591</span> L<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>#<span style="color: #f08080;">:NEW1</span> 'E<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
           <span style="color: #97b098;">(</span>FUNCALL #'<span style="color: #aebed8;">(</span>SETF MY-CAR<span style="color: #aebed8;">)</span> #<span style="color: #f08080;">:NEW1</span> #<span style="color: #f08080;">:L591</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>PRINT L<span style="color: #93a8c6;">)</span>
  NIL<span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb7d1fee" class="outline-2">
<h2 id="orgb7d1fee"><span class="section-number-2">15</span> 编译期计算</h2>
<div class="outline-text-2" id="text-15">
<p>
有些问题用函数可以解决，但用宏回更高效。 因为用宏将许多计算工作放到了编译时期完成。
</p>
</div>



<div id="outline-container-org2f0aad9" class="outline-3">
<h3 id="org2f0aad9"><span class="section-number-3">15.1</span> 将参数个数计算移到编译器</h3>
<div class="outline-text-3" id="text-15-1">
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20989;&#25968;&#29256;&#26412;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">avg</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>/ <span style="color: #b0b1a3;">(</span>apply #'+ args<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>length args<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#29256;&#26412;</span>
<span style="color: #7f7f7f;">;;</span><span style="color: #7f7f7f;">&#23545; (length args) &#30340;&#35745;&#31639;&#30001;&#36816;&#34892;&#26399;&#31227;&#21040;&#20102;&#32534;&#35793;&#26399;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">avg</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span>/ <span style="color: #b0b1a3;">(</span>+ ,@args<span style="color: #b0b1a3;">)</span> ,<span style="color: #b0b1a3;">(</span>length args<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&lt;-- &#21442;&#25968;&#20010;&#25968;&#35745;&#31639;&#22312;&#23439;&#23637;&#24320;&#26102;&#23436;&#25104;</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Macro expansion</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">CL-USER&gt; (avg 1 2 3 4 5)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">=&gt;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(/ (+ 1 2 3 4 5) 5)</span>


</pre>
</div>
</div>
</div>

<div id="outline-container-org88a3687" class="outline-3">
<h3 id="org88a3687"><span class="section-number-3">15.2</span> 部分参数求值</h3>
<div class="outline-text-3" id="text-15-2">
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20989;&#25968;&#29256;&#26412;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">most-of</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>all 0<span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span>hits 0<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">dolist</span> <span style="color: #97b098;">(</span>a args<span style="color: #97b098;">)</span>
      <span style="color: #97b098;">(</span>incf all<span style="color: #97b098;">)</span>
      <span style="color: #97b098;">(</span><span style="color: #00bfff;">if</span> a <span style="color: #aebed8;">(</span>incf hits<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span>&gt; hits <span style="color: #97b098;">(</span>/ all 2<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#29256;&#26412;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">most-of</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>need <span style="color: #aebed8;">(</span>floor <span style="color: #b0b0b3;">(</span>/ <span style="color: #90a890;">(</span>length args<span style="color: #90a890;">)</span> 2<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span>hits <span style="color: #aebed8;">(</span>gensym<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>,hits 0<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span>or ,@<span style="color: #aebed8;">(</span>mapcar #'<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">(</span>a<span style="color: #90a890;">)</span>
                         `<span style="color: #90a890;">(</span>and ,a <span style="color: #a2b6da;">(</span>&gt; <span style="color: #9cb6ad;">(</span>incf ,hits<span style="color: #9cb6ad;">)</span> ,need<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                      args<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Macroexpansion</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">CL-USER&gt; (most-of t t nil nil t)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(LET ((#:G584 0))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(OR (AND T (&gt; (INCF #:G584) 2))</span>
<span style="color: #7f7f7f;">;;       </span><span style="color: #7f7f7f;">(AND T (&gt; (INCF #:G584) 2))</span>
<span style="color: #7f7f7f;">;;       </span><span style="color: #7f7f7f;">(AND NIL (&gt; (INCF #:G584) 2))</span>
<span style="color: #7f7f7f;">;;       </span><span style="color: #7f7f7f;">(AND NIL (&gt; (INCF #:G584) 2))</span>
<span style="color: #7f7f7f;">;;       </span><span style="color: #7f7f7f;">(AND T (&gt; (INCF #:G584) 2))))</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21033;&#29992;&#20102;or&#21644;and&#30340;&#30701;&#36335;&#24615;&#36136;, most-of &#23439;&#21482;&#20250;&#27714;&#20540;&#38656;&#35201;&#30340;&#25968;&#37327;&#30340;&#21442;&#25968;.</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#26368;&#29702;&#24819;&#24773;&#20917;&#19979;&#65292;&#21482;&#20250;&#23545;&#21018;&#36807;&#21322;&#30340;&#21442;&#25968;&#27714;&#20540;&#12290;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20363;&#22914; (most-of (a) (b) (c)) &#23637;&#24320;&#25104;</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(let ((count 0))</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(or (and (a) (&gt; (incf count) 1))</span>
<span style="color: #7f7f7f;">;;       </span><span style="color: #7f7f7f;">(and (b) (&gt; (incf count) 1))</span>
<span style="color: #7f7f7f;">;;       </span><span style="color: #7f7f7f;">(and (c) (&gt; (incf count) 1))))</span>


</pre>
</div>
</div>
</div>

<div id="outline-container-org6142e5e" class="outline-3">
<h3 id="org6142e5e"><span class="section-number-3">15.3</span> 编译时期只知道部分参数值</h3>
<div class="outline-text-3" id="text-15-3">
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20989;&#25968;&#29256;&#26412;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">nthmost</span> <span style="color: #93a8c6;">(</span>n lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>nth n <span style="color: #b0b1a3;">(</span>sort <span style="color: #97b098;">(</span>copy-list lst<span style="color: #97b098;">)</span> #'&gt;<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#29256;&#26412;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#30340;&#23439;&#21033;&#29992;&#20102;&#19968;&#20010;&#20248;&#21270;&#65292;&#22914;&#26524;&#35201;&#27714;&#31532;3&#20010;&#22823;&#30340;&#20803;&#32032;&#65292;&#21482;&#38656;&#35201;&#20445;&#23384;&#24050;&#26597;&#35810;&#21040;&#30340;3&#20010;&#26368;&#22823;&#30340;&#20803;&#32032;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#19968;&#27425;&#36941;&#21382;&#21518;, &#36820;&#22238;&#31532;3&#22823;&#30340;&#21487;&#20197;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">nthmost-1</span> <span style="color: #93a8c6;">(</span>n lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>and <span style="color: #97b098;">(</span>integerp n<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>&lt; n 20<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22914;&#26524;&#32534;&#35793;&#26102;&#26399;n&#19981;&#26159;&#19968;&#20010;&#25968;&#23383;&#25110;&#32773;&#35813;&#25968;&#23383;&#22826;&#22823;&#65292;&#37027;&#20040;&#20037;&#36864;&#21270;&#25104;&#26222;&#36890;&#30340;&#20989;&#25968;&#29256;&#26412;</span>
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">with-gensyms</span> <span style="color: #97b098;">(</span>glst gi<span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span><span style="color: #00bfff;">let</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>syms <span style="color: #90a890;">(</span>map0-n #'<span style="color: #a2b6da;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #9cb6ad;">(</span>x<span style="color: #9cb6ad;">)</span>
                                <span style="color: #9cb6ad;">(</span><span style="color: #00bfff;">declare</span> <span style="color: #8c8c8c;">(</span>ignore x<span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span>
                                <span style="color: #9cb6ad;">(</span>gensym<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span>
                             n<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">syms &#26159;&#29983;&#25104;&#19968;&#20010;n&#30340;&#20803;&#32032;&#30340;&#21015;&#34920;&#65292;&#29992;&#26469;&#20445;&#23384;&#21069;n&#22823;&#30340;&#20803;&#32032;</span>
          `<span style="color: #aebed8;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b0b3;">(</span><span style="color: #90a890;">(</span>,glst ,lst<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
             <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">unless</span> <span style="color: #90a890;">(</span>&lt; <span style="color: #a2b6da;">(</span>length ,glst<span style="color: #a2b6da;">)</span> ,<span style="color: #a2b6da;">(</span>1+ n<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22914;&#26524;n&#38271;&#24230;&#22823;&#20110;&#25972;&#20010;lst&#38271;&#24230;&#37027;&#20040;&#36820;&#22238;nil</span>
               ,@<span style="color: #90a890;">(</span>gen-start glst syms<span style="color: #90a890;">)</span>
               <span style="color: #90a890;">(</span><span style="color: #00bfff;">dolist</span> <span style="color: #a2b6da;">(</span>,gi ,glst<span style="color: #a2b6da;">)</span>
                 ,<span style="color: #a2b6da;">(</span>nthmost-gen gi syms t<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23545;&#20110;&#20219;&#19968;lst&#37324;&#20803;&#32032;&#65292;&#29983;&#25104;setq&#30340;&#27604;&#36739;&#35774;&#32622;&#30340;&#34920;&#36798;&#24335;</span>
               ,<span style="color: #90a890;">(</span>car <span style="color: #a2b6da;">(</span>last syms<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36820;&#22238;&#31532;n&#22823;&#20803;&#32032;</span>
      `<span style="color: #b0b1a3;">(</span>nth ,n <span style="color: #97b098;">(</span>sort <span style="color: #aebed8;">(</span>copy-list ,lst<span style="color: #aebed8;">)</span> #'&gt;<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36741;&#21161;&#20989;&#25968;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">gen-start</span> <span style="color: #93a8c6;">(</span>glst syms<span style="color: #93a8c6;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#29983;&#25104;&#21069;n&#20010;&#20803;&#32032;&#30340;&#21021;&#22987;&#35774;&#32622;&#30340;&#20540;</span>
  <span style="color: #93a8c6;">(</span>reverse
   <span style="color: #b0b1a3;">(</span>maplist #'<span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>syms<span style="color: #aebed8;">)</span>
                <span style="color: #aebed8;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b0b3;">(</span><span style="color: #90a890;">(</span>var <span style="color: #a2b6da;">(</span>gensym<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                  `<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #90a890;">(</span><span style="color: #a2b6da;">(</span>,var <span style="color: #9cb6ad;">(</span>pop ,glst<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                     ,<span style="color: #90a890;">(</span>nthmost-gen var <span style="color: #a2b6da;">(</span>reverse syms<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
             <span style="color: #97b098;">(</span>reverse syms<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36741;&#21161;&#20989;&#25968;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">nthmost-gen</span> <span style="color: #93a8c6;">(</span>var vars <span style="color: #98f5ff;">&amp;optional</span> long?<span style="color: #93a8c6;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#27604;&#36739;var &#21644; vars&#37324;&#20803;&#32032;&#30340;&#20540;&#30340;&#22823;&#23567;&#65292;&#24182;&#19988;&#25353;&#29031;&#20174;&#22823;&#21040;&#23567;&#65292;&#23558;vars&#37324;&#30340;&#20540;&#35774;&#32622;&#22909;&#12290;</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null vars<span style="color: #b0b1a3;">)</span>
      nil
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>else <span style="color: #b0b0b3;">(</span>nthmost-gen var <span style="color: #90a890;">(</span>cdr vars<span style="color: #90a890;">)</span> long?<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span><span style="color: #00bfff;">if</span> <span style="color: #aebed8;">(</span>and <span style="color: #b0b0b3;">(</span>not long?<span style="color: #b0b0b3;">)</span> <span style="color: #b0b0b3;">(</span>null else<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
            `<span style="color: #aebed8;">(</span>setq ,<span style="color: #b0b0b3;">(</span>car vars<span style="color: #b0b0b3;">)</span> ,var<span style="color: #aebed8;">)</span>
             `<span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b0b3;">(</span>&gt; ,var ,<span style="color: #90a890;">(</span>car vars<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                  <span style="color: #b0b0b3;">(</span>setq ,@<span style="color: #90a890;">(</span>mapcan #'list
                                   <span style="color: #a2b6da;">(</span>reverse vars<span style="color: #a2b6da;">)</span>
                                   <span style="color: #a2b6da;">(</span>cdr <span style="color: #9cb6ad;">(</span>reverse vars<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                        ,<span style="color: #90a890;">(</span>car vars<span style="color: #90a890;">)</span> ,var<span style="color: #b0b0b3;">)</span>
                  ,else<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#23637;&#24320;&#31034;&#20363;</span>
CL-USER&gt; <span style="color: #8c8c8c;">(</span>onlisp::nthmost-1 2 '<span style="color: #93a8c6;">(</span>2 6 1 4 3 4<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>#<span style="color: #f08080;">:GLST625</span> '<span style="color: #97b098;">(</span>2 6 1 4 3 4<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">UNLESS</span> <span style="color: #b0b1a3;">(</span>&lt; <span style="color: #97b098;">(</span>LENGTH #<span style="color: #f08080;">:GLST625</span><span style="color: #97b098;">)</span> 3<span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>#<span style="color: #f08080;">:G632</span> <span style="color: #b0b0b3;">(</span>POP #<span style="color: #f08080;">:GLST625</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
      <span style="color: #97b098;">(</span>SETQ #<span style="color: #f08080;">:G627</span> #<span style="color: #f08080;">:G632</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>#<span style="color: #f08080;">:G631</span> <span style="color: #b0b0b3;">(</span>POP #<span style="color: #f08080;">:GLST625</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
      <span style="color: #97b098;">(</span><span style="color: #00bfff;">IF</span> <span style="color: #aebed8;">(</span>&gt; #<span style="color: #f08080;">:G631</span> #<span style="color: #f08080;">:G627</span><span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span>SETQ #<span style="color: #f08080;">:G628</span> #<span style="color: #f08080;">:G627</span>
                #<span style="color: #f08080;">:G627</span> #<span style="color: #f08080;">:G631</span><span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span>SETQ #<span style="color: #f08080;">:G628</span> #<span style="color: #f08080;">:G631</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>#<span style="color: #f08080;">:G630</span> <span style="color: #b0b0b3;">(</span>POP #<span style="color: #f08080;">:GLST625</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
      <span style="color: #97b098;">(</span><span style="color: #00bfff;">IF</span> <span style="color: #aebed8;">(</span>&gt; #<span style="color: #f08080;">:G630</span> #<span style="color: #f08080;">:G627</span><span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span>SETQ #<span style="color: #f08080;">:G629</span> #<span style="color: #f08080;">:G628</span>
                #<span style="color: #f08080;">:G628</span> #<span style="color: #f08080;">:G627</span>
                #<span style="color: #f08080;">:G627</span> #<span style="color: #f08080;">:G630</span><span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span><span style="color: #00bfff;">IF</span> <span style="color: #b0b0b3;">(</span>&gt; #<span style="color: #f08080;">:G630</span> #<span style="color: #f08080;">:G628</span><span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span>SETQ #<span style="color: #f08080;">:G629</span> #<span style="color: #f08080;">:G628</span>
                    #<span style="color: #f08080;">:G628</span> #<span style="color: #f08080;">:G630</span><span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span>SETQ #<span style="color: #f08080;">:G629</span> #<span style="color: #f08080;">:G630</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">DOLIST</span> <span style="color: #97b098;">(</span>#<span style="color: #f08080;">:GI626</span> #<span style="color: #f08080;">:GLST625</span><span style="color: #97b098;">)</span>
      <span style="color: #97b098;">(</span><span style="color: #00bfff;">IF</span> <span style="color: #aebed8;">(</span>&gt; #<span style="color: #f08080;">:GI626</span> #<span style="color: #f08080;">:G627</span><span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span>SETQ #<span style="color: #f08080;">:G629</span> #<span style="color: #f08080;">:G628</span>
                #<span style="color: #f08080;">:G628</span> #<span style="color: #f08080;">:G627</span>
                #<span style="color: #f08080;">:G627</span> #<span style="color: #f08080;">:GI626</span><span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span><span style="color: #00bfff;">IF</span> <span style="color: #b0b0b3;">(</span>&gt; #<span style="color: #f08080;">:GI626</span> #<span style="color: #f08080;">:G628</span><span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span>SETQ #<span style="color: #f08080;">:G629</span> #<span style="color: #f08080;">:G628</span>
                    #<span style="color: #f08080;">:G628</span> #<span style="color: #f08080;">:GI626</span><span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">IF</span> <span style="color: #90a890;">(</span>&gt; #<span style="color: #f08080;">:GI626</span> #<span style="color: #f08080;">:G629</span><span style="color: #90a890;">)</span>
                  <span style="color: #90a890;">(</span>SETQ #<span style="color: #f08080;">:G629</span> #<span style="color: #f08080;">:GI626</span><span style="color: #90a890;">)</span>
                  NIL<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    #<span style="color: #f08080;">:G629</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>




<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">Note: &#35805;&#35828;&#22238;&#26469;&#65292;&#19978;&#38754;&#20989;&#25968;&#29256;&#26412;&#26412;&#36523;&#24182;&#19981;&#26159;&#39640;&#25928;&#30340;&#65292;&#23427;&#21487;&#20197;&#37319;&#29992;&#23439;&#37324;&#29992;&#21040;&#30340;&#20248;&#21270;&#65288;&#21482;&#20445;&#23384;&#21069;n&#22823;&#30340;&#20803;&#32032;&#65289;&#26469;&#25913;&#20889;&#12290;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#30340;&#29256;&#26412;&#26159;&#23558;&#36825;&#31181;&#20248;&#21270;&#25918;&#21040;&#20102;&#32534;&#35793;&#26399;&#12290;</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-orgdf01476" class="outline-3">
<h3 id="orgdf01476"><span class="section-number-3">15.4</span> 何时采用编译器计算宏</h3>
<div class="outline-text-3" id="text-15-4">
<p>
以下摘自原书11.3节:
</p>

<blockquote>
<p>
难道为了写出高效的程序，就必须兴师动众，编这么长的宏么?
</p>

<p>
对于本例来说，答案可能是否定的。
</p>

<p>
这里之所以给出两个版本的 nthmost，主要的原因是想举个例子，它揭示了一个普遍的原则:
</p>

<p>
当某些参数在编译期已知时，你可以用宏来生成更高效的代码。
</p>

<p>
是否利用这种可能性取决于你想获得 多少好处，以及你可以另外付出多少努力来编写一个高效的宏版本。
</p>

<p>
由于 nthmost 的宏版本既长又繁，它可能只有在极端场合才值得去写。
</p>

<p>
尽管如此，就算你宁愿不利用它，编译期已知的信息总还是一个值得考虑的因素。
</p>
</blockquote>
</div>
</div>
</div>
<div id="outline-container-orgcf9dd9b" class="outline-2">
<h2 id="orgcf9dd9b"><span class="section-number-2">16</span> 指代宏</h2>
<div class="outline-text-2" id="text-16">
<p>
在自然语言里，指代（代词）是一种引用对话中曾提及事物的表达方式。指代给日常语言带来了极大便利，但编程语言里去很少见，主要是指代容易产生歧义。
尽管如此，可以在lisp里引入一种形式有限但代词，同时避免歧义还是有可能的。
</p>
</div>

<div id="outline-container-org0ae7742" class="outline-3">
<h3 id="org0ae7742"><span class="section-number-3">16.1</span> <code>aif</code></h3>
<div class="outline-text-3" id="text-16-1">
<p>
通常需要判断某个(长计算的)表达式的返回结果，如果为真，再对结果做某些操作:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">let</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>result <span style="color: #97b098;">(</span>some-expression<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> result
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">do-something</span> result<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
这里可以写一个宏来简化这种模式:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">aif</span> <span style="color: #93a8c6;">(</span>test-form then-form <span style="color: #98f5ff;">&amp;optional</span> else-form<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>it ,test-form<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">if</span> it ,then-form ,else-form<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
这样上述模式可以写成:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span>aif <span style="color: #93a8c6;">(</span>some-expression<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">do-something</span> it<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#29992;it&#25351;&#20195;(some-expression)&#30340;&#36816;&#31639;&#32467;&#26524;</span>

</pre>
</div>
</div>
</div>


<div id="outline-container-org4cece42" class="outline-3">
<h3 id="org4cece42"><span class="section-number-3">16.2</span> <code>awhen</code></h3>
<div class="outline-text-3" id="text-16-2">
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">awhen</span> <span style="color: #93a8c6;">(</span>test-form <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span>aif ,test-form
        <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">progn</span> ,@body<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#21487;&#20197;&#30475;&#21040;awhen &#20808;&#26159;&#23637;&#24320;&#25104;aif&#65292;&#28982;&#21518;&#20877;&#23637;&#24320;</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#31034;&#20363;</span>
<span style="color: #8c8c8c;">(</span>awhen <span style="color: #93a8c6;">(</span>big-long-calculation<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>foo it<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>bar it<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org0a85994" class="outline-3">
<h3 id="org0a85994"><span class="section-number-3">16.3</span> <code>awhile</code></h3>
<div class="outline-text-3" id="text-16-3">
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">awhile</span> <span style="color: #93a8c6;">(</span>expr <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">do</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>it ,expr ,expr<span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span>not it<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
       ,@body<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#31034;&#20363;</span>
<span style="color: #8c8c8c;">(</span>awhile <span style="color: #93a8c6;">(</span>pool *fridge*<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>eat it<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
</pre>
</div>
</div>
</div>



<div id="outline-container-orgad1862c" class="outline-3">
<h3 id="orgad1862c"><span class="section-number-3">16.4</span> <code>aand</code></h3>
<div class="outline-text-3" id="text-16-4">
<div class="org-src-container">
<pre class="src src-lisp"> <span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">aand</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
   <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">cond</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>null args<span style="color: #97b098;">)</span> t<span style="color: #b0b1a3;">)</span>
         <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>null <span style="color: #aebed8;">(</span>cdr args<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>car args<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
         <span style="color: #b0b1a3;">(</span>t `<span style="color: #97b098;">(</span>aif ,<span style="color: #aebed8;">(</span>car args<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>aand ,@<span style="color: #b0b0b3;">(</span>cdr args<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


 <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#31034;&#20363;</span>
 <span style="color: #8c8c8c;">(</span>aand <span style="color: #93a8c6;">(</span>owner x<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>address it<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>town it<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

 <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#23637;&#24320;&#31034;&#20363;:</span>
 <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">1. &#29983;&#25104;cond&#30340;t case&#30340;&#32467;&#26524;</span>
 <span style="color: #8c8c8c;">(</span>AIF <span style="color: #93a8c6;">(</span>OWNER X<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>AAND <span style="color: #b0b1a3;">(</span>ADDRESS IT<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>TOWN IT<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
 <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">2. &#29983;&#25104;&#37324;&#38754;&#30340;aand&#30340;cond&#30340;t case&#30340;&#32467;&#26524;</span>
 <span style="color: #8c8c8c;">(</span>AIF <span style="color: #93a8c6;">(</span>OWNER X<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>AIF <span style="color: #b0b1a3;">(</span>ADDRESS IT<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>AAND <span style="color: #97b098;">(</span>TOWN IT<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
 <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">3. &#32487;&#32493;&#23637;&#24320;aand</span>
 <span style="color: #8c8c8c;">(</span>AIF <span style="color: #93a8c6;">(</span>OWNER X<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>AIF <span style="color: #b0b1a3;">(</span>ADDRESS IT<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>TOWN IT<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
 <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">4. &#23637;&#24320;&#37324;&#38754;&#19968;&#23618;&#30340;aif</span>
 <span style="color: #8c8c8c;">(</span>AIF <span style="color: #93a8c6;">(</span>OWNER X<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>IT <span style="color: #aebed8;">(</span>ADDRESS IT<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
                  <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">IF</span> IT
                      <span style="color: #97b098;">(</span>TOWN IT<span style="color: #97b098;">)</span>
                      NIL<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
 <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">5. &#23637;&#24320;&#22806;&#38754;&#30340;aif</span>
 <span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>IT <span style="color: #97b098;">(</span>OWNER X<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
   <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">IF</span> IT
       <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>IT <span style="color: #b0b0b3;">(</span>ADDRESS IT<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
         <span style="color: #97b098;">(</span><span style="color: #00bfff;">IF</span> IT
             <span style="color: #aebed8;">(</span>TOWN IT<span style="color: #aebed8;">)</span>
             NIL<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
       NIL<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>



<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#24605;&#32771;&#65306;&#22914;&#26524;aand&#23450;&#20041;&#25104;&#19979;&#38754;&#36825;&#26679;&#65292;&#20250;&#26377;&#20160;&#20040;&#19981;&#21516;?</span>
 <span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">aand</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
   <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">cond</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>null args<span style="color: #97b098;">)</span> t<span style="color: #b0b1a3;">)</span>
         <span style="color: #b0b1a3;">(</span>t `<span style="color: #97b098;">(</span>aif ,<span style="color: #aebed8;">(</span>car args<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>aand ,@<span style="color: #b0b0b3;">(</span>cdr args<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#37027;&#20040;&#23439;&#23637;&#24320;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>IT <span style="color: #97b098;">(</span>OWNER X<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">IF</span> IT
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>IT <span style="color: #b0b0b3;">(</span>ADDRESS IT<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span><span style="color: #00bfff;">IF</span> IT
            <span style="color: #aebed8;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #b0b0b3;">(</span><span style="color: #90a890;">(</span>IT <span style="color: #a2b6da;">(</span>TOWN IT<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">IF</span> IT
                  T
                  NIL<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
            NIL<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      NIL<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#26368;&#21518;&#21482;&#20250;&#36820;&#22238;t &#25110;&#32773; nil</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36798;&#19981;&#21040;&#19978;&#38754;&#37027;&#31181;&#23558;&#26368;&#21518;&#19968;&#20010;&#34920;&#36798;&#24335;(town it)&#30340;&#20540;&#20316;&#20026;&#25972;&#20307;&#30340;&#20540;&#30340;&#32467;&#26524;&#36820;&#22238;&#30340;&#25928;&#26524;</span>
</pre>
</div>
</div>
</div>



<div id="outline-container-org39227d5" class="outline-3">
<h3 id="org39227d5"><span class="section-number-3">16.5</span> <code>acond</code></h3>
<div class="outline-text-3" id="text-16-5">
<p>
<code>acond</code> 宏是对cond宏的it指代扩展，在cond相应的子句中，可以引用test表达式的值。
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">acond</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> clauses<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null clauses<span style="color: #b0b1a3;">)</span>
      nil                                     <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22914;&#26524;&#27809;&#26377;clauses&#21017;&#36820;&#22238;nil</span>
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>cl1 <span style="color: #b0b0b3;">(</span>car clauses<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
            <span style="color: #aebed8;">(</span>sym <span style="color: #b0b0b3;">(</span>gensym<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>                   <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#37319;&#29992;gensym&#21644;&#19979;&#38754;&#30340;&#23376;&#21477;&#30340;&#23616;&#37096;it&#32465;&#23450;&#65292;&#23558;`test-form`&#21040;it&#30340;&#32465;&#23450;&#38480;&#23450;&#22312;&#30456;&#24212;&#30340;&#23376;&#21477;&#20013;</span>
        `<span style="color: #97b098;">(</span><span style="color: #00bfff;">let</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>,sym ,<span style="color: #90a890;">(</span>car cl1<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
           <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> ,sym
               <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #90a890;">(</span><span style="color: #a2b6da;">(</span>it ,sym<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span> ,@<span style="color: #90a890;">(</span>cdr cl1<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">it&#30340;&#32465;&#23450;&#21482;&#22312;&#27492;&#23376;&#21477;&#20013;</span>
               <span style="color: #b0b0b3;">(</span>acond ,@<span style="color: #90a890;">(</span>cdr clauses<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>   <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36882;&#24402;&#35843;&#29992;&#25509;&#19979;&#26469;&#30340;&#23376;&#21477;</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#23637;&#24320;&#31034;&#20363;:</span>
<span style="color: #8c8c8c;">(</span>acond <span style="color: #93a8c6;">(</span>nil <span style="color: #b0b1a3;">(</span>format t <span style="color: #deb887;">"result1 is ~a~%"</span> it<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
       <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>- 3 2<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>format t <span style="color: #deb887;">"result2 is ~a~%"</span> it<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
       <span style="color: #93a8c6;">(</span>t <span style="color: #b0b1a3;">(</span>format t <span style="color: #deb887;">"default clause"</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21021;&#27493;&#23637;&#24320;:</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>#<span style="color: #f08080;">:G600</span> NIL<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">IF</span> #<span style="color: #f08080;">:G600</span>
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>IT #<span style="color: #f08080;">:G600</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span>FORMAT T <span style="color: #deb887;">"result1 is ~a~%"</span> IT<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span>ACOND <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>- 3 2<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>FORMAT T <span style="color: #deb887;">"result2 is ~a~%"</span> IT<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
             <span style="color: #97b098;">(</span>T <span style="color: #aebed8;">(</span>FORMAT T <span style="color: #deb887;">"default clause"</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20877;&#27425;&#23637;&#24320;:</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>#<span style="color: #f08080;">:G601</span> NIL<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">IF</span> #<span style="color: #f08080;">:G601</span>
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>IT #<span style="color: #f08080;">:G601</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span>FORMAT T <span style="color: #deb887;">"result1 is ~a~%"</span> IT<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>#<span style="color: #f08080;">:G602</span> <span style="color: #b0b0b3;">(</span>- 3 2<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span><span style="color: #00bfff;">IF</span> #<span style="color: #f08080;">:G602</span>
            <span style="color: #aebed8;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #b0b0b3;">(</span><span style="color: #90a890;">(</span>IT #<span style="color: #f08080;">:G602</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span>FORMAT T <span style="color: #deb887;">"result2 is ~a~%"</span> IT<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
            <span style="color: #aebed8;">(</span>ACOND <span style="color: #b0b0b3;">(</span>T <span style="color: #90a890;">(</span>FORMAT T <span style="color: #deb887;">"default clause"</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>




</pre>
</div>
</div>
</div>


<div id="outline-container-org6656eca" class="outline-3">
<h3 id="org6656eca"><span class="section-number-3">16.6</span> <code>alambda</code></h3>
<div class="outline-text-3" id="text-16-6">
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36890;&#24120;&#23450;&#20041;lambda&#20989;&#25968;&#30340;&#26102;&#20505;&#22312;&#20989;&#25968;&#20307;&#37324;&#26159;&#19981;&#33021;&#24341;&#29992;&#33258;&#36523;&#21311;&#21517;&#20989;&#25968;&#30340;&#12290;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20030;&#20010;&#20363;&#23376;&#65306;&#23450;&#20041;&#19968;&#20010;&#20989;&#25968;&#65292;&#35745;&#31639;&#19968;&#20010;&#21015;&#34920;&#20013;&#21508;&#20010;&#39033;&#30446;&#20013;&#21253;&#21547;&#26576;&#19968;&#23545;&#35937;&#30340;&#25968;&#37327;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">count-instance</span> <span style="color: #93a8c6;">(</span>obj lsts<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>instances-in <span style="color: #aebed8;">(</span>lst<span style="color: #aebed8;">)</span>
             <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b0b3;">(</span>consp lst<span style="color: #b0b0b3;">)</span>
                 <span style="color: #b0b0b3;">(</span>+ <span style="color: #90a890;">(</span><span style="color: #00bfff;">if</span> <span style="color: #a2b6da;">(</span>eq <span style="color: #9cb6ad;">(</span>car lst<span style="color: #9cb6ad;">)</span> obj<span style="color: #a2b6da;">)</span> 1 0<span style="color: #90a890;">)</span>
                    <span style="color: #90a890;">(</span>instances-in <span style="color: #a2b6da;">(</span>cdr lst<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                 0<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span>mapcar #'instances-in lsts<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;</span>
&gt; <span style="color: #8c8c8c;">(</span>count-instance 'a '<span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>a b c<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>d a r p a<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>d a r<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>a a<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">()</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>1 2 1 2 0<span style="color: #8c8c8c;">)</span>

&#22312;&#19978;&#38754;&#30340;&#20363;&#23376;&#37324;&#65292;&#20026;&#20102;&#32479;&#35745;&#19968;&#20010;obj&#22312;&#19968;&#20010;lst&#20986;&#29616;&#30340;&#27425;&#25968;&#29992;labels&#23450;&#20041;&#20102;&#20020;&#26102;&#20989;&#25968;count-instance&#12290;
&#22240;&#20026;&#35201;&#22312;&#35813;&#20989;&#25968;&#20869;&#37096;&#36882;&#24402;&#20351;&#29992;&#35813;&#20989;&#25968;&#12290;

&#20026;&#27492;&#21487;&#20197;&#23450;&#20041;&#20854;&#25351;&#20195;&#29256;&#26412;alambda&#12290;

alambda&#30340;&#20351;&#29992;&#31034;&#20363;&#21487;&#20197;&#22914;&#19979;&#25152;&#31034;<span style="color: #8c8c8c;">&#65288;</span>&#19968;&#20010;&#38454;&#20056;&#20989;&#25968;<span style="color: #8c8c8c;">&#65289;</span>:
<span style="color: #8c8c8c;">(</span>alambda <span style="color: #93a8c6;">(</span>x<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>= x 0<span style="color: #b0b1a3;">)</span> 1 <span style="color: #b0b1a3;">(</span>* x <span style="color: #97b098;">(</span>self <span style="color: #aebed8;">(</span>1- x<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">alambda&#30340;&#23450;&#20041;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">alambda</span> <span style="color: #93a8c6;">(</span>params <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>self ,params ,@body<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     #'self<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

&#21487;&#20197;&#30475;&#21040;alambda&#23558;&#34920;&#36798;&#24335;&#23637;&#24320;&#25104;labels&#24418;&#24335;&#65292;&#27714;&#20540;&#36820;&#22238;&#30340;&#26159;&#20854;&#23450;&#20041;&#26159;&#23616;&#37096;&#20989;&#25968;self

<span style="color: #8c8c8c;">(</span>alambda <span style="color: #93a8c6;">(</span>x<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>= x 0<span style="color: #b0b1a3;">)</span> 1 <span style="color: #b0b1a3;">(</span>* x <span style="color: #97b098;">(</span>self <span style="color: #aebed8;">(</span>1- x<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23637;&#24320;&#25104;:</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">LABELS</span> <span style="color: #93a8c6;">(</span><span style="color: #b0b1a3;">(</span>SELF <span style="color: #97b098;">(</span>X<span style="color: #97b098;">)</span>
           <span style="color: #97b098;">(</span><span style="color: #00bfff;">IF</span> <span style="color: #aebed8;">(</span>= X 0<span style="color: #aebed8;">)</span>
               1
               <span style="color: #aebed8;">(</span>* X <span style="color: #b0b0b3;">(</span>SELF <span style="color: #90a890;">(</span>1- X<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
  #'SELF<span style="color: #8c8c8c;">)</span>


&#25152;&#20197;count-instance&#21487;&#20197;&#23450;&#20041;&#25104;:
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">count-instance</span> <span style="color: #93a8c6;">(</span>obj lsts<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>mapcar <span style="color: #b0b1a3;">(</span>alambda <span style="color: #97b098;">(</span>lst<span style="color: #97b098;">)</span>
            <span style="color: #97b098;">(</span><span style="color: #00bfff;">if</span> <span style="color: #aebed8;">(</span>consp lst<span style="color: #aebed8;">)</span>
                <span style="color: #aebed8;">(</span>+ <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">if</span> <span style="color: #90a890;">(</span>eq <span style="color: #a2b6da;">(</span>car lst<span style="color: #a2b6da;">)</span> obj<span style="color: #90a890;">)</span> 1 0<span style="color: #b0b0b3;">)</span>
                   <span style="color: #b0b0b3;">(</span>self <span style="color: #90a890;">(</span>cdr lst<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
                0<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
       lsts<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>





</pre>
</div>
</div>
</div>





<div id="outline-container-orge604fd4" class="outline-3">
<h3 id="orge604fd4"><span class="section-number-3">16.7</span> <code>ablock</code></h3>
<div class="outline-text-3" id="text-16-7">
<p>
ablock宏使得宏里的body的每一个expression都可以使用it指代上一步的结果的值。
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">ablock</span> <span style="color: #93a8c6;">(</span>tag <span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">block</span> ,tag
     ,<span style="color: #b0b1a3;">(</span>funcall <span style="color: #97b098;">(</span>alambda <span style="color: #aebed8;">(</span>args<span style="color: #aebed8;">)</span>
                 <span style="color: #aebed8;">(</span><span style="color: #00bfff;">case</span> <span style="color: #b0b0b3;">(</span>length args<span style="color: #b0b0b3;">)</span>
                   <span style="color: #b0b0b3;">(</span>0 nil<span style="color: #b0b0b3;">)</span>
                   <span style="color: #b0b0b3;">(</span>1 <span style="color: #90a890;">(</span>car args<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
                   <span style="color: #b0b0b3;">(</span>t `<span style="color: #90a890;">(</span><span style="color: #00bfff;">let</span> <span style="color: #a2b6da;">(</span><span style="color: #9cb6ad;">(</span>it ,<span style="color: #8c8c8c;">(</span>car args<span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span>
                         ,<span style="color: #a2b6da;">(</span>self <span style="color: #9cb6ad;">(</span>cdr args<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
               args<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #8c8c8c;">(</span>ablock outer
        <span style="color: #93a8c6;">(</span>ablock inner
                <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">return-from</span> inner 1<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
        <span style="color: #93a8c6;">(</span>format t <span style="color: #deb887;">"Inner return is ~a~%"</span> it<span style="color: #93a8c6;">)</span>
        <span style="color: #93a8c6;">(</span>format t <span style="color: #deb887;">"Last step return is ~a~%"</span> it<span style="color: #93a8c6;">)</span>
        <span style="color: #deb887;">"outer ends."</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23439;&#23637;&#24320;&#25104;:</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">BLOCK</span> OUTER
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>IT <span style="color: #aebed8;">(</span><span style="color: #00bfff;">BLOCK</span> INNER <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">RETURN-FROM</span> INNER 1<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>IT <span style="color: #b0b0b3;">(</span>FORMAT T <span style="color: #deb887;">"Inner return is ~a~%"</span> IT<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
      <span style="color: #97b098;">(</span><span style="color: #00bfff;">LET</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>IT <span style="color: #90a890;">(</span>FORMAT T <span style="color: #deb887;">"Last step return is ~a~%"</span> IT<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
        <span style="color: #deb887;">"outer ends."</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>


<div id="outline-container-org52b4d15" class="outline-3">
<h3 id="org52b4d15"><span class="section-number-3">16.8</span> 注意</h3>
<div class="outline-text-3" id="text-16-8">
<blockquote>
<p>
;; 引用自原书14.1章
如果一个宏有意使用了变量捕捉，那么无论何时这个宏被导出到另一个包的时候，都必须同时导出那些被捕捉了的符号。
例如，无论aif被导出到哪里，it也应该同样被导出到同样的地方。否则出现在宏定义里的it和宏调用里使用的it将会是不同的符号。
</p>
</blockquote>
</div>
</div>





<div id="outline-container-org921b10c" class="outline-3">
<h3 id="org921b10c"><span class="section-number-3">16.9</span> 多值指代版</h3>
<div class="outline-text-3" id="text-16-9">
<p>
由于nil在common lisp里可以表示空列表、假逻辑或者失败。有时候不清楚函数的返回值时失败还是返回nil，比如 <code>find-if</code> 函数。
</p>

<p>
common lisp里至少有3种方案:
</p>
<ol class="org-ol">
<li>返回一个列表结构，像assoc, member-if</li>
<li>有多值返回的功能后，通过多值来表示是否存在，像gethash</li>
<li>通过传入一个参数，当返回这个值的时候表示不存在，像get或者read</li>
</ol>


<p>
下面列出了指代宏的判断多值返回的版本，当一个test返回nil时， (来兼容) 检查其第二个值是否为nil来判断存不存在（像针对gethash这种）。
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">--- aif ---</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">aif</span> <span style="color: #93a8c6;">(</span>test-form then-form <span style="color: #98f5ff;">&amp;optional</span> else-form<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>it ,test-form<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
     <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">if</span> it ,then-form ,else-form<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22810;&#37325;&#20540;&#36820;&#22238;&#29256;&#26412;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">aif-2</span> <span style="color: #93a8c6;">(</span>test-form then-form <span style="color: #98f5ff;">&amp;optional</span> else-form<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>win <span style="color: #aebed8;">(</span>gensym<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">multiple-value-bind</span> <span style="color: #90a890;">(</span>it ,win<span style="color: #90a890;">)</span> ,test-form<span style="color: #b0b0b3;">)</span>
             <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">if</span> <span style="color: #90a890;">(</span>or it ,win<span style="color: #90a890;">)</span> ,then-form ,else-form<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">--- awhen ---</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">awhen</span> <span style="color: #93a8c6;">(</span>test-form <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span>aif ,test-form
        <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">progn</span> ,@body<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22810;&#37325;&#20540;&#36820;&#22238;&#29256;&#26412;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">awhen2</span> <span style="color: #93a8c6;">(</span>test-form <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span>aif2 ,test-form
         <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">progn</span> ,@body<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">--- awhile ---</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">awhile</span> <span style="color: #93a8c6;">(</span>test <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">do</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>it ,test ,test<span style="color: #97b098;">)</span>
        <span style="color: #97b098;">(</span>not it<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
       ,@body<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22810;&#37325;&#20540;&#36820;&#22238;&#29256;&#26412;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">awhile2</span> <span style="color: #93a8c6;">(</span>test <span style="color: #98f5ff;">&amp;body</span> body<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>flag <span style="color: #aebed8;">(</span>gensym<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>,flag t<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span><span style="color: #00bfff;">while</span> ,flag
         <span style="color: #aebed8;">(</span>aif ,test
              <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">progn</span> ,@body<span style="color: #b0b0b3;">)</span>
              <span style="color: #b0b0b3;">(</span>setq ,flag nil<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">--- acond ---</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">acond</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> clauses<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null clauses<span style="color: #b0b1a3;">)</span>
      nil
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>cl1 <span style="color: #b0b0b3;">(</span>car clauses<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
            <span style="color: #aebed8;">(</span>sym <span style="color: #b0b0b3;">(</span>gensym<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        `<span style="color: #97b098;">(</span><span style="color: #00bfff;">let</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>,sym ,<span style="color: #90a890;">(</span>car cl1<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
           <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> ,sym
               <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #90a890;">(</span><span style="color: #a2b6da;">(</span>it ,sym<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span> ,@<span style="color: #90a890;">(</span>cdr cl1<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
               <span style="color: #b0b0b3;">(</span>acond ,@<span style="color: #90a890;">(</span>cdr clauses<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22810;&#37325;&#36820;&#22238;&#20540;&#29256;&#26412;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">acond2</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> clauses<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null clauses<span style="color: #b0b1a3;">)</span>
      nil
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>cl1 <span style="color: #b0b0b3;">(</span>car clauses<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
            <span style="color: #aebed8;">(</span>val <span style="color: #b0b0b3;">(</span>gensym<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
            <span style="color: #aebed8;">(</span>win <span style="color: #b0b0b3;">(</span>gensym<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        `<span style="color: #97b098;">(</span><span style="color: #00bfff;">multiple-value-bind</span> <span style="color: #aebed8;">(</span>,val ,win<span style="color: #aebed8;">)</span> ,<span style="color: #aebed8;">(</span>car cl1<span style="color: #aebed8;">)</span>
           <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b0b3;">(</span>or ,val ,win<span style="color: #b0b0b3;">)</span>
               <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #90a890;">(</span><span style="color: #a2b6da;">(</span>it ,val<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span> ,@<span style="color: #90a890;">(</span>cdr cl1<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
               <span style="color: #b0b0b3;">(</span>acond2 ,@<span style="color: #90a890;">(</span>cdr clauses<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>



</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0a827d9" class="outline-2">
<h2 id="org0a827d9"><span class="section-number-2">17</span> 生成函数的宏</h2>
<div class="outline-text-2" id="text-17">
<p>
用宏来生成函数有时候比用函数生成函数更方便也更强大。
</p>
</div>
<div id="outline-container-orgfb6ae51" class="outline-3">
<h3 id="orgfb6ae51"><span class="section-number-3">17.1</span> 构造函数的宏fn</h3>
<div class="outline-text-3" id="text-17-1">
</div>
<div id="outline-container-orge0769bf" class="outline-4">
<h4 id="orge0769bf"><span class="section-number-4">17.1.1</span> 回顾compose</h4>
<div class="outline-text-4" id="text-17-1-1">
<p>
上面章节定义过compose,用来将函数嵌套复合，生成新的函数，定义如下
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">compose</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> fns<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> fns
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">let</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>fn1 <span style="color: #b0b0b3;">(</span>car <span style="color: #90a890;">(</span>last fns<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
            <span style="color: #aebed8;">(</span>fns <span style="color: #b0b0b3;">(</span>butlast fns<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
        #'<span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span><span style="color: #98f5ff;">&amp;rest</span> args<span style="color: #aebed8;">)</span>
            <span style="color: #aebed8;">(</span>reduce #'funcall fns
                    <span style="color: #f08080;">:from-end</span> t
                    <span style="color: #f08080;">:initial-value</span> <span style="color: #b0b0b3;">(</span>apply fn1 args<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
      #'identity<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>

<p>
使用示例
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23558;&#21442;&#25968;&#20256;&#32473;find-if&#65292;&#28982;&#21518;&#23558;&#32467;&#26524;&#20256;&#32473;1+</span>
CL-USER&gt; <span style="color: #8c8c8c;">(</span>funcall <span style="color: #93a8c6;">(</span>compose #'1+ #'find-if<span style="color: #93a8c6;">)</span> #'oddp '<span style="color: #93a8c6;">(</span>2 3 4<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
4

</pre>
</div>
</div>
</div>

<div id="outline-container-orgf0c2ae6" class="outline-4">
<h4 id="orgf0c2ae6"><span class="section-number-4">17.1.2</span> 通用的用于构造函数的宏fn</h4>
<div class="outline-text-4" id="text-17-1-2">
<p>
我们可以定义一个更通用的组合函数的方法fn，如何组合取决于参数。
</p>

<p>
fn功能说明
</p>
<pre class="example">
fn是一个函数构造器，用宏来将作为参数的函数组装起来，具体怎么组装，取决于其中的某些参数

fn的参数:
fn的参数是形如(operator arguments)的表达式:
operator 可以是一个函数或者宏的名字，也可以是被区别对待的compose函数
arguments 可以是接受一个参数的函数或者宏的名字，或者是可作为fn参数的表达式(注意，此处有嵌套定义)

fn生成的函数结果:
fn宏生成的结果是一个(接收一个参数的)函数，该函数的作用是将接受的参数作用于每个arguments函数上，最后将各个结果作为参数使用operator组装

</pre>

<p>
示例:
</p>
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22914;&#26524;&#26377;&#20123;arguments&#20989;&#25968;&#26412;&#36523;&#23601;&#26159;&#19968;&#20010;&#24418;&#22914;(operator arguments)&#30340;&#26684;&#24335;&#65292;&#37027;&#20040;&#21442;&#25968;&#20316;&#29992;&#20110;&#20854;&#19978;&#26102;&#65292;&#20063;&#25353;&#29031;&#30456;&#21516;&#30340;&#35268;&#21017;&#12290;</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#27604;&#22914;&#65306;</span>
<span style="color: #8c8c8c;">(</span>fn <span style="color: #93a8c6;">(</span>and integerp oddp<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span> =&gt; #'<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #93a8c6;">(</span>x<span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>and <span style="color: #b0b1a3;">(</span>integerp x<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>oddp x<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20877;&#27604;&#22914;&#65306;</span>
<span style="color: #8c8c8c;">(</span>fn <span style="color: #93a8c6;">(</span>list <span style="color: #b0b1a3;">(</span>1+ truncate<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span> =&gt; #'<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #93a8c6;">(</span>#<span style="color: #f08080;">:g1</span><span style="color: #93a8c6;">)</span>
                                 <span style="color: #93a8c6;">(</span>list <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>#<span style="color: #f08080;">:g2</span><span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>1+ <span style="color: #b0b0b3;">(</span>truncate #<span style="color: #f08080;">:g2</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> #<span style="color: #f08080;">:g1</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#29305;&#20363;&#65292;&#22914;&#26524;&#21442;&#25968;operator&#26159;compose, &#37027;&#20040;&#29983;&#25104;&#30340;&#20989;&#25968;&#23601;&#26159;&#22797;&#21512;&#25152;&#26377;arguments&#20989;&#25968;&#30340;&#20989;&#25968;&#12290;&#25928;&#26524;&#21644;&#30452;&#25509;&#35843;&#29992;compose&#31867;&#20284;.</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#27604;&#22914;</span>
<span style="color: #8c8c8c;">(</span>fn <span style="color: #93a8c6;">(</span>compose list 1+ truncate<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span> =&gt; #'<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #93a8c6;">(</span>#<span style="color: #f08080;">:g1</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>list <span style="color: #b0b1a3;">(</span>1+ <span style="color: #97b098;">(</span>truncate #<span style="color: #f08080;">:g1</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>



<span style="color: #7f7f7f;">;;; </span><span style="color: #7f7f7f;">&#20851;&#20110;compose&#29305;&#20363;&#30340;&#35828;&#26126;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#34429;&#28982;&#36825;&#37324;&#23558;compose&#20316;&#20026;&#19968;&#31181;&#29305;&#27530;&#24773;&#20917;&#22788;&#29702;&#65292;&#20294;&#24182;&#27809;&#26377;&#22686;&#21152;fn&#30340;&#21151;&#33021;&#65292;&#21482;&#26159;&#20026;&#20102;&#22686;&#21152;&#35843;&#29992;&#30340;&#21487;&#35835;&#24615;&#12290;&#22914;&#26524;&#25226;&#23884;&#22871;&#30340;&#21442;&#25968;&#20256;&#32473;fn&#23601;&#33021;&#24418;&#25104;&#20989;&#25968;&#30340;&#22797;&#21512;&#12290;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20854;&#23454;&#19978;&#38754;&#30340;&#20363;&#23376;&#20063;&#23601;&#30456;&#24403;&#20110;</span>
<span style="color: #8c8c8c;">(</span>fn <span style="color: #93a8c6;">(</span>list <span style="color: #b0b1a3;">(</span>1+ truncate<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span> =&gt; #'<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #93a8c6;">(</span>#<span style="color: #f08080;">:g1</span><span style="color: #93a8c6;">)</span>
                                 <span style="color: #93a8c6;">(</span>list <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>#<span style="color: #f08080;">:g2</span><span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>1+ <span style="color: #b0b0b3;">(</span>truncate #<span style="color: #f08080;">:g2</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> #<span style="color: #f08080;">:g1</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
&#31561;&#20215;&#20110;
<span style="color: #8c8c8c;">(</span>fn <span style="color: #93a8c6;">(</span>compose list 1+ truncate<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span> =&gt; #'<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #93a8c6;">(</span>#<span style="color: #f08080;">:g1</span><span style="color: #93a8c6;">)</span> <span style="color: #93a8c6;">(</span>list <span style="color: #b0b1a3;">(</span>1+ <span style="color: #97b098;">(</span>truncate #<span style="color: #f08080;">:g1</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


</pre>
</div>


<p>
具体实现:
</p>
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">fn</span> <span style="color: #93a8c6;">(</span>expr<span style="color: #93a8c6;">)</span>
  `#',<span style="color: #93a8c6;">(</span>rbuild expr<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36890;&#36807;&#35843;&#29992;rbuild&#20989;&#25968;&#26469;&#26500;&#36896;&#26469;&#29983;&#25104;&#20989;&#25968;expression</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">rbuild</span> <span style="color: #93a8c6;">(</span>expr<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>or <span style="color: #97b098;">(</span>atom expr<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>eq <span style="color: #aebed8;">(</span>car expr<span style="color: #aebed8;">)</span> 'lambda<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21028;&#26029;&#20256;&#20837;&#30340;&#34920;&#36798;&#24335;&#26159;&#20010;atom&#25110;&#32773;&#26159;&#20010;lambda&#34920;&#36798;&#24335;&#65292;&#21017;&#36820;&#22238;&#35813;&#34920;&#36798;&#24335;&#33258;&#36523;</span>
      expr
      <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">if</span> <span style="color: #97b098;">(</span>eq <span style="color: #aebed8;">(</span>car expr<span style="color: #aebed8;">)</span> 'compose<span style="color: #97b098;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#26681;&#25454;operator&#26159;&#19981;&#26159;&#29305;&#27530;&#24773;&#20917;compose&#65292;&#35843;&#29992;&#19981;&#21516;&#30340;&#20989;&#25968;&#26469;&#26500;&#36896;&#34920;&#36798;&#24335;</span>
          <span style="color: #97b098;">(</span>build-compose <span style="color: #aebed8;">(</span>cdr expr<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
          <span style="color: #97b098;">(</span>build-call <span style="color: #aebed8;">(</span>car expr<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>cdr expr<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">build-compose</span> <span style="color: #93a8c6;">(</span>fns<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>g <span style="color: #aebed8;">(</span>gensym<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #97b098;">(</span>,g<span style="color: #97b098;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22806;&#23618;&#30340;lambda&#26159;&#22240;&#20026;&#25105;&#20204;&#38656;&#35201;&#26500;&#36896;&#19968;&#20010;&#20989;&#25968;&#36820;&#22238;</span>
       ,<span style="color: #97b098;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #aebed8;">(</span><span style="color: #b0b0b3;">(</span>rec <span style="color: #90a890;">(</span>fns<span style="color: #90a890;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#23450;&#19968;&#20010;&#20020;&#26102;&#30340;&#36882;&#24402;&#20989;&#25968;rec&#65292;&#35813;&#20989;&#25968;&#25509;&#21463;&#19968;&#20123;&#20989;&#25968;&#21015;&#34920;&#65292;&#23884;&#22871;&#35843;&#29992;&#65292;&#26368;&#24038;&#36793;&#30340;&#20989;&#25968;&#21253;&#35013;&#22312;&#26368;&#22806;&#36793;&#35843;&#29992;&#65292;&#20063;&#23601;&#26159;&#26368;&#21518;&#35843;&#29992;&#65292;&#26368;&#21518;&#29983;&#25104;&#20989;&#25968;&#36882;&#24402;&#35843;&#29992;&#30340;&#34920;&#36798;&#24335;</span>
                   <span style="color: #90a890;">(</span><span style="color: #00bfff;">if</span> fns  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36882;&#24402;&#30340;&#20020;&#30028;&#20540;&#26816;&#26597;</span>
                       `<span style="color: #a2b6da;">(</span>,<span style="color: #9cb6ad;">(</span>rbuild <span style="color: #8c8c8c;">(</span>car fns<span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span>
                         ,<span style="color: #9cb6ad;">(</span>rec <span style="color: #8c8c8c;">(</span>cdr fns<span style="color: #8c8c8c;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#29983;&#25104;&#20989;&#25968;&#36882;&#24402;&#35843;&#29992;&#30340;&#34920;&#36798;&#24335;&#65292; (rbuild (car fns)) &#26159;&#38450;&#27490;operator&#21448;&#26159;&#19968;&#20010;(operator arguments)&#30340;&#24418;&#24335;</span>
                       g<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20020;&#30028;&#20540;&#65292;&#22797;&#21512;&#20989;&#25968;&#26368;&#21518;&#30340;&#21442;&#25968;&#26159;&#26368;&#22806;&#38754;&#20989;&#25968;&#30340;&#21442;&#25968;</span>
          <span style="color: #aebed8;">(</span>rec fns<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">build-call</span> <span style="color: #93a8c6;">(</span>op fns<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>g <span style="color: #aebed8;">(</span>gensym<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #97b098;">(</span>,g<span style="color: #97b098;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22806;&#23618;&#30340;lambda&#26159;&#22240;&#20026;&#25105;&#20204;&#38656;&#35201;&#26500;&#36896;&#19968;&#20010;&#20989;&#25968;&#36820;&#22238;</span>
       <span style="color: #97b098;">(</span>,op ,@<span style="color: #aebed8;">(</span>mapcar #'<span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #90a890;">(</span>f<span style="color: #90a890;">)</span>
                          `<span style="color: #90a890;">(</span>,<span style="color: #a2b6da;">(</span>rbuild f<span style="color: #a2b6da;">)</span> ,g<span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#23545;&#27599;&#20010;fn&#37117;&#23558;&#21442;&#25968;g&#20256;&#20837;&#65292;&#26368;&#21518;&#30340;&#32467;&#26524;&#26159;list,&#20351;&#29992;,@&#23637;&#24320;&#65292;&#20316;&#20026;&#21442;&#25968;&#20256;&#32473;op&#12290;&#20854;&#20013;&#65292;&#38450;&#27490;fns&#37324;&#26377;&#23884;&#22871;&#30340;(operator arguments)&#24418;&#24335;&#65292;&#36882;&#24402;&#35843;&#29992;(rbuild f)</span>
                      fns<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


</pre>
</div>


<p>
使用示例:
</p>
<pre class="example">
CL-USER&gt; (mapcar (fn (list 1+ 1-))
                 '(1 2 3 4))
((2 0) (3 1) (4 2) (5 3))


CL-USER&gt; (mapcar (fn (and integerp oddp))
                 '(1 a 2 b 3 c 4))
(T NIL NIL NIL T NIL NIL)


;; compose 相关几个示例
CL-USER&gt; (mapcar (fn (compose list 1+ truncate))
                 '(1.1 2.2 3.3 4.4))
((2) (3) (4) (5))

CL-USER&gt; (mapcar (fn (list 1+ truncate))
                 '(1.1 2.2 3.3 4.4))
((2.1 1) (3.2 2) (4.3 3) (5.4 4))

CL-USER&gt; (mapcar (fn (list (1+ truncate)))
                 '(1.1 2.2 3.3 4.4))
((2) (3) (4) (5))


</pre>
</div>
</div>
</div>

<div id="outline-container-org30a9540" class="outline-3">
<h3 id="org30a9540"><span class="section-number-3">17.2</span> 在cdr上递归</h3>
<div class="outline-text-3" id="text-17-2">
</div>
<div id="outline-container-orgda68471" class="outline-4">
<h4 id="orgda68471"><span class="section-number-4">17.2.1</span> 自己尝试定义lrec</h4>
<div class="outline-text-4" id="text-17-2-1">
<p>
首先让我看下使用函数的方式在cdr上递归
</p>
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;;; </span><span style="color: #7f7f7f;">&#20808;&#22238;&#39038; chapter 5.5 &#22312;cdr&#19978;&#36882;&#24402;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#25105;&#20204;&#26469;&#30475;&#19979;&#38754;&#20004;&#20010;&#22312;list&#19978;&#20197;cdr&#36882;&#24402;&#30340;&#20989;&#25968;:</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#31532;&#19968;&#20010;&#20989;&#25968;&#26159;&#27714;&#19968;&#20010;&#21015;&#34920;&#30340;&#38271;&#24230; (&#23454;&#38469;&#19978;&#21644;&#20869;&#32622;length&#21151;&#33021;&#30456;&#21516;)</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-length</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null lst<span style="color: #b0b1a3;">)</span>
      0                             <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#26159;&#26368;&#22522;&#30784;&#30340;&#20540;</span>
      <span style="color: #b0b1a3;">(</span>1+ <span style="color: #97b098;">(</span>our-length <span style="color: #aebed8;">(</span>cdr lst<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22312;cdr&#19978;&#36882;&#24402;&#65292;&#27599;&#27425;&#36882;&#24402;&#32467;&#26524;+1</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#31532;&#20108;&#20010;&#20989;&#25968;&#26159;&#21028;&#26029;&#19968;&#20010;&#21015;&#34920;&#37324;&#30340;&#20803;&#32032;&#26159;&#21542;&#37117;&#26159;&#22522;&#25968; (&#23454;&#38469;&#19978;&#21644;&#20869;&#32622;&#30340;every+oddp&#21151;&#33021;&#30456;&#21516;)</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-every-oddp</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null lst<span style="color: #b0b1a3;">)</span>
      t                                   <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">base case</span>
      <span style="color: #b0b1a3;">(</span>and <span style="color: #97b098;">(</span>oddp <span style="color: #aebed8;">(</span>car lst<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>               <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21462;&#20986;&#31532;&#19968;&#20010;&#20803;&#32032;&#21028;&#26029;&#26159;&#21542;&#26159;&#22522;&#25968;&#65292;</span>
           <span style="color: #97b098;">(</span>our-every-oddp <span style="color: #aebed8;">(</span>cdr lst<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#28982;&#21518;&#22312;cdr&#19978;&#36882;&#24402;&#65292;&#23558;car&#30340;&#32467;&#26524;&#21644;cdr&#30340;&#32467;&#26524;&#29992;and&#36830;&#25509;</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#29978;&#33267;&#65292;&#35753;&#25105;&#20204;&#30475;&#30475;every&#20989;&#25968;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-every</span> <span style="color: #93a8c6;">(</span>fn lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b1a3;">(</span>null lst<span style="color: #b0b1a3;">)</span>
      t                                <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">base case</span>
      <span style="color: #b0b1a3;">(</span>and <span style="color: #97b098;">(</span>funcall fn <span style="color: #aebed8;">(</span>car lst<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>      <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21462;&#20986;&#31532;&#19968;&#20010;&#20803;&#32032;&#21028;&#26029;fn&#35843;&#29992;&#32467;&#26524;</span>
           <span style="color: #97b098;">(</span>our-every fn <span style="color: #aebed8;">(</span>cdr lst<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#28982;&#21518;&#22312;cdr&#19978;&#36882;&#24402;&#65292;&#23558;car&#30340;&#32467;&#26524;&#21644;cdr&#30340;&#32467;&#26524;&#29992;and&#36830;&#25509;</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#20123;&#20989;&#25968;&#26080;&#35770;&#20174;&#20989;&#25968;&#23450;&#20041;&#30340;&#34920;&#36798;&#24335;&#24418;&#29366;&#36824;&#26159;&#20174;&#36923;&#36753;&#65288;&#20854;&#23454;&#26159;&#19968;&#22238;&#20107;&#65292;&#27605;&#31455;&#36923;&#36753;&#30001;&#20989;&#25968;&#23450;&#20041;&#26469;&#23637;&#29616;&#65289;&#26469;&#30475;&#37117;&#26377;&#20854;&#20849;&#21516;&#20043;&#22788;&#65306;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">1. &#20182;&#20204;&#37117;&#38656;&#35201;&#19968;&#20010;base case</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">2. &#20182;&#20204;&#37117;&#22312;cdr&#19978;&#20570;&#36882;&#24402;&#35843;&#29992;</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21478;&#22806;&#65292;&#21069;&#20004;&#20010;&#23558;&#20989;&#25968;&#36923;&#36753;&#23558;car&#19978;&#35843;&#29992;&#30340;&#36923;&#36753; (our-length&#26159;&#19981;&#31649;&#20160;&#20040;&#65292;&#37117;&#35748;&#23450;&#20026;&#38271;&#24230;1&#65292;our-every-oddp&#26159;&#35843;&#29992;oddp)&#20889;&#27515;&#22312;&#20989;&#25968;&#23454;&#29616;&#37324;&#65292;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#32780;&#26368;&#21518;&#19968;&#20010;&#20989;&#25968;&#23558;&#36923;&#36753;&#20197;&#21442;&#25968;&#24418;&#24335;&#20256;&#20837; (fn)&#12290;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20294;&#36825;&#19977;&#32773;car &#21644; cdr &#35843;&#29992;&#32467;&#26524;&#30340;&#36830;&#25509;&#36923;&#36753;&#37117;&#20889;&#27515;&#22312;&#20102;&#20989;&#25968;&#23454;&#29616;&#37324; (&#31532;&#19968;&#20010;&#26159;+1,&#31532;&#20108;&#20010;&#21644;&#31532;&#19977;&#20010;&#26159;and)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#32771;&#34385;&#21040;&#36825;&#20123;&#20849;&#21516;&#30340;&#27169;&#24335;&#65292;&#29616;&#22312;&#25105;&#20204;&#32771;&#34385;&#26500;&#36896;&#19968;&#20010;&#36890;&#29992;&#30340;&#20989;&#25968;&#25110;&#32773;&#23439;&#65292;&#29992;&#23427;&#26469;&#26367;&#20195;&#19978;&#38754;&#36825;&#20123;&#20849;&#21516;&#27169;&#24335;&#20989;&#25968;:</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">1. base case            &#37117;&#19981;&#19968;&#26679;&#65292;&#30001;&#22806;&#30028;&#20256;&#20837;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">2. &#22312;cdr&#19978;&#36882;&#24402;            &#26159;&#19968;&#20010;&#20849;&#21516;&#27169;&#24335;&#65292;&#20889;&#27515;&#22312;&#23454;&#29616;&#37324;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">3. car&#19978;&#30340;&#22788;&#29702;&#36923;&#36753;        &#19981;&#26159;&#20849;&#21516;&#27169;&#24335;&#65292;&#30001;&#22806;&#30028;&#20256;&#20837;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">4. &#22914;&#20309;&#36830;&#25509;car&#21644;cdr&#30340;&#32467;&#26524;  &#19981;&#26159;&#20849;&#21516;&#27169;&#24335;&#65292; &#30001;&#22806;&#30028;&#20256;&#20837;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">lrec</span> <span style="color: #93a8c6;">(</span>car-fn conc-fn base<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>self <span style="color: #aebed8;">(</span>lst<span style="color: #aebed8;">)</span>       <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#20551;&#35774;&#20135;&#29983;&#30340;&#20989;&#25968;&#21482;&#25509;&#21463;&#19968;&#20010;list&#21442;&#25968;&#65292;&#20854;&#20182;&#22788;&#29702;&#36923;&#36753;&#22312;&#29983;&#25104;&#20989;&#25968;&#30340;&#26102;&#20505;&#25351;&#23450;</span>
             <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b0b3;">(</span>null lst<span style="color: #b0b0b3;">)</span>
                 base        <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">base case</span>
                 <span style="color: #b0b0b3;">(</span>funcall conc-fn
                          <span style="color: #90a890;">(</span>funcall car-fn <span style="color: #a2b6da;">(</span>car lst<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span>
                          <span style="color: #90a890;">(</span>self <span style="color: #a2b6da;">(</span>cdr lst<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#35843;&#29992;&#36830;&#25509;&#20989;&#25968;&#65292;&#23558;car&#30340;&#32467;&#26524;&#21644;cdr&#30340;&#32467;&#26524;&#36830;&#25509;</span>
    #'self<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#20351;&#29992;labels&#23450;&#20041;&#19968;&#20010;&#20869;&#32622;&#30340;&#20989;&#25968;self,&#22312;&#23558;&#20854;&#36820;&#22238;&#30340;&#21407;&#22240;&#26159;&#65292;&#22312;cdr&#19978;&#36882;&#24402;&#35843;&#29992;&#30340;&#26102;&#20505;&#65292;&#38656;&#35201;&#20351;&#29992;&#36825;&#20010;&#29983;&#25104;&#30340;self</span>




<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#26679;&#65292;our-length&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">nil-&gt;0</span> <span style="color: #93a8c6;">(</span>n<span style="color: #93a8c6;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36741;&#21161;&#20989;&#25968;</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">if</span> n n 0<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#20010;&#20989;&#25968;&#31561;&#20215;&#20110;our-length</span>
<span style="color: #8c8c8c;">(</span>lrec <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span>x<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">declare</span> <span style="color: #97b098;">(</span>ignore x<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
      <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span>x1 x2<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>+ <span style="color: #97b098;">(</span>nil-&gt;0 x1<span style="color: #97b098;">)</span>
                    <span style="color: #97b098;">(</span>nil-&gt;0 x2<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
      0<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#32473;&#20182;&#23553;&#35013;&#20010;&#21517;&#23383;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-length2</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>lrec <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span><span style="color: #00bfff;">declare</span> <span style="color: #b0b0b3;">(</span>ignore x<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span> 1<span style="color: #97b098;">)</span>
                 <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x1 x2<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>+ <span style="color: #b0b0b3;">(</span>nil-&gt;0 x1<span style="color: #b0b0b3;">)</span>
                               <span style="color: #b0b0b3;">(</span>nil-&gt;0 x2<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
                 0<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#26679;our-every-oddp&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-every-oddp2</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>lrec <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>oddp x<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
                 <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x1 x2<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>and x1 x2<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
                 t<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#26679;&#19978;&#38754;&#30340;our-every&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#32771;&#34385;&#21040;our-every&#30340;car-fn&#26159;&#20197;&#21442;&#25968;&#24418;&#24335;&#20256;&#20837;&#30340;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-every2</span> <span style="color: #93a8c6;">(</span>fn lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>lrec fn <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#30340;fn&#23601;&#26159;car-fn</span>
                 <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x1 x2<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>and x1 x2<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
                 t<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21033;&#29992;lrec&#65292;&#25105;&#20204;&#20877;&#26469;&#23450;&#20041;&#20197;&#19979;&#20989;&#25968;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22797;&#21046;&#21015;&#34920;&#30340;copy-list</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-copy-list</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>lrec <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x<span style="color: #aebed8;">)</span> x<span style="color: #97b098;">)</span>
                 <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x1 x2<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>cons x1 x2<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
                 nil<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#31227;&#38500;&#37325;&#22797;&#20803;&#32032;&#30340;remove-duplicates</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-remove-duplicates</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>lrec <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x<span style="color: #aebed8;">)</span> x<span style="color: #97b098;">)</span>
                 <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x1 x2<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>adjoin x1 x2<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
                 nil<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21478;&#19968;&#20010;&#29256;&#26412;&#30340;find-if</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-find-if</span> <span style="color: #93a8c6;">(</span>fn lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>lrec <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>and <span style="color: #b0b0b3;">(</span>funcall fn x<span style="color: #b0b0b3;">)</span> x<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#29992;and&#26159;&#20026;&#20102;&#36820;&#22238;&#25214;&#21040;&#30340;&#36825;&#20010;&#20803;&#32032;&#65292;&#19981;&#28982;&#21487;&#20197;&#30452;&#25509;(funcall fn x)</span>
                 <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x1 x2<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> x1 x1 x2<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
                 nil<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21478;&#19968;&#20010;&#29256;&#26412;&#30340;some</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-some</span> <span style="color: #93a8c6;">(</span>fn lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>lrec <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>funcall fn x<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
                 <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x1 x2<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>or x1 x2<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
                 nil<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org8b1df7d" class="outline-4">
<h4 id="org8b1df7d"><span class="section-number-4">17.2.2</span> onlisp 版本lrec</h4>
<div class="outline-text-4" id="text-17-2-2">
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#22312;onlisp&#20070;&#19978;5.5&#31456;&#33410;&#19978;&#25552;&#21040;&#30340;lrec&#21644;&#25105;&#36825;&#36793;&#30340;&#23454;&#29616;&#26041;&#24335;&#26377;&#20123;&#19981;&#21516;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#19982;&#25105;&#19978;&#38754;&#30340;&#29256;&#26412;&#30456;&#27604;&#65292;&#36825;&#20010;&#29256;&#26412;&#23558;&#22914;&#20309;&#22788;&#29702;&#36882;&#24402;&#25918;&#21040;&#19968;&#20010;&#20989;&#25968;&#37324;&#65292;&#32780;&#19981;&#20687;&#25105;&#36923;&#36753;&#19978;&#20998;&#25104;&#22788;&#29702;car&#30340;&#21644;&#22788;&#29702;conc&#30340;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20182;&#26159;&#23558;conc-fn&#21644;car-fn&#21512;&#25104;&#19968;&#20010;&#20989;&#25968;rec&#20256;&#20837;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">rec&#25509;&#25910;&#20004;&#20010;&#21442;&#25968;&#65292;&#31532;&#19968;&#20010;&#26159;(car lst), &#31532;&#20108;&#20010;&#36882;&#24402;&#35843;&#29992;f, (funcall f)&#20250;&#36820;&#22238;&#36882;&#24402;&#35843;&#29992;&#20043;&#21518;&#39033;&#30340;&#32467;&#26524;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">lrec-onlisp-book-version</span> <span style="color: #93a8c6;">(</span>rec <span style="color: #98f5ff;">&amp;optional</span> base<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>self <span style="color: #aebed8;">(</span>lst<span style="color: #aebed8;">)</span>
             <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b0b3;">(</span>null lst<span style="color: #b0b0b3;">)</span>
                 base
                 <span style="color: #b0b0b3;">(</span>funcall rec <span style="color: #90a890;">(</span>car lst<span style="color: #90a890;">)</span>
                          #'<span style="color: #90a890;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #a2b6da;">()</span>
                              <span style="color: #a2b6da;">(</span>self <span style="color: #9cb6ad;">(</span>cdr lst<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    #'self<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#36825;&#20010;&#29256;&#26412;&#65292;our-length&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-length3</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>lrec-onlisp-book-version
            <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x f<span style="color: #aebed8;">)</span>
              <span style="color: #aebed8;">(</span><span style="color: #00bfff;">declare</span> <span style="color: #b0b0b3;">(</span>ignore x<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
              <span style="color: #aebed8;">(</span>1+ <span style="color: #b0b0b3;">(</span>funcall f<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
            0<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#36825;&#20010;&#29256;&#26412;&#65292;our-every-oddp&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-every-oddp3</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>lrec-onlisp-book-version
            <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x f<span style="color: #aebed8;">)</span>
              <span style="color: #aebed8;">(</span>and <span style="color: #b0b0b3;">(</span>oddp x<span style="color: #b0b0b3;">)</span> <span style="color: #b0b0b3;">(</span>funcall f<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
            t<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#36825;&#20010;&#29256;&#26412;&#65292;our-every&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-every3</span> <span style="color: #93a8c6;">(</span>fn lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>lrec-onlisp-book-version
            <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x f<span style="color: #aebed8;">)</span>
              <span style="color: #aebed8;">(</span>and <span style="color: #b0b0b3;">(</span>funcall fn x<span style="color: #b0b0b3;">)</span> <span style="color: #b0b0b3;">(</span>funcall f<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
            t<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


</pre>
</div>
</div>
</div>

<div id="outline-container-org3c2c823" class="outline-4">
<h4 id="org3c2c823"><span class="section-number-4">17.2.3</span> onlisp 版本lrec变形</h4>
<div class="outline-text-4" id="text-17-2-3">
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21464;&#24418;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#30475;&#21040;&#19978;&#38754;lrec-onlisp-book-version&#30340;&#26102;&#20505;&#65292;&#25105;&#24819;&#20026;&#20160;&#20040;f&#20250;&#20197;&#36825;&#31181;&#26041;&#24335;&#26469;&#29992;&#21602;&#65311;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#25105;&#20570;&#20102;&#19979;&#23581;&#35797;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">lrec-onlisp-book-version2</span> <span style="color: #93a8c6;">(</span>rec <span style="color: #98f5ff;">&amp;optional</span> base<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>self <span style="color: #aebed8;">(</span>lst<span style="color: #aebed8;">)</span>
             <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b0b3;">(</span>null lst<span style="color: #b0b0b3;">)</span>
                 base
                 <span style="color: #b0b0b3;">(</span>funcall rec <span style="color: #90a890;">(</span>car lst<span style="color: #90a890;">)</span>
                          <span style="color: #90a890;">(</span>self <span style="color: #a2b6da;">(</span>cdr lst<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    #'self<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#36825;&#20010;&#29256;&#26412;&#65292;our-length&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-length4</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>lrec-onlisp-book-version2
            <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x f<span style="color: #aebed8;">)</span>
              <span style="color: #aebed8;">(</span><span style="color: #00bfff;">declare</span> <span style="color: #b0b0b3;">(</span>ignore x<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span>
              <span style="color: #aebed8;">(</span>1+ <span style="color: #b0b0b3;">(</span>funcall f<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
            0<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#36825;&#20010;&#29256;&#26412;&#65292;our-every-oddp&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-every-oddp4</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>lrec-onlisp-book-version2
            <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x f<span style="color: #aebed8;">)</span>
              <span style="color: #aebed8;">(</span>and <span style="color: #b0b0b3;">(</span>oddp x<span style="color: #b0b0b3;">)</span> f<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
            t<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#36825;&#20010;&#29256;&#26412;&#65292;our-every&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-every4</span> <span style="color: #93a8c6;">(</span>fn lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>lrec-onlisp-book-version2
            <span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>x f<span style="color: #aebed8;">)</span>
              <span style="color: #aebed8;">(</span>and <span style="color: #b0b0b3;">(</span>funcall fn x<span style="color: #b0b0b3;">)</span> f<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
            t<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20854;&#23454;&#36825;&#37324;&#30340;f&#26356;&#20687;&#26159;&#19968;&#20010;&#20540;&#30340;&#32047;&#31215;&#12290;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#25163;&#21160;&#28436;&#31639;&#19979;lrec-onlisp-book-version&#21644;lrec-onlisp-book-version2 &#20135;&#29983;&#30340;&#20989;&#25968;&#30340;&#35745;&#31639;&#36807;&#31243;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21487;&#20197;&#24863;&#21463;&#21040;&#20004;&#32773;&#30340;&#24046;&#21035;:</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">lrec-onlisp-book-version&#29256;&#26412;&#30001;&#20110;&#36882;&#24402;&#20256;&#20837;&#30340;&#26159;&#19968;&#20010;&#20989;&#25968;&#65292;&#23454;&#38469;&#19978;&#20808;&#35745;&#31639;&#30340;&#26159;&#21015;&#34920;&#21069;&#38754;&#30340;&#20803;&#32032;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#32780;lrec-onlisp-book-version2&#29256;&#26412;&#30001;&#20110;&#36882;&#24402;&#20256;&#20837;&#30340;&#26159;&#20540;&#65292;&#25152;&#20197;&#22312;&#23637;&#24320;&#35843;&#29992;&#30340;&#36807;&#31243;&#20013;&#65292;&#19981;&#26029;&#20808;&#27714;&#20540;&#23427;&#30340;&#21442;&#25968;&#65292;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#25152;&#20197;&#23454;&#38469;&#19978;&#20808;&#35745;&#31639;&#30340;&#26159;&#21015;&#34920;&#21518;&#38754;&#30340;&#20803;&#32032;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#32780;&#20043;&#21069;&#30340;lrec&#29256;&#26412;&#31867;&#20284;&#21518;&#38754;&#36825;&#31181;&#65292;&#20808;&#27714;&#20540;&#21518;&#38754;&#30340;&#20803;&#32032;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#24635;&#20307;&#19978;&#25105;&#35273;&#24471;lrec-onlisp-book-version&#36825;&#26679;&#30340;&#26041;&#24335;&#26356;&#21152;&#21512;&#29702;&#20123;&#12290;</span>

</pre>
</div>

<p>
下面是在函数添加了打印来观察几个版本函数调用的差异
</p>
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#35843;&#29992;&#27714;&#20540;&#39034;&#24207;&#25171;&#21360;&#31034;&#24847;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">onlisp&#20070;&#19978;&#30340;&#29256;&#26412;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(defun lrec-onlisp-book-version (rec &amp;optional base)</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(labels ((self (lst)</span>
<span style="color: #7f7f7f;">;;              </span><span style="color: #7f7f7f;">(print "eval self")</span>
<span style="color: #7f7f7f;">;;              </span><span style="color: #7f7f7f;">(if (null lst)</span>
<span style="color: #7f7f7f;">;;                  </span><span style="color: #7f7f7f;">base</span>
<span style="color: #7f7f7f;">;;                  </span><span style="color: #7f7f7f;">(funcall rec (car lst)</span>
<span style="color: #7f7f7f;">;;                           </span><span style="color: #7f7f7f;">#'(lambda ()</span>
<span style="color: #7f7f7f;">;;                               </span><span style="color: #7f7f7f;">(self (cdr lst)))))))</span>
<span style="color: #7f7f7f;">;;     </span><span style="color: #7f7f7f;">#'self))</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(defun our-length3 (lst)</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(funcall (lrec-onlisp-book-version</span>
<span style="color: #7f7f7f;">;;             </span><span style="color: #7f7f7f;">(lambda (x f)</span>
<span style="color: #7f7f7f;">;;               </span><span style="color: #7f7f7f;">(declare (ignore x))</span>
<span style="color: #7f7f7f;">;;               </span><span style="color: #7f7f7f;">(print "eval rec")</span>
<span style="color: #7f7f7f;">;;               </span><span style="color: #7f7f7f;">(1+ (funcall f)))</span>
<span style="color: #7f7f7f;">;;             </span><span style="color: #7f7f7f;">0)</span>
<span style="color: #7f7f7f;">;;            </span><span style="color: #7f7f7f;">lst))</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#35843;&#29992;&#32467;&#26524;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">CL-USER&gt; (our-length3 '(1 2 3 4))</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval rec"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval rec"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval rec"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval rec"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">4</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">onlisp&#20070;&#19978;&#29256;&#26412;&#30340;&#21464;&#24418;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(defun lrec-onlisp-book-version2 (rec &amp;optional base)</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(labels ((self (lst)</span>
<span style="color: #7f7f7f;">;;              </span><span style="color: #7f7f7f;">(print "eval self")</span>
<span style="color: #7f7f7f;">;;              </span><span style="color: #7f7f7f;">(if (null lst)</span>
<span style="color: #7f7f7f;">;;                  </span><span style="color: #7f7f7f;">base</span>
<span style="color: #7f7f7f;">;;                  </span><span style="color: #7f7f7f;">(funcall rec (car lst)</span>
<span style="color: #7f7f7f;">;;                           </span><span style="color: #7f7f7f;">(self (cdr lst))))))</span>
<span style="color: #7f7f7f;">;;     </span><span style="color: #7f7f7f;">#'self))</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(defun our-length4 (lst)</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(funcall (lrec-onlisp-book-version2</span>
<span style="color: #7f7f7f;">;;             </span><span style="color: #7f7f7f;">(lambda (x f)</span>
<span style="color: #7f7f7f;">;;               </span><span style="color: #7f7f7f;">(declare (ignore x))</span>
<span style="color: #7f7f7f;">;;               </span><span style="color: #7f7f7f;">(print "eval rec")</span>
<span style="color: #7f7f7f;">;;               </span><span style="color: #7f7f7f;">(1+ f))</span>
<span style="color: #7f7f7f;">;;             </span><span style="color: #7f7f7f;">0)</span>
<span style="color: #7f7f7f;">;;            </span><span style="color: #7f7f7f;">lst))</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#35843;&#29992;&#32467;&#26524;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">CL-USER&gt; (our-length4 '(1 2 3 4))</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval rec"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval rec"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval rec"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval rec"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">4</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#33258;&#24049;&#23450;&#20041;lrec&#29256;&#26412;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(defun lrec (car-fn conc-fn base)</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(labels ((self (lst)       ;; &#36825;&#37324;&#20551;&#35774;&#20135;&#29983;&#30340;&#20989;&#25968;&#21482;&#25509;&#21463;&#19968;&#20010;list&#21442;&#25968;&#65292;&#20854;&#20182;&#22788;&#29702;&#36923;&#36753;&#22312;&#29983;&#25104;&#20989;&#25968;&#30340;&#26102;&#20505;&#25351;&#23450;</span>
<span style="color: #7f7f7f;">;;              </span><span style="color: #7f7f7f;">(print "eval self")</span>
<span style="color: #7f7f7f;">;;              </span><span style="color: #7f7f7f;">(if (null lst)</span>
<span style="color: #7f7f7f;">;;                  </span><span style="color: #7f7f7f;">base ;; base case</span>
<span style="color: #7f7f7f;">;;                  </span><span style="color: #7f7f7f;">(funcall conc-fn</span>
<span style="color: #7f7f7f;">;;                           </span><span style="color: #7f7f7f;">(funcall car-fn (car lst))</span>
<span style="color: #7f7f7f;">;;                           </span><span style="color: #7f7f7f;">(self (cdr lst))))))  ;; &#35843;&#29992;&#36830;&#25509;&#20989;&#25968;&#65292;&#23558;car&#30340;&#32467;&#26524;&#21644;cdr&#30340;&#32467;&#26524;&#36830;&#25509;</span>
<span style="color: #7f7f7f;">;;     </span><span style="color: #7f7f7f;">#'self))</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(defun our-length2 (lst)</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">(funcall (lrec (lambda (x) (declare (ignore x)) (print "eval car-fn") 1)</span>
<span style="color: #7f7f7f;">;;                  </span><span style="color: #7f7f7f;">(lambda (x1 x2) (print "eval conc-fn") (+ (nil-&gt;0 x1)</span>
<span style="color: #7f7f7f;">;;                                                       </span><span style="color: #7f7f7f;">(nil-&gt;0 x2)))</span>
<span style="color: #7f7f7f;">;;                  </span><span style="color: #7f7f7f;">0)</span>
<span style="color: #7f7f7f;">;;            </span><span style="color: #7f7f7f;">lst))</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#35843;&#29992;&#32467;&#26524;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">CL-USER&gt; (our-length2 '(1 2 3 4))</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval car-fn"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval car-fn"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval car-fn"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval car-fn"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval self"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval conc-fn"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval conc-fn"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval conc-fn"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">"eval conc-fn"</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">4</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#30001;&#27492;&#21487;&#20197;&#35266;&#23519;&#21040;&#19968;&#20123;&#24322;&#21516;</span>

</pre>
</div>
</div>
</div>


<div id="outline-container-org05697f5" class="outline-4">
<h4 id="org05697f5"><span class="section-number-4">17.2.4</span> alrec用宏的方式简化调用</h4>
<div class="outline-text-4" id="text-17-2-4">
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#25509;&#19979;&#26469;&#65292;&#35753;&#25105;&#20204;&#20197;&#23439;&#30340;&#26041;&#24335;&#26469;&#26500;&#36896;lrec&#65292;&#20174;&#32780;&#31616;&#21270;&#20351;&#29992;&#65292;&#22240;&#20026;&#30446;&#21069;&#20256;&#20837;&#30340;&#37117;&#26159;&#20989;&#25968;&#65292;&#19981;&#26159;&#24456;&#30452;&#35266;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#25353;&#29031;onlisp chapter5.5&#19978;&#30340;lrec&#23450;&#20041;&#22914;&#19979;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">lrec2</span> <span style="color: #93a8c6;">(</span>rec <span style="color: #98f5ff;">&amp;optional</span> base<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">labels</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>self <span style="color: #aebed8;">(</span>lst<span style="color: #aebed8;">)</span>
             <span style="color: #aebed8;">(</span><span style="color: #00bfff;">if</span> <span style="color: #b0b0b3;">(</span>null lst<span style="color: #b0b0b3;">)</span>
                 <span style="color: #b0b0b3;">(</span><span style="color: #00bfff;">if</span> <span style="color: #90a890;">(</span>functionp base<span style="color: #90a890;">)</span>
                     <span style="color: #90a890;">(</span>funcall base<span style="color: #90a890;">)</span>
                     base<span style="color: #b0b0b3;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20197;&#38450;&#20256;&#36827;&#26469;&#30340;base&#26159;&#19968;&#20010;&#23553;&#35013;&#30340;function</span>
                 <span style="color: #b0b0b3;">(</span>funcall rec <span style="color: #90a890;">(</span>car lst<span style="color: #90a890;">)</span>
                          #'<span style="color: #90a890;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #a2b6da;">()</span>
                              <span style="color: #a2b6da;">(</span>self <span style="color: #9cb6ad;">(</span>cdr lst<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    #'self<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">alrec</span> <span style="color: #93a8c6;">(</span>rec <span style="color: #98f5ff;">&amp;optional</span> base<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">let</span> <span style="color: #b0b1a3;">(</span><span style="color: #97b098;">(</span>gfn <span style="color: #aebed8;">(</span>gensym<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>
    `<span style="color: #b0b1a3;">(</span>lrec2
      #'<span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">(</span>it ,gfn<span style="color: #aebed8;">)</span>
          <span style="color: #aebed8;">(</span><span style="color: #00bfff;">symbol-macrolet</span> <span style="color: #b0b0b3;">(</span><span style="color: #90a890;">(</span>rec <span style="color: #a2b6da;">(</span>funcall ,gfn<span style="color: #a2b6da;">)</span><span style="color: #90a890;">)</span><span style="color: #b0b0b3;">)</span>
            ,rec<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
      ,base<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#30340;alrec&#23439;&#26041;&#20415;&#20102;lrec2&#30340;&#20351;&#29992;:</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#27604;&#22914;&#35828;&#20043;&#21069;&#36890;&#36807;lrec2&#23450;&#20041;our-every-oddp&#26102;&#38656;&#35201;&#36825;&#26679;</span>
<span style="color: #8c8c8c;">(</span>lrec2 <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #b0b1a3;">(</span>x f<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>and <span style="color: #97b098;">(</span>oddp x<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>funcall f<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
       t<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;alrec&#21487;&#20197;&#31616;&#21270;&#36825;&#19968;&#27969;&#31243;</span>
<span style="color: #8c8c8c;">(</span>alrec <span style="color: #93a8c6;">(</span>and <span style="color: #b0b1a3;">(</span>oddp it<span style="color: #b0b1a3;">)</span> rec<span style="color: #93a8c6;">)</span>
       t<span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#19978;&#38754;&#30340;&#34920;&#36798;&#24335;&#23637;&#24320;&#20026;</span>
<span style="color: #8c8c8c;">(</span>LREC2
 #'<span style="color: #93a8c6;">(</span><span style="color: #00bfff;">LAMBDA</span> <span style="color: #b0b1a3;">(</span>IT #<span style="color: #f08080;">:G582</span><span style="color: #b0b1a3;">)</span>
     <span style="color: #b0b1a3;">(</span><span style="color: #00bfff;">SYMBOL-MACROLET</span> <span style="color: #97b098;">(</span><span style="color: #aebed8;">(</span>REC <span style="color: #b0b0b3;">(</span>FUNCALL #<span style="color: #f08080;">:G582</span><span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
       <span style="color: #97b098;">(</span>AND <span style="color: #aebed8;">(</span>ODDP IT<span style="color: #aebed8;">)</span> REC<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span>
 T<span style="color: #8c8c8c;">)</span>


<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#37319;&#29992;&#20102;&#25351;&#20195;&#23439;&#26469;&#31616;&#21270;&#36825;&#19968;&#26041;&#27861;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">it &#34920;&#31034;car list</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">rec &#34920;&#31034; &#36882;&#24402;&#35843;&#29992;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#29992;&#23439;&#29983;&#25104;&#22806;&#38754;&#30340;lambda</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#36825;&#20010;&#29256;&#26412;&#65292;our-length&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-length5</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>alrec <span style="color: #97b098;">(</span>1+ rec<span style="color: #97b098;">)</span> 0<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#36825;&#20010;&#29256;&#26412;&#65292;our-every-oddp&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-every-oddp5</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>alrec <span style="color: #97b098;">(</span>and <span style="color: #aebed8;">(</span>oddp it<span style="color: #aebed8;">)</span> rec<span style="color: #97b098;">)</span> t<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#36825;&#20010;&#29256;&#26412;&#65292;our-every&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-every5</span> <span style="color: #93a8c6;">(</span>fn lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>alrec <span style="color: #97b098;">(</span>and <span style="color: #aebed8;">(</span>apply fn it<span style="color: #aebed8;">)</span> rec<span style="color: #97b098;">)</span> t<span style="color: #b0b1a3;">)</span>
           lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-orgfd7e049" class="outline-4">
<h4 id="orgfd7e049"><span class="section-number-4">17.2.5</span> on-cdrs 使用宏的方式来简化函数定义</h4>
<div class="outline-text-4" id="text-17-2-5">
<div class="org-src-container">
<pre class="src src-lisp">
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#32771;&#34385;&#21040;&#19978;&#38754;&#37117;&#26159;&#37319;&#29992;funcall &#36825;&#31181;&#24418;&#24335;</span>
<span style="color: #7f7f7f;">;;</span><span style="color: #7f7f7f;">(&#20854;&#23454;&#37319;&#29992;funcall&#36825;&#31181;&#24418;&#24335;&#26159;&#22240;&#20026;&#19979;&#38754;&#36825;&#19968;&#30340;&#23450;&#20041;&#26159;&#19981;&#34892;&#30340;)</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">(defun our-length-failed (lst)</span>
<span style="color: #7f7f7f;">;;   </span><span style="color: #7f7f7f;">((alrec (1+ rec) 0) lst))</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#21487;&#20197;&#20877;&#29992;&#23439;on-cdrs&#31616;&#21270;&#36825;&#19968;&#27169;&#24335;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defmacro</span> <span style="color: #daa520;">on-cdrs</span> <span style="color: #93a8c6;">(</span>rec base <span style="color: #98f5ff;">&amp;rest</span> lsts<span style="color: #93a8c6;">)</span>
  `<span style="color: #93a8c6;">(</span>funcall <span style="color: #b0b1a3;">(</span>alrec ,rec #'<span style="color: #97b098;">(</span><span style="color: #00bfff;">lambda</span> <span style="color: #aebed8;">()</span> ,base<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span>  <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#23558;base&#29992;function&#21253;&#35065;&#20256;&#20837;&#65292;&#22914;&#26524;base&#26159;&#20010;&#22797;&#26434;&#30340;expression&#30340;&#35805;&#65292;&#38450;&#27490;base&#34987;&#27714;&#20540;&#22810;&#27425;&#65292;&#21253;&#35065;&#21518;&#21482;&#22312;&#26368;&#21518;&#19968;&#27425;&#27714;&#20540;</span>
            ,@lsts<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#36825;&#20010;&#29256;&#26412;&#65292;our-length&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-length6</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>on-cdrs <span style="color: #b0b1a3;">(</span>1+ rec<span style="color: #b0b1a3;">)</span> 0 lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#36825;&#20010;&#29256;&#26412;&#65292;our-every-oddp&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-every-oddp6</span> <span style="color: #93a8c6;">(</span>lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>on-cdrs <span style="color: #b0b1a3;">(</span>and <span style="color: #97b098;">(</span>oddp it<span style="color: #97b098;">)</span> rec<span style="color: #b0b1a3;">)</span> t lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;&#36825;&#20010;&#29256;&#26412;&#65292;our-every&#21487;&#20197;&#20889;&#25104;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">our-every6</span> <span style="color: #93a8c6;">(</span>fn lst<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>on-cdrs <span style="color: #b0b1a3;">(</span>and <span style="color: #97b098;">(</span>funcall fn it<span style="color: #97b098;">)</span> rec<span style="color: #b0b1a3;">)</span> t lst<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#20351;&#29992;on-cdrs&#23450;&#20041;&#19968;&#20123;&#23454;&#29992;&#20989;&#25968;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#35813;&#29256;&#26412;&#30456;&#27604;union&#21487;&#20197;&#25509;&#25910;&#22810;&#20010;lists</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">unions</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> sets<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>on-cdrs <span style="color: #b0b1a3;">(</span>union it rec<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>car sets<span style="color: #b0b1a3;">)</span> <span style="color: #b0b1a3;">(</span>cdr sets<span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">intersections</span> <span style="color: #93a8c6;">(</span><span style="color: #98f5ff;">&amp;rest</span> sets<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">unless</span> <span style="color: #b0b1a3;">(</span>some #'null sets<span style="color: #b0b1a3;">)</span>
    <span style="color: #b0b1a3;">(</span>on-cdrs <span style="color: #97b098;">(</span>intersection it rec<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>car sets<span style="color: #97b098;">)</span> <span style="color: #97b098;">(</span>cdr sets<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">differences</span> <span style="color: #93a8c6;">(</span>set <span style="color: #98f5ff;">&amp;rest</span> outs<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>on-cdrs <span style="color: #b0b1a3;">(</span>set-difference rec it<span style="color: #b0b1a3;">)</span> set outs<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">maxmin &#36820;&#22238;args&#37324;&#26368;&#22823;&#20540;&#21644;&#26368;&#23567;&#20540;</span>
<span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#36793;&#28041;&#21450;&#21040;&#22810;&#21482;&#36882;&#24402;&#30340;&#26041;&#24335;&#26377;&#20123;&#36153;&#35299;&#21834;</span>
<span style="color: #8c8c8c;">(</span><span style="color: #00bfff;">defun</span> <span style="color: #daa520;">maxmin</span> <span style="color: #93a8c6;">(</span>args<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span><span style="color: #00bfff;">when</span> args
    <span style="color: #b0b1a3;">(</span>on-cdrs <span style="color: #97b098;">(</span><span style="color: #00bfff;">multiple-value-bind</span> <span style="color: #aebed8;">(</span>mx mn<span style="color: #aebed8;">)</span> rec <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#36825;&#37324;&#23558;rec&#32771;&#34385;&#25104;&#36882;&#24402;&#35843;&#29992;&#30340;&#32467;&#26524;,&#19968;&#20010;&#26368;&#22823;&#20540;&#65292;&#19968;&#20010;&#26368;&#23567;&#20540;</span>
               <span style="color: #aebed8;">(</span>values <span style="color: #b0b0b3;">(</span>max mx it<span style="color: #b0b0b3;">)</span> <span style="color: #b0b0b3;">(</span>min mn it<span style="color: #b0b0b3;">)</span><span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span> <span style="color: #7f7f7f;">;; </span><span style="color: #7f7f7f;">&#25152;&#20197;&#36825;&#37324;&#36820;&#22238;&#27604;&#36739;&#21518;&#30340;&#22823;&#30340;&#20540;&#21644;&#23567;&#30340;&#20540;</span>
             <span style="color: #97b098;">(</span>values <span style="color: #aebed8;">(</span>car args<span style="color: #aebed8;">)</span> <span style="color: #aebed8;">(</span>car args<span style="color: #aebed8;">)</span><span style="color: #97b098;">)</span>
             <span style="color: #97b098;">(</span>cdr args<span style="color: #97b098;">)</span><span style="color: #b0b1a3;">)</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org6ab9efd" class="outline-2">
<h2 id="org6ab9efd"><span class="section-number-2">18</span> END</h2>
<div class="outline-text-2" id="text-18">
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");document.write(unescape("%3Cspan style='display:none;' id='cnzz_stat_icon_1276090118'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/z_stat.php%3Fid%3D1276090118' type='text/javascript'%3E%3C/script%3E"));</script>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Nisen</p>
<p class="email">Email: <a href="mailto:imnisen@163.com">imnisen@163.com</a></p>
<p class="validation"></p>
</div>
</body>
</html>
